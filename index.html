<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interior Budget Pro - Ultimate Edition</title>
    <!-- External Libraries -->
    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        /* ========== CORE VARIABLES & THEMES ========== */
        :root {
            --primary: #eff2fe;
            --secondary: #9d4eec;
            --accent: #f2d75d;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #f22626;
            --info: #06b6d4;
            --dark: #1e293b;
            --text-light: #ffffff;
            --text-muted: rgba(230, 235, 98, 0.8);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Enhanced Theme System - Fully Modernized & Standardized (2024–2026 Trends) */
        /* Every theme now has a COMPLETE, consistent set of variables:
   - --bg-grad: Smooth, vibrant gradient with lighter end for glassmorphism depth
   - --primary: Main brand color (used for buttons, accents)
   - --btn-primary: Primary button base (often same as --primary, with slight darken option)
   - --secondary: Complementary color
   - --accent: Highlight/yellow-orange for warnings, progress, icons
   - --success: Green variant (tinted to theme harmony)
   - --warning: Amber/orange variant
   - --danger: Red variant
   - --info: Blue/cyan variant
   - --dark: Deep neutral for shadows/text
   - --card-bg: Low-opacity tint from primary for glass cards
   - --text-light: Primary text color
   - --text-muted: Secondary/subtle text
   - --border-color: Subtle borders (new variable for consistency)
   - --shadow-color: Soft shadow tint (new variable for depth)
*/

        body.theme-purple {
            --bg-grad: linear-gradient(135deg, #6366f1 0%, #a78bfa 100%);
            /* Indigo → soft violet */
            --primary: #6366f1;
            --btn-primary: #4f46e5;
            --secondary: #8b5cf6;
            --accent: #fbbf24;
            --success: #34d399;
            --warning: #fbbf24;
            --danger: #f87171;
            --info: #60a5fa;
            --dark: #1e1b4b;
            --card-bg: rgba(99, 102, 241, 0.18);
            --text-light: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.85);
            --border-color: rgba(255, 255, 255, 0.15);
            --shadow-color: rgba(99, 102, 241, 0.25);
        }

        body.theme-blue {
            --bg-grad: linear-gradient(135deg, #2563eb 0%, #93c5fd 100%);
            /* Deep blue → sky */
            --primary: #3b82f6;
            --btn-primary: #2563eb;
            --secondary: #60a5fa;
            --accent: #fde047;
            --success: #34d399;
            --warning: #fde047;
            --danger: #f87171;
            --info: #7dd3fc;
            --dark: #172554;
            --card-bg: rgba(59, 130, 246, 0.18);
            --text-light: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.85);
            --border-color: rgba(255, 255, 255, 0.15);
            --shadow-color: rgba(59, 130, 246, 0.25);
        }

        body.theme-green {
            --bg-grad: linear-gradient(135deg, #059669 0%, #86efac 100%);
            /* Emerald → mint */
            --primary: #10b981;
            --btn-primary: #059669;
            --secondary: #34d399;
            --accent: #fde047;
            --success: #6ee7b7;
            --warning: #fbbf24;
            --danger: #f87171;
            --info: #7dd3fc;
            --dark: #064e3b;
            --card-bg: rgba(16, 185, 129, 0.18);
            --text-light: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.85);
            --border-color: rgba(255, 255, 255, 0.15);
            --shadow-color: rgba(16, 185, 129, 0.25);
        }

        body.theme-orange {
            --bg-grad: linear-gradient(135deg, #ea580c 0%, #fdba74 100%);
            /* Warm orange → peach */
            --primary: #f97316;
            --btn-primary: #ea580c;
            --secondary: #fb923c;
            --accent: #fde047;
            --success: #34d399;
            --warning: #fdba74;
            --danger: #f87171;
            --info: #60a5fa;
            --dark: #7c2d12;
            --card-bg: rgba(249, 115, 22, 0.18);
            --text-light: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.85);
            --border-color: rgba(255, 255, 255, 0.15);
            --shadow-color: rgba(249, 115, 22, 0.25);
        }

        body.theme-teal {
            --bg-grad: linear-gradient(135deg, #0f766e 0%, #5eead4 100%);
            /* Deep teal → aqua */
            --primary: #14b8a6;
            --btn-primary: #0f766e;
            --secondary: #2dd4bf;
            --accent: #fde047;
            --success: #5eead4;
            --warning: #fbbf24;
            --danger: #f87171;
            --info: #7dd3fc;
            --dark: #134e4a;
            --card-bg: rgba(20, 184, 166, 0.18);
            --text-light: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.85);
            --border-color: rgba(255, 255, 255, 0.15);
            --shadow-color: rgba(20, 184, 166, 0.25);
        }

        body.theme-midnight {
            --bg-grad: linear-gradient(135deg, #020617 0%, #1e293b 100%);
            /* Ultra-deep slate */
            --primary: #eef1f5;
            --btn-primary: #475569;
            --secondary: #94a3b8;
            --accent: #e2e8f0;
            --success: #6ee7b7;
            --warning: #fde047;
            --danger: #fca5a5;
            --info: #93c5fd;
            --dark: #0f172a;
            --card-bg: rgba(71, 85, 105, 0.22);
            --text-light: #f1f5f9;
            --text-muted: rgba(241, 245, 249, 0.85);
            --border-color: rgba(241, 245, 249, 0.15);
            --shadow-color: rgba(15, 23, 42, 0.4);
        }

        body.theme-royal {
            --bg-grad: linear-gradient(135deg, #581c87 0%, #c4b5fd 100%);
            /* Deep royal purple → soft lavender */
            --primary: #7c3aed;
            --btn-primary: #6d28d9;
            --secondary: #a78bfa;
            --accent: #fde047;
            --success: #86efac;
            --warning: #fbbf24;
            --danger: #f87171;
            --info: #93c5fd;
            --dark: #4c1d95;
            --card-bg: rgba(124, 58, 237, 0.18);
            --text-light: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.85);
            --border-color: rgba(255, 255, 255, 0.15);
            --shadow-color: rgba(124, 58, 237, 0.25);
        }

        body.theme-modern-purple {
            --bg-grad: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            --btn-primary: #6c5ce7;
            --card-bg: rgba(108, 92, 231, 0.1);
            --text-light: #2d3436;
            --text-muted: rgba(45, 52, 54, 0.8);
            --dark: #2d3436;
            --primary: #f2f1f8;
            --secondary: #a9c9e6;
            --accent: #eba337;
            --success: #00b894;
            --warning: #fdcb6e;
            --danger: #e17055;
            --info: #0984e3;
        }

        /* Additional Modern Themes - Fully Standardized & Enhanced (2024–2026 Trends) */
        /* Consistent with the previous themes: full variable set, lighter gradient ends for glassmorphism depth,
   harmonious semantic colors, slightly darkened btn-primary, higher card opacity, and new border/shadow vars */

        body.theme-sunset {
            --bg-grad: linear-gradient(135deg, #ea580c 0%, #fdba74 100%);
            /* Warm sunset orange → soft peach glow */
            --primary: #f97316;
            --btn-primary: #ea580c;
            --secondary: #fb923c;
            --accent: #fde047;
            /* Bright sun-like yellow */
            --success: #86efac;
            --warning: #fdba74;
            /* Matches theme warmth */
            --danger: #f87171;
            --info: #93c5fd;
            --dark: #7c2d12;
            --card-bg: rgba(249, 115, 22, 0.18);
            --text-light: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.88);
            --border-color: rgba(255, 255, 255, 0.15);
            --shadow-color: rgba(249, 115, 22, 0.28);
        }

        body.theme-ocean {
            --bg-grad: linear-gradient(135deg, #0891b2 0%, #7dd3fc 100%);
            /* Deep ocean cyan → light sky aqua */
            --primary: #06b6d4;
            --btn-primary: #0891b2;
            --secondary: #22d3ee;
            --accent: #fde047;
            --success: #86efac;
            --warning: #fbbf24;
            --danger: #f87171;
            --info: #7dd3fc;
            /* Strong ocean-tinted info */
            --dark: #164e63;
            --card-bg: rgba(6, 182, 212, 0.18);
            --text-light: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.88);
            --border-color: rgba(255, 255, 255, 0.15);
            --shadow-color: rgba(6, 182, 212, 0.28);
        }

        body.theme-forest {
            --bg-grad: linear-gradient(135deg, #15803d 0%, #86efac 100%);
            /* Deep forest green → fresh mint */
            --primary: #16a34a;
            --btn-primary: #15803d;
            --secondary: #22c55e;
            --accent: #fde047;
            --success: #86efac;
            /* Perfect forest harmony */
            --warning: #fbbf24;
            --danger: #f87171;
            --info: #93c5fd;
            --dark: #14532d;
            --card-bg: rgba(22, 163, 74, 0.18);
            --text-light: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.88);
            --border-color: rgba(255, 255, 255, 0.15);
            --shadow-color: rgba(22, 163, 74, 0.28);
        }

        body.theme-rose {
            --bg-grad: linear-gradient(135deg, #be123c 0%, #fda4af 100%);
            /* Deep rose → soft pink blush */
            --primary: #e11d48;
            --btn-primary: #be123c;
            --secondary: #f43f5e;
            --accent: #fde047;
            --success: #86efac;
            --warning: #fbbf24;
            --danger: #fda4af;
            /* Rose-tinted danger for theme cohesion */
            --info: #93c5fd;
            --dark: #881337;
            --card-bg: rgba(225, 29, 72, 0.18);
            --text-light: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.88);
            --border-color: rgba(255, 255, 255, 0.15);
            --shadow-color: rgba(225, 29, 72, 0.28);
        }

        body.theme-cyber {
            --bg-grad: linear-gradient(135deg, #06b6d4 0%, #a5f3fc 100%);
            /* Electric cyan → bright neon glow */
            --primary: #06b6d4;
            --btn-primary: #0891b2;
            --secondary: #22d3ee;
            --accent: #a5f3fc;
            /* Neon cyan accent for cyberpunk feel */
            --success: #86efac;
            --warning: #fbbf24;
            --danger: #f87171;
            --info: #a5f3fc;
            /* Full neon info */
            --dark: #164e63;
            --card-bg: rgba(6, 182, 212, 0.20);
            /* Slightly higher opacity for neon pop */
            --text-light: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.90);
            --border-color: rgba(165, 243, 252, 0.25);
            /* Neon border glow */
            --shadow-color: rgba(6, 182, 212, 0.35);
        }

        :root {
            /* Dark Mode (Default) */
            --bg-primary: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            --bg-secondary: rgba(255, 255, 255, 0.05);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.8);
            --text-light: rgba(255, 255, 255, 0.6);
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --accent: #f093fb;
            --primary-rgb: 102, 126, 234;
            --secondary-rgb: 118, 75, 162;
            --btn-primary: linear-gradient(135deg, #667eea, #764ba2);
            --btn-success: linear-gradient(135deg, #10b981, #059669);
            --btn-warning: linear-gradient(135deg, #f59e0b, #d97706);
            --btn-danger: linear-gradient(135deg, #ef4444, #dc2626);
            --btn-info: linear-gradient(135deg, #3b82f6, #2563eb);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
        }

        /* Light Mode */
        body.light-mode {
            --bg-primary: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 50%, #bcccdc 100%);
            --bg-secondary: rgba(0, 0, 0, 0.03);
            --text-primary: #1a202c;
            --text-secondary: rgba(0, 0, 0, 0.8);
            --text-light: rgba(0, 0, 0, 0.6);
            --primary: #5a67d8;
            --secondary: #6b46c1;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --info: #2563eb;
            --accent: #d946ef;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(0, 0, 0, 0.1);
        }

        /* Smooth theme transition */
        body {
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* ========== GLOBAL STYLES ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg-grad);
            background-attachment: fixed;
            min-height: 100vh;
            min-height: 100dvh;
            color: var(--text-light);
            padding: 20px;
            transition: var(--transition);
            overflow-x: hidden;
        }

        /* Smooth Page Load Animation */
        @keyframes pageLoad {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            animation: pageLoad 0.8s ease-out;
        }

        /* ========== GLASSMORPHISM CONTAINERS ========== */
        .glass {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(16px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.18);
            border-radius: 20px;
            padding: 28px;
            transition: var(--transition);
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
        }

        .glass-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                    transparent,
                    rgba(255, 255, 255, 0.1),
                    transparent);
            transition: left 0.7s ease;
        }

        .glass-card:hover::before {
            left: 100%;
        }

        .glass-card:hover {
            transform: translateY(-5px) scale(1.01);
            box-shadow:
                0 12px 40px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.15);
        }

        /* ========== HEADER & NAVIGATION ========== */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 32px;
            margin-bottom: 32px;
            flex-wrap: wrap;
            gap: 20px;
            animation: slideDown 0.6s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .logo {
            font-size: 32px;
            font-weight: 900;
            display: flex;
            align-items: center;
            gap: 12px;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .logo i {
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-5px);
            }
        }

        .header-actions {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .nav-tabs {
            display: flex;
            gap: 8px;
            padding: 12px;
            margin-bottom: 32px;
            overflow-x: auto;
            background: rgba(0, 0, 0, 0.25);
            border-radius: 18px;
            animation: fadeIn 0.8s ease-out 0.2s both;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .nav-tab {
            padding: 14px 24px;
            border-radius: 14px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid transparent;
            opacity: 0.9;
            position: relative;
            overflow: hidden;
        }

        .nav-tab::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 3px;
            background: var(--btn-primary);
            transition: all 0.3s ease;
            transform: translateX(-50%);
            border-radius: 3px 3px 0 0;
        }

        .nav-tab:hover {
            background: rgba(255, 255, 255, 0.12);
            opacity: 1;
            transform: translateY(-2px);
        }

        .nav-tab.active {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
            opacity: 1;
            font-weight: 700;
            box-shadow:
                0 4px 20px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .nav-tab.active::after {
            width: 80%;
        }

        /* ========== BUTTONS & INTERACTIONS ========== */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: var(--transition);
            color: white;
            box-shadow:
                0 4px 12px rgba(0, 0, 0, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        .btn-duplicate {
            background: linear-gradient(135deg, var(--info), #0891b2);
            color: white;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                    transparent,
                    rgba(255, 255, 255, 0.2),
                    transparent);
            transition: left 0.6s ease;
            z-index: -1;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow:
                0 8px 24px rgba(0, 0, 0, 0.35),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            filter: brightness(1.15);
        }

        .btn:active {
            transform: translateY(-1px) scale(0.98);
        }

        .btn-icon {
            padding: 10px;
            border-radius: 10px;
            font-size: 15px;
            min-width: 42px;
            min-height: 42px;
            justify-content: center;
        }

        /* Quick fix for contractor card button sizes */
        /* Contractor card button alignment fix */
        #contractorGrid .btn-icon {
            width: 34px !important;
            height: 34px !important;
            min-width: 34px !important;
            min-height: 34px !important;
            padding: 0 !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            margin: 0 !important;
        }

        /* Contractor info icon alignment */
        #contractorGrid .glass-card .fa-briefcase,
        #contractorGrid .glass-card .fa-phone,
        #contractorGrid .glass-card .fa-envelope {
            font-size: 12px !important;
            width: 16px;
            display: inline-block;
            text-align: center;
            margin: 0 !important;
            padding: 0 !important;
        }

        #contractorGrid .glass-card .info-row {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            margin: 2px 0;
        }

        #contractorGrid .glass-card .info-row i {
            flex-shrink: 0;
        }

        #contractorGrid .btn-icon i {
            font-size: 13px !important;
            line-height: 1 !important;
            margin: 0 !important;
            padding: 0 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        #contractorGrid .btn-edit,
        #contractorGrid .btn-delete,
        #contractorGrid .btn-info {
            flex-shrink: 0 !important;
        }

        .btn-edit {
            background: linear-gradient(135deg, var(--warning), #d97706);
            color: white;
        }

        .btn-delete {
            background: linear-gradient(135deg, var(--danger), #dc2626);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--btn-primary), color-mix(in srgb, var(--btn-primary) 80%, black));
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #059669);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #dc2626);
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info), #0891b2);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #d97706);
            color: white;
        }

        .btn-pdf {
            background: linear-gradient(135deg, #eebe20, #f3ca12);
        }

        /* Premium Click Animation */
        .premium-click {
            animation: premiumClick 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes premiumClick {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(0.92);
                box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            }

            100% {
                transform: scale(1);
            }
        }

        /* Icon Animation */
        .icon-pulse {
            animation: iconPulse 2s infinite;
        }

        @keyframes iconPulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        /* ========== FORMS & INPUTS ========== */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            margin-bottom: 8px;
            font-weight: 700;
            opacity: 0.9;
            color: var(--text-light);
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.15);
            color: var(--text-light);
            font-family: inherit;
            font-size: 15px;
            transition: var(--transition);
        }

        input::placeholder,
        textarea::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--btn-primary);
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 0 0 3px rgba(var(--btn-primary-rgb), 0.2);
        }

        option {
            background: #2d3748;
            color: white;
        }

        /* ========== DASHBOARD STATS ========== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            text-align: center;
            padding: 28px;
            position: relative;
        }

        .stat-card i {
            font-size: 28px;
            margin-bottom: 12px;
            display: block;
            opacity: 0.9;
            animation: float 3s ease-in-out infinite;
            animation-delay: calc(var(--i) * 0.2s);
            transition: all 0.3s ease;
        }

        /* Make contractor grid icons smaller and more compact */
        #contractorGrid .glass-card i {
            font-size: 22px !important;
            margin-bottom: 8px !important;
            width: 40px;
            height: 40px;
            display: flex !important;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            margin-left: 0 !important;
            animation: subtle-pulse 4s ease-in-out infinite;
        }

        /* Contractor-specific icon styling */
        #contractorGrid .glass-card .fa-hard-hat,
        #contractorGrid .glass-card .fa-briefcase,
        #contractorGrid .glass-card .fa-user-tie {
            font-size: 18px !important;
            padding: 8px;
            background: rgba(var(--btn-primary-rgb, 102, 126, 234), 0.15);
            border: 1px solid rgba(var(--btn-primary-rgb, 102, 126, 234), 0.2);
        }

        #contractorGrid .glass-card .fa-money-bill-wave {
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        #contractorGrid .glass-card .fa-clipboard-list {
            background: rgba(6, 182, 212, 0.15);
            border: 1px solid rgba(6, 182, 212, 0.2);
        }

        #contractorGrid .glass-card .fa-phone,
        #contractorGrid .glass-card .fa-envelope {
            font-size: 14px !important;
            width: 28px;
            height: 28px;
            margin: 0 4px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Add subtle pulse animation */
        @keyframes subtle-pulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 0.9;
            }

            50% {
                transform: scale(1.05);
                opacity: 1;
            }
        }

        /* Hover effect for contractor cards */
        #contractorGrid .glass-card:hover i {
            transform: scale(1.08);
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .stat-value {
            font-size: 40px;
            font-weight: 900;
            margin: 16px 0;
            color: var(--text-light);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .stat-label {
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            opacity: 0.8;
            color: var (--text-muted);
            font-weight: 600;
        }

        .budget-bar-container {
            background: rgba(0, 0, 0, 0.3);
            height: 28px;
            border-radius: 14px;
            overflow: hidden;
            position: relative;
            margin-top: 12px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .budget-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--info));
            width: 0%;
            transition: width 1.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow: hidden;
        }

        .budget-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg,
                    transparent,
                    rgba(255, 255, 255, 0.6) 30%,
                    rgba(255, 255, 255, 0.9) 50%,
                    rgba(255, 255, 255, 0.6) 70%,
                    transparent);
            animation: shimmer 2s infinite;
            z-index: 2;
            /* Ensures it stays above the fill gradient */
            pointer-events: none;
            /* Lets clicks pass through to the bar */
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        .budget-bar-text {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 800;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.6);
            color: #ffffff;
            /* pure white for maximum contrast */
            letter-spacing: 0.5px;
        }

        /* ========== TABLES ========== */
        .table-wrap {
            overflow-x: auto;
            border-radius: 16px;
            background: rgba(0, 0, 0, 0.25);
            box-shadow:
                inset 0 2px 4px rgba(0, 0, 0, 0.1),
                0 4px 20px rgba(0, 0, 0, 0.15);
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        th,
        td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 15px;
            color: var(--text-light);
            transition: var(--transition);
        }

        th {
            background: rgba(0, 0, 0, 0.35);
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 1.5px;
            cursor: pointer;
            color: var(--text-muted);
            font-weight: 700;
            position: relative;
            user-select: none;
        }

        th:hover {
            background: rgba(0, 0, 0, 0.45);
        }

        tr {
            transition: var(--transition);
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(4px);
        }

        /* Sorting Indicators */
        th[data-sortable="true"] {
            padding-right: 30px;
        }

        th[data-sortable="true"]::after {
            content: '↕';
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 11px;
            opacity: 0.5;
            transition: var(--transition);
        }

        th.asc::after {
            content: '↑';
            opacity: 1;
            color: var(--success);
        }

        th.desc::after {
            content: '↓';
            opacity: 1;
            color: var(--warning);
        }

        /* ========== PAYMENTS & CONTRACTORS ========== */
        .payment-summary-card {
            background: rgba(255, 255, 255, 0.12);
            padding: 20px;
            border-radius: 14px;
            border-left: 5px solid var(--info);
            margin-bottom: 16px;
            transition: var(--transition);
        }

        .payment-summary-card:hover {
            transform: translateX(5px);
            border-left-width: 8px;
        }

        .prog-track {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            margin-bottom: 8px;
            opacity: 0.9;
            color: var(--text-light);
            font-weight: 600;
        }

        .badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            color: #000;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: var(--transition);
        }

        /* Fix for Components table status column */
        #componentsTable th:nth-child(8),
        #componentsTable td:nth-child(8) {
            min-width: 130px !important;
            max-width: 150px !important;
        }

        #componentsTable .badge {
            padding: 6px 12px !important;
            min-width: 100px !important;
            box-sizing: border-box;
            display: inline-block;
            text-align: center;
        }

        .badge:hover {
            transform: scale(1.05);
        }

        .badge-pending {
            background: linear-gradient(135deg, var(--warning), #d97706);
        }

        .badge-completed {
            background: linear-gradient(135deg, var(--success), #059669);
        }

        .badge-inprogress {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: #ffffff;
        }

        .badge-faulty {
            background: linear-gradient(135deg, var(--danger), #dc2626);
            color: #fff;
        }

        /* ========== CALENDAR ========== */
        .calendar-layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
        }

        .cal-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .cal-day {
            aspect-ratio: 1;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.15);
            display: flex;
            flex-direction: column;
            padding: 10px;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .cal-day:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.08) rotate(2deg);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .cal-day.today {
            border-color: var(--accent);
            background: rgba(230, 141, 8, 0.15);
            box-shadow: 0 0 20px rgba(225, 160, 20, 0.3);
        }

        .cal-day.selected {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.25);
            box-shadow:
                0 0 25px rgba(16, 185, 129, 0.4),
                inset 0 0 20px rgba(16, 185, 129, 0.1);
            transform: scale(1.05);
        }

        .cal-dots {
            display: flex;
            gap: 5px;
            margin-top: auto;
            justify-content: center;
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            transition: var(--transition);
        }

        .dot:hover {
            transform: scale(1.3);
        }

        .dot-note {
            background: var(--warning);
        }

        .dot-pay {
            background: var(--success);
        }

        .dot-comp {
            background: var(--info);
        }

        /* ========== MODAL ========== */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .modal.active {
            display: flex;
            animation: modalFadeIn 0.4s ease;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                backdrop-filter: blur(0);
            }

            to {
                opacity: 1;
                backdrop-filter: blur(10px);
            }
        }

        .modal-box {
            background: rgba(30, 41, 59, 0.95);
            width: 100%;
            max-width: 700px;
            padding: 36px;
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow:
                0 25px 60px rgba(0, 0, 0, 0.6),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            animation: modalSlideUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* Backup Manager Modal Specific Styles */
        #backupManagerModal .modal-box {
            max-width: 1000px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }

        #backupManagerContent {
            max-height: 60vh;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 8px;
            margin-top: 12px;
        }

        /* Custom Scrollbar for Backup Manager */
        #backupManagerContent::-webkit-scrollbar {
            width: 10px;
        }

        #backupManagerContent::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        #backupManagerContent::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--primary), var(--secondary));
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        #backupManagerContent::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, var(--secondary), var(--primary));
        }

        /* Firefox Scrollbar */
        #backupManagerContent {
            scrollbar-width: thin;
            scrollbar-color: var(--primary) rgba(255, 255, 255, 0.05);
        }

        /* Backup Manager Table Styling */
        #backupManagerContent .table-wrap {
            border-radius: 12px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        #backupManagerContent table {
            width: 100%;
            border-collapse: collapse;
        }

        #backupManagerContent table thead {
            background: linear-gradient(135deg, rgba(var(--primary-rgb), 0.3), rgba(var(--secondary-rgb), 0.3));
            position: sticky;
            top: 0;
            z-index: 10;
        }

        #backupManagerContent table thead th {
            padding: 16px 12px;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 1px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        #backupManagerContent table tbody tr {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        #backupManagerContent table tbody tr:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: scale(1.01);
        }

        #backupManagerContent table tbody td {
            padding: 14px 12px;
            font-size: 13px;
        }

        #backupManagerContent .btn-icon {
            padding: 8px 10px;
            margin: 0 4px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        #backupManagerContent .btn-icon:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        /* Scrollable Table Container Styles */
        .scrollable-table-container {
            max-height: 600px;
            overflow-y: auto;
            overflow-x: auto;
            position: relative;
        }

        .scrollable-table-container table {
            width: 100%;
        }

        .scrollable-table-container thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background: linear-gradient(135deg, rgba(var(--primary-rgb), 0.4), rgba(var(--secondary-rgb), 0.4));
        }

        .scrollable-table-container thead th {
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
        }

        /* Custom Scrollbar for Tables */
        .scrollable-table-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .scrollable-table-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .scrollable-table-container::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--primary), var(--secondary));
            border-radius: 10px;
        }

        .scrollable-table-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, var(--secondary), var(--primary));
        }

        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(50px) scale(0.9);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* ========== CHARTS & ANALYTICS ========== */
        .chart-container {
            position: relative;
            height: 380px;
            margin-top: 24px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 24px;
            margin-top: 24px;
        }

        .analytics-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 18px;
            padding: 24px;
            transition: var(--transition);
        }

        .analytics-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.15);
        }

        /* ========== TIMELINE ========== */
        .timeline-event {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-bottom: 18px;
            padding: 18px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .timeline-event::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 6px;
            background: var(--timeline-color);
            border-radius: 3px;
        }

        .timeline-event:hover {
            transform: translateX(10px);
            background: rgba(255, 255, 255, 0.15);
        }

        .timeline-icon {
            font-size: 24px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        /* ========== NOTIFICATIONS ========== */
        .notification {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 16px;
            padding: 18px 24px;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 16px;
            z-index: 10000;
            transform: translateX(400px) scale(0.9);
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow:
                0 12px 40px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            max-width: 380px;
            min-width: 320px;
        }

        .notification.show {
            transform: translateX(0) scale(1);
            opacity: 1;
        }

        .notification-success {
            border-left: 6px solid var(--success);
            background: rgba(16, 185, 129, 0.15);
        }

        .notification-error {
            border-left: 6px solid var(--danger);
            background: rgba(239, 68, 68, 0.15);
        }

        .notification-info {
            border-left: 6px solid var(--info);
            background: rgba(6, 182, 212, 0.15);
        }

        .notification i:first-child {
            font-size: 24px;
            flex-shrink: 0;
        }

        .notification span {
            flex: 1;
            font-size: 15px;
            font-weight: 600;
        }

        .notification-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 6px;
            border-radius: 8px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
        }

        .notification-close:hover {
            background: rgba(255, 255, 255, 0.15);
            color: var(--text-light);
            transform: rotate(90deg);
        }

        /* ========== LOADING STATES ========== */
        .btn-loading {
            position: relative;
            color: transparent !important;
        }

        .btn-loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            transform: translate(-50%, -50%);
        }

        @keyframes spin {
            to {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }

        /* ========== RESPONSIVE DESIGN ========== */
        @media (max-width: 1200px) {
            .calendar-layout {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 900px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }

            .nav-tabs {
                flex-wrap: wrap;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 12px;
            }

            .container {
                padding: 0;
            }

            .header {
                padding: 16px 20px;
                margin-bottom: 16px;
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                gap: 12px;
            }

            .logo {
                font-size: 20px;
                gap: 8px;
            }

            .header-actions {
                gap: 8px;
                flex-wrap: wrap;
                width: 100%;
                order: 3;
                margin-top: 12px;
            }

            .header-actions button {
                padding: 10px 16px !important;
                font-size: 12px !important;
                flex: 1;
                min-width: 120px;
            }

            .nav-tabs {
                overflow-x: auto;
                gap: 4px;
                padding: 8px;
                margin-bottom: 16px;
                -webkit-overflow-scrolling: touch;
                scroll-behavior: smooth;
            }

            .nav-tab {
                padding: 10px 16px;
                font-size: 12px;
                gap: 6px;
                min-width: max-content;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 16px;
                margin-bottom: 16px;
            }

            .stat-card {
                padding: 16px;
            }

            .stat-value {
                font-size: 28px;
                margin: 10px 0;
            }

            .stat-label {
                font-size: 12px;
                letter-spacing: 0.8px;
            }

            .glass-card {
                padding: 16px;
                margin-bottom: 12px;
                border-radius: 16px;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            input,
            select,
            textarea {
                padding: 12px;
                font-size: 16px;
            }

            .btn {
                padding: 10px 14px;
                font-size: 12px;
                gap: 6px;
            }

            .btn-icon {
                padding: 8px;
                min-width: 36px;
                min-height: 36px;
                font-size: 12px;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .chart-container {
                height: 300px;
            }

            .table-wrap {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            table {
                min-width: 600px;
                font-size: 13px;
            }

            th,
            td {
                padding: 12px;
                font-size: 13px;
            }

            .calendar-layout {
                grid-template-columns: 1fr;
            }

            .cal-grid {
                grid-template-columns: repeat(7, 1fr);
                gap: 6px;
            }

            .cal-day {
                padding: 6px;
                font-size: 12px;
            }

            .modal-box {
                width: 95%;
                max-width: 90vw;
                padding: 20px;
                max-height: 90vh;
                overflow-y: auto;
                border-radius: 16px;
            }

            .notification {
                left: 12px;
                right: 12px;
                bottom: 16px;
                max-width: none;
                min-width: auto;
                font-size: 13px;
                padding: 14px 16px;
            }

            .notification i:first-child {
                font-size: 18px;
            }

            h2 {
                font-size: 20px !important;
            }

            h3 {
                font-size: 16px !important;
            }

            .badge {
                padding: 4px 10px;
                font-size: 10px;
            }

            .timeline-event {
                gap: 12px;
                padding: 12px;
                margin-bottom: 12px;
            }

            .timeline-icon {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }

            .payment-summary-card {
                padding: 14px;
                font-size: 13px;
            }

            .view-section {
                animation: pageLoad 0.5s ease-out;
            }
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            .container {
                max-width: 100%;
                padding: 0;
            }

            .header {
                padding: 12px 16px;
                margin-bottom: 12px;
                gap: 8px;
            }

            .logo {
                font-size: 18px;
                font-weight: 700;
            }

            .logo i {
                font-size: 22px;
            }

            .header-actions {
                width: 100%;
                gap: 6px;
            }

            .header-actions button {
                padding: 8px 12px !important;
                font-size: 11px !important;
                flex: 1;
                min-width: 90px;
            }

            .header-actions button i {
                font-size: 14px;
            }

            .nav-tabs {
                gap: 3px;
                padding: 6px;
                margin-bottom: 12px;
                -webkit-overflow-scrolling: touch;
            }

            .nav-tab {
                padding: 8px 12px;
                font-size: 11px;
                gap: 4px;
                border-radius: 10px;
                min-width: max-content;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .stat-card {
                padding: 12px;
            }

            .stat-value {
                font-size: 24px;
                margin: 8px 0;
            }

            .stat-label {
                font-size: 11px;
                letter-spacing: 0.5px;
            }

            .glass-card {
                padding: 12px;
                margin-bottom: 10px;
                border-radius: 14px;
            }

            input,
            select,
            textarea {
                padding: 10px;
                font-size: 16px;
                border-radius: 10px;
            }

            label {
                font-size: 12px;
                margin-bottom: 6px;
                letter-spacing: 0.5px;
            }

            .btn {
                padding: 8px 12px;
                font-size: 11px;
                gap: 5px;
                border-radius: 10px;
            }

            .btn-icon {
                padding: 6px;
                min-width: 32px;
                min-height: 32px;
                font-size: 11px;
            }

            .btn-icon i {
                font-size: 14px;
            }

            .charts-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .chart-container {
                height: 250px;
                margin-top: 12px;
            }

            .analytics-card {
                padding: 16px;
                border-radius: 14px;
            }

            table {
                min-width: 100%;
                font-size: 12px;
                display: block;
                border-collapse: collapse;
            }

            table thead {
                display: none;
            }

            table tbody {
                display: block;
            }

            table tr {
                display: block;
                border-bottom: 2px solid rgba(255, 255, 255, 0.1);
                margin-bottom: 12px;
                border-radius: 10px;
                overflow: hidden;
                background: rgba(255, 255, 255, 0.08);
            }

            table td {
                display: block;
                text-align: right;
                padding: 8px 12px;
                border: none;
                font-size: 12px;
                position: relative;
                padding-left: 50%;
            }

            table td:before {
                content: attr(data-label);
                position: absolute;
                left: 0;
                width: 50%;
                padding: 8px 12px;
                font-weight: 600;
                text-align: left;
                font-size: 11px;
                text-transform: uppercase;
                opacity: 0.7;
            }

            th,
            td {
                padding: 10px;
                font-size: 12px;
            }

            .table-wrap {
                background: transparent;
                border-radius: 14px;
                box-shadow: none;
            }

            .calendar-layout {
                grid-template-columns: 1fr;
            }

            .cal-grid {
                grid-template-columns: repeat(7, 1fr);
                gap: 4px;
                margin-top: 12px;
            }

            .cal-day {
                padding: 4px;
                font-size: 11px;
                aspect-ratio: 1;
                border-radius: 10px;
            }

            .cal-dots {
                gap: 3px;
                margin-top: auto;
            }

            .dot {
                width: 6px;
                height: 6px;
            }

            .modal {
                padding: 12px;
                align-items: flex-end;
            }

            .modal-box {
                width: 95vw;
                max-width: 100%;
                padding: 16px;
                max-height: 85vh;
                overflow-y: auto;
                border-radius: 16px 16px 0 0;
                border-bottom: none;
                animation: modalSlideUp 0.4s ease;
            }

            .notification {
                left: 10px;
                right: 10px;
                bottom: 12px;
                padding: 10px 12px;
                max-width: none;
                font-size: 12px;
                min-width: auto;
                border-radius: 12px;
            }

            .notification-close {
                width: 24px;
                height: 24px;
                font-size: 14px;
            }

            h1 {
                font-size: 18px !important;
            }

            h2 {
                font-size: 16px !important;
            }

            h3 {
                font-size: 14px !important;
            }

            .badge {
                padding: 3px 8px;
                font-size: 9px;
            }

            .timeline-event {
                gap: 10px;
                padding: 10px;
                margin-bottom: 10px;
            }

            .timeline-event::before {
                width: 4px;
            }

            .timeline-icon {
                width: 36px;
                height: 36px;
                font-size: 14px;
            }

            .payment-summary-card {
                padding: 10px;
                font-size: 12px;
            }

            .prog-track {
                font-size: 11px;
                margin-bottom: 6px;
            }

            .budget-bar-container {
                height: 22px;
                margin-top: 8px;
            }

            .budget-bar-text {
                font-size: 10px;
            }

            .view-section {
                animation: pageLoad 0.4s ease-out;
            }

            .user-info {
                font-size: 12px;
                padding: 8px 12px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 8px;
            }

            .container {
                padding: 0;
            }

            .header {
                padding: 10px 12px;
                margin-bottom: 10px;
            }

            .logo {
                font-size: 16px;
            }

            .header-actions {
                gap: 4px;
            }

            .header-actions button {
                padding: 6px 10px !important;
                font-size: 10px !important;
                min-width: 75px;
            }

            .nav-tabs {
                padding: 4px;
                gap: 2px;
                margin-bottom: 10px;
            }

            .nav-tab {
                padding: 6px 10px;
                font-size: 10px;
            }

            .nav-tab::after {
                right: 8px;
                font-size: 9px;
            }

            .stats-grid {
                gap: 10px;
            }

            .stat-value {
                font-size: 20px;
            }

            .glass-card {
                padding: 10px;
            }

            input,
            select,
            textarea {
                padding: 8px;
                font-size: 16px;
            }

            .btn {
                padding: 6px 10px;
                font-size: 10px;
            }

            .btn-icon {
                min-width: 30px;
                min-height: 30px;
            }

            .view-section h2 {
                font-size: 14px;
            }

            table {
                font-size: 11px;
            }

            table td {
                padding: 6px 8px;
                font-size: 11px;
            }

            table td:before {
                font-size: 10px;
            }

            .modal-box {
                padding: 12px;
            }
        }

        /* iOS Safari Specific Fixes */
        @supports (-webkit-touch-callout: none) {

            input[type="text"],
            input[type="email"],
            input[type="password"],
            input[type="number"],
            textarea,
            select {
                font-size: 16px !important;
                padding: 12px;
            }

            .btn {
                -webkit-appearance: none;
                -webkit-border-radius: 12px;
                -webkit-user-select: none;
            }

            body {
                -webkit-user-select: none;
                -webkit-touch-callout: none;
                -webkit-text-size-adjust: 100%;
            }

            .nav-tabs,
            .table-wrap {
                -webkit-overflow-scrolling: touch;
            }

            input:focus,
            select:focus,
            textarea:focus {
                font-size: 16px !important;
            }
        }

        /* Touch optimization */
        @media (hover: none) and (pointer: coarse) {
            .btn:hover::before {
                left: 0;
            }

            .glass-card:hover::before {
                left: 0;
            }

            .btn-icon {
                min-width: 44px;
                min-height: 44px;
            }

            a,
            button {
                min-height: 44px;
                min-width: 44px;
                padding: 10px;
            }

            .nav-tab {
                padding: 12px 16px;
            }

            th,
            td {
                padding: 14px;
                font-size: 14px;
            }
        }

        /* ========== SCROLLBAR STYLING ========== */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            transition: var(--transition);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        /* ========== PRINT STYLES FOR PDF ========== */
        @media print {
            body {
                background: white !important;
                color: black !important;
                padding: 0;
            }

            .container {
                max-width: 100%;
                margin: 0;
                box-shadow: none;
            }

            .glass,
            .glass-card {
                background: white !important;
                border: 1px solid #ddd !important;
                box-shadow: none !important;
                backdrop-filter: none !important;
                color: black !important;
            }

            .btn,
            .nav-tabs,
            .modal {
                display: none !important;
            }

            .table-wrap {
                background: white !important;
                border: 1px solid #ddd;
            }

            th,
            td {
                color: black !important;
                border-color: #ddd !important;
            }
        }

        /* ========== ANIMATION DELAYS ========== */
        .delay-1 {
            animation-delay: 0.1s;
        }

        .delay-2 {
            animation-delay: 0.2s;
        }

        .delay-3 {
            animation-delay: 0.3s;
        }

        .delay-4 {
            animation-delay: 0.4s;
        }

        .delay-5 {
            animation-delay: 0.5s;
        }

        /* ========== CLOUD BACKUP STYLES ========== */
        .cloud-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .cloud-status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ff0808;
            animation: statusPulse 2s infinite;
        }

        .cloud-status-dot.connected {
            background: #10b981;
        }

        @keyframes statusPulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.6;
                transform: scale(0.85);
            }
        }

        .cloud-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid rgba(255, 255, 255, 0.1);
        }

        .cloud-section h4 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
            font-size: 16px;
            font-weight: 700;
        }

        .backup-manager-table {
            width: 100%;
            border-collapse: collapse;
            min-width: auto;
        }

        .backup-manager-table th,
        .backup-manager-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 14px;
        }

        .backup-manager-table th {
            background: rgba(0, 0, 0, 0.35);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
            color: var(--text-muted);
        }

        .backup-manager-table tr:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .btn-cloud {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
        }

        .btn-restore {
            background: linear-gradient(135deg, #06b6d4, #0891b2);
        }
    </style>
</head>

<body>

    <!-- LOGIN OVERLAY - Add this right after opening body tag -->
    <div id="loginOverlay"
        style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:9999; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(10px);">
        <div
            style="background:rgba(30, 41, 59, 0.95); padding:40px; border-radius:24px; border:1px solid rgba(255,255,255,0.25); max-width:400px; width:90%; text-align:center; animation:modalSlideUp 0.5s ease;">
            <div style="margin-bottom:30px;">
                <div style="font-size:48px; color:#667eea; margin-bottom:10px;">
                    <i class="fas fa-home"></i>
                </div>
                <h2 style="font-size:32px; font-weight:800; margin-bottom:10px; color:white;">Interior Budget Pro</h2>
                <p style="opacity:0.8; color:#e2e8f0;">Secure Project Management</p>
            </div>

            <div id="loginError"
                style="background:rgba(239,68,68,0.2); border:1px solid rgba(239,68,68,0.3); padding:12px; border-radius:12px; margin-bottom:20px; display:none;">
                <i class="fas fa-exclamation-circle"></i>
                <span style="margin-left:8px;">Invalid credentials</span>
            </div>

            <form id="loginForm" onsubmit="return handleLogin(event)">
                <div style="margin-bottom:20px; text-align:left;">
                    <label
                        style="display:block; font-size:13px; text-transform:uppercase; letter-spacing:1.2px; margin-bottom:8px; font-weight:700; opacity:0.9; color:white;">Username</label>
                    <input type="text" id="loginUsername" placeholder="Enter username" required
                        style="width:100%; padding:14px; border-radius:12px; border:2px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.15); color:white; font-family:inherit; font-size:15px; transition:all 0.3s ease;">
                </div>

                <div style="margin-bottom:30px; text-align:left;">
                    <label
                        style="display:block; font-size:13px; text-transform:uppercase; letter-spacing:1.2px; margin-bottom:8px; font-weight:700; opacity:0.9; color:white;">Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter password" required
                        style="width:100%; padding:14px; border-radius:12px; border:2px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.15); color:white; font-family:inherit; font-size:15px; transition:all 0.3s ease;">
                </div>

                <button type="submit"
                    style="width:100%; padding:16px; background:linear-gradient(135deg, #667eea, #764ba2); border:none; border-radius:12px; color:white; font-weight:700; font-size:16px; cursor:pointer; transition:all 0.3s ease; display:flex; align-items:center; justify-content:center; gap:10px;">
                    <i class="fas fa-sign-in-alt"></i>
                    Login to Dashboard
                </button>
            </form>

            <!-- <div style="margin-top:25px; padding:15px; background:rgba(255,255,255,0.08); border-radius:12px;">
            <p style="font-size:13px; opacity:0.7; color:#e2e8f0; margin-bottom:8px;">
                <i class="fas fa-info-circle"></i> Default credentials
            </p>
            <p style="font-size:12px; opacity:0.6; color:#e2e8f0;">
                Username: <code style="background:rgba(0,0,0,0.3); padding:2px 6px; border-radius:4px;">admin</code><br>
                Password: <code style="background:rgba(0,0,0,0.3); padding:2px 6px; border-radius:4px;">adminpwd</code>
            </p>
        </div> -->
        </div>
    </div>

    <!-- HIDE THE MAIN APP CONTENT - Add this right after the login overlay -->
    <div id="appContent" style="display:none;">
        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="modal" style="display: flex; background: rgba(0,0,0,0.9);">
            <div class="modal-box" style="background: transparent; border: none; box-shadow: none; text-align: center;">
                <div
                    style="width: 80px; height: 80px; border: 5px solid rgba(255,255,255,0.3); border-top-color: var(--btn-primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;">
                </div>
                <h2 style="font-size: 28px; margin-bottom: 10px;">Interior Budget Pro</h2>
                <p style="opacity: 0.8;">Loading your project dashboard...</p>
            </div>
        </div>

        <div class="container">
            <!-- Header -->
            <div class="header glass">
                <div class="logo">
                    <i class="fas fa-home" style="color: var(--accent);"></i>
                    <span id="projectNameDisplay">Casa Eden</span>
                </div>
                <div class="header-actions">
                    <!-- Real-time Clock -->
                    <div class="glass"
                        style="display:flex; align-items:center; gap:10px; background:rgba(0,0,0,0.35); padding:10px 15px; border-radius:12px; font-family:'Courier New', monospace; font-weight:bold; color:var(--accent); min-width:160px; justify-content:center;">
                        <span id="headerClockIcon"></span>
                        <span id="headerClock">00:00:00 AM</span>
                    </div>

                    <!-- Cloud Context -->
                    <div
                        style="display:flex; align-items:center; gap:8px; background:rgba(255,255,255,0.05); padding:5px 10px; border-radius:15px; border:1px solid rgba(255,255,255,0.1);">
                        <div id="headerCloudStatusDot" class="cloud-status-dot"></div>
                        <span id="headerCloudStatusText"
                            style="font-size:11px; font-weight:bold; opacity:0.8;">Checking...</span>
                        <button class="btn-icon-small" onclick="SupabaseBackup.saveToCloud()" title="Backup to Cloud"
                            style="background:none; border:none; color:white; cursor:pointer; padding:5px;">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </button>
                    </div>

                    <div
                        style="background:rgba(0,0,0,0.35); padding:10px 15px; border-radius:12px; font-size:13px; display:flex; flex-direction:column; align-items:flex-end; gap:2px; min-width:180px;">
                        <div
                            style="display:flex; align-items:center; gap:8px; font-weight:700; color:var(--accent); font-size:14px;">
                            <i class="fas fa-user-circle" style="font-size:16px;"></i>
                            <span id="displayActualName">--</span>
                        </div>
                        <div style="display:flex; align-items:center; gap:8px; opacity:0.9; font-size:12px;">
                            <i class="fas fa-user-shield" style="font-size:11px;"></i>
                            <span id="displayUserRole">--</span>
                        </div>
                        <div style="display:flex; align-items:center; gap:8px; opacity:0.8; font-size:11px;">
                            <i class="fas fa-project-diagram" style="font-size:10px;"></i>
                            <span id="displayProjectName">--</span>
                        </div>
                    </div>

                    <!-- Theme Toggle Button -->
                    <button id="themeToggle" class="btn btn-info" onclick="toggleTheme()"
                        style="padding:10px 15px; border-radius:12px; display:flex; align-items:center; gap:8px;"
                        title="Toggle Dark/Light Mode">
                        <i id="themeIcon" class="fas fa-moon"></i>
                        <span id="themeText">Dark</span>
                    </button>

                    <button class="btn btn-danger" onclick="logout()" style="padding:10px 15px; border-radius:12px;">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <div class="nav-tabs">
                <div class="nav-tab active" onclick="switchTab('dashboard', this)">
                    <i class="fas fa-home"></i> Dashboard
                </div>
                <div class="nav-tab" onclick="switchTab('expenses', this)">
                    <i class="fas fa-wallet"></i> Expenses
                </div>
                <div class="nav-tab" onclick="switchTab('contractors', this)">
                    <i class="fas fa-hard-hat"></i> Contractors
                </div>
                <div class="nav-tab" onclick="switchTab('payments', this)">
                    <i class="fas fa-credit-card"></i> Payments
                </div>
                <div class="nav-tab" onclick="switchTab('components', this)">
                    <i class="fas fa-couch"></i> Components
                </div>
                <div class="nav-tab" onclick="switchTab('faults', this)">
                    <i class="fas fa-exclamation-triangle"></i> Faults
                </div>
                <div class="nav-tab" onclick="switchTab('planning', this)">
                    <i class="fas fa-clipboard-list"></i> Initial Planning
                </div>
                <div class="nav-tab" onclick="switchTab('calendar', this)">
                    <i class="fas fa-calendar-alt"></i> Calendar
                </div>
                <div class="nav-tab" onclick="switchTab('timeline', this)">
                    <i class="fas fa-stream"></i> Timeline
                </div>
                <div class="nav-tab" onclick="switchTab('reports', this)">
                    <i class="fas fa-chart-bar"></i> Analytics
                </div>
                <div class="nav-tab" onclick="switchTab('settings', this)">
                    <i class="fas fa-cogs"></i> Settings
                </div>
            </div>

            <!-- Dashboard View -->
            <div id="dashboard" class="view-section">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:28px;">
                    <h2 style="font-size:28px; font-weight:800; display:flex; align-items:center; gap:12px;">
                        <i class="fas fa-home" style="color:var(--accent);"></i>
                        Project Overview
                    </h2>
                    <button class="btn btn-primary" onclick="editTotalBudget()">
                        <i class="fas fa-edit"></i> Edit Budget
                    </button>
                </div>

                <!-- Budget Stats Grid -->
                <div class="stats-grid">
                    <div class="glass-card stat-card">
                        <i class="fas fa-money-bill-wave" style="color:var(--success)"></i>
                        <div class="stat-label">Total Budget</div>
                        <div class="stat-value" id="d-budget">₹0</div>
                        <div class="budget-bar-container">
                            <div class="budget-bar-fill" id="d-bar"></div>
                            <div class="budget-bar-text" id="d-percent">0% Used</div>
                        </div>
                    </div>
                    <div class="glass-card stat-card">
                        <i class="fas fa-hard-hat" style="color:var(--warning)"></i>
                        <div class="stat-label">Contractor Expenses</div>
                        <div class="stat-value" id="d-spent">₹0</div>
                        <div class="stat-label">Labor & Services</div>
                    </div>
                    <div class="glass-card stat-card">
                        <i class="fas fa-couch" style="color:var(--accent)"></i>
                        <div class="stat-label">Component Investment</div>
                        <div class="stat-value" id="d-comp-total">₹0</div>
                        <div class="stat-label">Materials & Furniture</div>
                    </div>
                    <div class="glass-card stat-card">
                        <i class="fas fa-piggy-bank" style="color:var(--success)"></i>
                        <div class="stat-label">Remaining Balance</div>
                        <div class="stat-value" id="d-remain">₹0</div>
                        <div class="stat-label">Available Funds</div>
                    </div>
                    <div class="glass-card stat-card">
                        <i class="fas fa-receipt" style="color: var(--accent);"></i>
                        <div class="stat-label">TOTAL PROJECT SPENDING</div>
                        <div class="stat-value" id="d-combined-total">₹0</div>
                        <div class="stat-label" id="d-combined-breakdown"></div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <h3
                    style="margin-bottom:20px; border-bottom:2px solid rgba(255,255,255,0.2); padding-bottom:12px; font-size:20px;">
                    <i class="fas fa-chart-line"></i> Quick Stats
                </h3>
                <div class="stats-grid">
                    <div class="glass-card stat-card">
                        <i class="fas fa-hard-hat fa-2x" style="margin-bottom:12px; color:var(--warning)"></i>
                        <div class="stat-value" id="qs-contractors">0</div>
                        <div class="stat-label">Active Contractors</div>
                    </div>
                    <div class="glass-card stat-card">
                        <i class="fas fa-receipt fa-2x" style="margin-bottom:12px; color:var(--info)"></i>
                        <div class="stat-value" id="qs-payments">0</div>
                        <div class="stat-label">Total Transactions</div>
                    </div>
                    <div class="glass-card stat-card">
                        <i class="fas fa-couch fa-2x" style="margin-bottom:12px; color:var(--accent)"></i>
                        <div class="stat-value" id="qs-components">0</div>
                        <div class="stat-label">Components Tracked</div>
                    </div>
                    <div class="glass-card stat-card">
                        <i class="fas fa-exclamation-circle fa-2x" style="margin-bottom:12px; color:var(--danger)"></i>
                        <div class="stat-value" id="qs-faults">0</div>
                        <div class="stat-label">Active Faults</div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="glass-card" style="margin-top:32px;">
                    <h3 style="margin-bottom:20px; display:flex; align-items:center; gap:10px;">
                        <i class="fas fa-history"></i> Recent Activity
                    </h3>
                    <div id="recentActivity"
                        style="min-height:200px; display:flex; align-items:center; justify-content:center;">
                        <p style="opacity:0.6;">No recent activity</p>
                    </div>
                </div>
            </div>

            <!-- Expenses View -->
            <div id="expenses" class="view-section" style="display:none;">
                <div style="display:flex; justify-content:space-between; margin-bottom:28px; align-items:center;">
                    <h2 style="font-size:28px; font-weight:800; display:flex; align-items:center; gap:12px;">
                        <i class="fas fa-wallet" style="color:var(--success);"></i>
                        Expense Tracker
                    </h2>
                    <button class="btn btn-success" onclick="addExpense()">
                        <i class="fas fa-plus"></i> Add Expense
                    </button>
                </div>

                <!-- Table Controls -->
                <div class="glass-card" style="margin-bottom:16px; padding:16px;">
                    <div
                        style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px;">
                        <div style="display:flex; align-items:center; gap:12px;">
                            <label style="font-size:13px; opacity:0.8;">Show:</label>
                            <select id="expenseRowsPerPage" onchange="updateExpenseTableDisplay()"
                                style="padding:8px 12px; border-radius:8px; background:rgba(255,255,255,0.1); color:var(--text-light); border:1px solid rgba(255,255,255,0.2); cursor:pointer;">
                                <option value="10">10 rows</option>
                                <option value="25" selected>25 rows</option>
                                <option value="50">50 rows</option>
                                <option value="100">100 rows</option>
                                <option value="all">All rows</option>
                            </select>
                            <span id="expenseTableInfo" style="font-size:13px; opacity:0.7; margin-left:8px;">Showing 0
                                of 0 entries</span>
                        </div>
                        <button class="btn btn-primary" onclick="exportExpensesToExcel()" title="Export to Excel">
                            <i class="fas fa-file-excel"></i> Export to Excel
                        </button>
                    </div>
                </div>

                <!-- Scrollable Table Container -->
                <div class="glass-card table-wrap scrollable-table-container">
                    <table id="expensesTable">
                        <thead>
                            <tr>
                                <th data-sortable="true">Date</th>
                                <th data-sortable="true">Category</th>
                                <th data-sortable="true">Contractor</th>
                                <th data-sortable="true">Work Type</th>
                                <th data-sortable="true">Amount</th>
                                <th data-sortable="true">Paid By</th>
                                <th data-sortable="true">Status</th>
                                <th data-sortable="false">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="expenseTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Contractors View -->
            <div id="contractors" class="view-section" style="display:none;">
                <div style="display:flex; justify-content:space-between; margin-bottom:28px;">
                    <h2 style="font-size:28px; font-weight:800; display:flex; align-items:center; gap:12px;">
                        <i class="fas fa-hard-hat" style="color:var(--warning);"></i>
                        Contractors Management
                    </h2>
                    <button class="btn btn-success" onclick="addContractor()">
                        <i class="fas fa-plus"></i> Add Contractor
                    </button>
                </div>
                <div id="contractorGrid" class="stats-grid"></div>
            </div>

            <!-- Payments View -->
            <div id="payments" class="view-section" style="display:none;">
                <h2
                    style="font-size:28px; font-weight:800; margin-bottom:28px; display:flex; align-items:center; gap:12px;">
                    <i class="fas fa-credit-card" style="color:var(--info);"></i>
                    Payments & Transactions
                </h2>

                <div class="glass-card" style="margin-top:20px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:center;">
                        <h3>Contractor Payment Status</h3>
                        <div style="display:flex; gap:12px; align-items:center;">
                            <select id="paymentFilter" onchange="renderPayments()"
                                style="width:280px; padding:12px; border-radius:12px; background:rgba(255,255,255,0.15); color:var(--text-light); border:2px solid rgba(255,255,255,0.2);">
                                <option value="all">Show All Transactions</option>
                            </select>
                            <button id="btnExportContractorPDF" class="btn btn-pdf"
                                style="display:none; padding:12px; border-radius:12px;"
                                onclick="exportContractorPaymentsPDF()">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                            <button id="btnShareWhatsApp" class="btn btn-success"
                                style="display:none; padding:12px; border-radius:12px; background:#25D366; border-color:#25D366;"
                                onclick="shareOnWhatsApp()">
                                <i class="fab fa-whatsapp"></i> WhatsApp
                            </button>
                        </div>
                    </div>
                    <div id="paymentBarsContainer"></div>
                </div>

                <div class="glass-card table-wrap">
                    <h3 style="margin-bottom:20px;">Transaction History</h3>
                    <table id="paymentsTable">
                        <thead>
                            <tr>
                                <th data-sortable="true">Date</th>
                                <th data-sortable="true">Contractor</th>
                                <th data-sortable="true">Work Type</th>
                                <th data-sortable="true">Amount</th>
                                <th data-sortable="true">Paid By</th>
                                <th data-sortable="true">Mode</th>
                            </tr>
                        </thead>
                        <tbody id="paymentTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Components View -->
            <div id="components" class="view-section" style="display:none;">
                <div style="display:flex; justify-content:space-between; margin-bottom:28px;">
                    <h2 style="font-size:28px; font-weight:800; display:flex; align-items:center; gap:12px;">
                        <i class="fas fa-couch" style="color:var(--accent);"></i>
                        Components & Materials
                    </h2>
                    <button class="btn btn-success" onclick="addComponent()">
                        <i class="fas fa-plus"></i> Add Component
                    </button>
                </div>
                <div class="glass-card table-wrap">
                    <table id="componentsTable">
                        <thead>
                            <tr>
                                <th data-sortable="true">Date</th>
                                <th data-sortable="true">Component Details</th>
                                <th data-sortable="true">Contractor</th>
                                <th data-sortable="true">Proposed Cost</th>
                                <th data-sortable="true">Actual Cost</th>
                                <th data-sortable="true">Progress</th>
                                <th data-sortable="true">Status</th>
                                <th data-sortable="false">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="componentTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Faults View -->
            <div id="faults" class="view-section" style="display:none;">
                <div style="display:flex; justify-content:space-between; margin-bottom:28px;">
                    <h2 style="font-size:28px; font-weight:800; display:flex; align-items:center; gap:12px;">
                        <i class="fas fa-exclamation-triangle" style="color:var(--danger);"></i>
                        Faults & Issues
                    </h2>
                    <button class="btn btn-danger" onclick="addFault()">
                        <i class="fas fa-exclamation"></i> Report Fault
                    </button>
                </div>
                <div class="glass-card table-wrap">
                    <table id="faultsTable">
                        <thead>
                            <tr>
                                <th data-sortable="true">Date</th>
                                <th data-sortable="true">Contractor</th>
                                <th data-sortable="true">Issue</th>
                                <th data-sortable="true">Cost</th>
                                <th data-sortable="true">Status</th>
                                <th data-sortable="false">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="faultTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Initial Planning View -->
            <div id="planning" class="view-section" style="display:none;">
                <div style="display:flex; justify-content:space-between; margin-bottom:28px; align-items:center;">
                    <h2 style="font-size:28px; font-weight:800; display:flex; align-items:center; gap:12px;">
                        <i class="fas fa-clipboard-list" style="color:var(--info);"></i>
                        Initial Project Planning
                    </h2>
                    <div style="display:flex; gap:12px;">
                        <button class="btn btn-primary" onclick="exportPlanningToPDF()">
                            <i class="fas fa-file-pdf"></i> Export Planning
                        </button>
                    </div>
                </div>

                <!-- Planning Sections Layout -->
                <div id="planningSectionsContainer">
                    <!-- Electricity Section -->
                    <div class="glass-card" style="margin-bottom:32px;">
                        <div
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                            <h3 style="color:#e6eef1;"><i class="fas fa-bolt"></i> Electricity Planning</h3>
                            <button class="btn btn-icon-small btn-success" onclick="addPlanningRow('electricity')"
                                title="Add Row">
                                <i class="fas fa-plus"></i> Add Row
                            </button>
                        </div>
                        <div class="table-wrap">
                            <table class="planning-table" id="table-electricity">
                                <thead>
                                    <tr>
                                        <th>Material/Item Name</th>
                                        <th>Part Name (Contractor)</th>
                                        <th>Units</th>
                                        <th>Material Type</th>
                                        <th>Proposed Cost</th>
                                        <th>Actual Cost</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="body-electricity"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Furniture Section -->
                    <div class="glass-card" style="margin-bottom:32px;">
                        <div
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                            <h3 style="color:#e3e0ec;"><i class="fas fa-couch"></i> Furniture Planning</h3>
                            <button class="btn btn-icon-small btn-success" onclick="addPlanningRow('furniture')"
                                title="Add Row">
                                <i class="fas fa-plus"></i> Add Row
                            </button>
                        </div>
                        <div class="table-wrap">
                            <table class="planning-table" id="table-furniture">
                                <thead>
                                    <tr>
                                        <th>Material/Item Name</th>
                                        <th>Part Name (Contractor)</th>
                                        <th>Units</th>
                                        <th>Material Type</th>
                                        <th>Proposed Cost</th>
                                        <th>Actual Cost</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="body-furniture"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- POP Section -->
                    <div class="glass-card" style="margin-bottom:32px;">
                        <div
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                            <h3 style="color:#e1e5e4;"><i class="fas fa-layer-group"></i> POP Planning</h3>
                            <button class="btn btn-icon-small btn-success" onclick="addPlanningRow('pop')"
                                title="Add Row">
                                <i class="fas fa-plus"></i> Add Row
                            </button>
                        </div>
                        <div class="table-wrap">
                            <table class="planning-table" id="table-pop">
                                <thead>
                                    <tr>
                                        <th>Material/Item Name</th>
                                        <th>Part Name (Contractor)</th>
                                        <th>Units</th>
                                        <th>Material Type</th>
                                        <th>Proposed Cost</th>
                                        <th>Actual Cost</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="body-pop"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Painter Section -->
                    <div class="glass-card" style="margin-bottom:32px;">
                        <div
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                            <h3 style="color:#e0d7e2;"><i class="fas fa-paint-roller"></i> Painter Planning</h3>
                            <button class="btn btn-icon-small btn-success" onclick="addPlanningRow('painter')"
                                title="Add Row">
                                <i class="fas fa-plus"></i> Add Row
                            </button>
                        </div>
                        <div class="table-wrap">
                            <table class="planning-table" id="table-painter">
                                <thead>
                                    <tr>
                                        <th>Material/Item Name</th>
                                        <th>Part Name (Contractor)</th>
                                        <th>Units</th>
                                        <th>Material Type</th>
                                        <th>Proposed Cost</th>
                                        <th>Actual Cost</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="body-painter"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Custom Fitting Section -->
                    <div class="glass-card" style="margin-bottom:32px;">
                        <div
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                            <h3 style="color:var(--accent);"><i class="fas fa-tools"></i> Custom Fitting / Others</h3>
                            <button class="btn btn-icon-small btn-success" onclick="addPlanningRow('custom')"
                                title="Add Row">
                                <i class="fas fa-plus"></i> Add Row
                            </button>
                        </div>
                        <div class="table-wrap">
                            <table class="planning-table" id="table-custom">
                                <thead>
                                    <tr>
                                        <th>Material/Item Name</th>
                                        <th>Part Name (Contractor)</th>
                                        <th>Units</th>
                                        <th>Material Type</th>
                                        <th>Proposed Cost</th>
                                        <th>Actual Cost</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="body-custom"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calendar View -->
            <div id="calendar" class="view-section" style="display:none;">
                <h2
                    style="font-size:28px; font-weight:800; margin-bottom:28px; display:flex; align-items:center; gap:12px;">
                    <i class="fas fa-calendar-alt" style="color:var(--info);"></i>
                    Project Calendar
                </h2>
                <div class="calendar-layout">
                    <div class="glass-card">
                        <div
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
                            <button class="btn btn-primary" onclick="changeMonth(-1)">
                                <i class="fas fa-chevron-left"></i> Previous
                            </button>
                            <h3 id="calMonthYear" style="font-size:24px; font-weight:700;">Month Year</h3>
                            <button class="btn btn-primary" onclick="changeMonth(1)">
                                Next <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="cal-grid" id="calGrid"></div>
                    </div>
                    <div class="glass-card">
                        <h3 id="selectedDateDisplay"
                            style="border-bottom:2px solid rgba(255,255,255,0.2); padding-bottom:16px; margin-bottom:24px; font-size:20px;">
                            Select a Date
                        </h3>
                        <div id="dateContent" style="min-height:300px;"></div>
                        <button class="btn btn-success" style="width:100%; margin-top:24px; padding:16px;"
                            onclick="addNote()">
                            <i class="fas fa-sticky-note"></i> Add Note / Reminder
                        </button>
                    </div>
                </div>
            </div>

            <!-- Timeline View -->
            <div id="timeline" class="view-section" style="display:none;">
                <h2
                    style="font-size:28px; font-weight:800; margin-bottom:28px; display:flex; align-items:center; gap:12px;">
                    <i class="fas fa-stream" style="color:var(--accent);"></i>
                    Project Timeline
                </h2>
                <div class="glass-card">
                    <div style="margin-bottom:24px;">
                        <div style="display:flex; gap:12px; margin-bottom:20px; flex-wrap:wrap;">
                            <button class="btn btn-primary active" onclick="filterTimeline('all')">All</button>
                            <button class="btn btn-success" onclick="filterTimeline('payment')">Payments</button>
                            <button class="btn btn-warning" onclick="filterTimeline('fault')">Faults</button>
                            <button class="btn btn-info" onclick="filterTimeline('component')">Components</button>
                            <button class="btn btn-warning" style="background:#f59e0b"
                                onclick="filterTimeline('note')">Notes</button>
                        </div>
                    </div>
                    <div id="timelineList"></div>
                </div>
            </div>

            <!-- Analytics & Reports View -->
            <div id="reports" class="view-section" style="display:none;">
                <h2
                    style="font-size:28px; font-weight:800; margin-bottom:32px; display:flex; align-items:center; gap:12px;">
                    <i class="fas fa-chart-bar" style="color:var(--primary);"></i>
                    Analytics & Reports
                </h2>

                <div class="charts-grid">
                    <!-- Spending by Category -->
                    <div class="glass-card">
                        <h3 style="margin-bottom:20px; display:flex; align-items:center; gap:10px;">
                            <i class="fas fa-pie-chart"></i> Spending by Category
                        </h3>
                        <div class="chart-container">
                            <canvas id="catChart"></canvas>
                        </div>
                    </div>

                    <!-- Spending by Contractor -->
                    <div class="glass-card">
                        <h3 style="margin-bottom:20px; display:flex; align-items:center; gap:10px;">
                            <i class="fas fa-chart-pie"></i> Spending by Contractor
                        </h3>
                        <div class="chart-container">
                            <canvas id="contChart"></canvas>
                        </div>
                    </div>

                    <!-- Monthly Spending Trend -->
                    <div class="glass-card">
                        <h3 style="margin-bottom:20px; display:flex; align-items:center; gap:10px;">
                            <i class="fas fa-chart-line"></i> Monthly Spending Trend
                        </h3>
                        <div class="chart-container">
                            <canvas id="monthlyChart"></canvas>
                        </div>
                    </div>

                    <!-- Component Progress Overview -->
                    <div class="glass-card">
                        <h3 style="margin-bottom:20px; display:flex; align-items:center; gap:10px;">
                            <i class="fas fa-tasks"></i> Component Progress
                        </h3>
                        <div class="chart-container">
                            <canvas id="compChart"></canvas>
                        </div>
                    </div>

                    <!-- Payment Method Distribution -->
                    <div class="glass-card">
                        <h3 style="margin-bottom:20px; display:flex; align-items:center; gap:10px;">
                            <i class="fas fa-credit-card"></i> Payment Methods
                        </h3>
                        <div class="chart-container">
                            <canvas id="paymentMethodChart"></canvas>
                        </div>
                    </div>

                    <!-- Budget vs Actual -->
                    <div class="glass-card">
                        <h3 style="margin-bottom:20px; display:flex; align-items:center; gap:10px;">
                            <i class="fas fa-balance-scale"></i> Budget vs Actual
                        </h3>
                        <div class="chart-container">
                            <canvas id="budgetVsActualChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Detailed Reports -->
                <div class="glass-card" style="margin-top:32px;">
                    <h3 style="margin-bottom:24px; display:flex; align-items:center; gap:10px;">
                        <i class="fas fa-file-alt"></i> Detailed Reports
                    </h3>
                    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(300px, 1fr)); gap:20px;">
                        <div class="analytics-card">
                            <h4 style="margin-bottom:12px;">Top Expenses</h4>
                            <div id="topExpensesList"></div>
                        </div>
                        <div class="analytics-card">
                            <h4 style="margin-bottom:12px;">Contractor Performance</h4>
                            <div id="contractorPerformance"></div>
                        </div>
                        <div class="analytics-card">
                            <h4 style="margin-bottom:12px;">Budget Health</h4>
                            <div id="budgetHealth"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings View -->
            <div id="settings" class="view-section" style="display:none;">
                <h2
                    style="font-size:28px; font-weight:800; margin-bottom:32px; display:flex; align-items:center; gap:12px;">
                    <i class="fas fa-cogs" style="color:var(--warning);"></i>
                    Settings
                </h2>

                <!-- User Management Section (Admin Only) -->
                <div class="glass-card" id="userManagementSection"
                    style="display:none; border-left: 5px solid var(--primary);">
                    <h3 style="margin-bottom:24px; display:flex; justify-content:space-between; align-items:center;">
                        <span><i class="fas fa-users-cog"></i> User Management</span>
                        <button class="btn btn-success" onclick="UserManager.openUserModal()">
                            <i class="fas fa-user-plus"></i> Add User
                        </button>
                    </h3>
                    <div class="table-wrap">
                        <table id="usersTable">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Role</th>
                                    <th>Project</th>
                                    <th>Shared Key</th>
                                    <th>Password</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="glass-card">
                    <h3 style="margin-bottom:24px; display:flex; justify-content:space-between; align-items:center;">
                        <span><i class="fas fa-user-circle"></i> Profile Settings</span>
                        <span id="currentUserTypeBadge" class="badge badge-secondary" style="font-size:12px;">
                            <i class="fas fa-user"></i> USER
                        </span>
                    </h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Project Name</label>
                            <input type="text" id="setProjectName" placeholder="e.g. My Dream Home Interior">
                        </div>
                        <div class="form-group">
                            <label>Project Manager</label>
                            <input type="text" id="setUserName" placeholder="Your Name">
                        </div>
                        <div class="form-group">
                            <label>Project Address</label>
                            <input type="text" id="setProjectAddress" placeholder="Enter project address">
                        </div>
                        <div class="form-group">
                            <label>Project Timeline</label>
                            <input type="text" id="setProjectTimeline" placeholder="e.g. 6 months">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="saveProfile()">
                        <i class="fas fa-save"></i> Save Profile
                    </button>
                </div>

                <!-- Password Change Section -->
                <div class="glass-card" style="border-left: 5px solid var(--warning);">
                    <h3 style="margin-bottom:24px; display:flex; justify-content:space-between; align-items:center;">
                        <span><i class="fas fa-lock"></i> Change Password</span>
                        <span
                            style="font-size:14px; font-weight:600; color:var(--accent); display:flex; align-items:center; gap:8px;">
                            <i class="fas fa-user-circle" style="font-size:16px;"></i>
                            <span id="passwordChangeUsername">--</span>
                        </span>
                    </h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Current Password</label>
                            <div style="position:relative;">
                                <input type="password" id="currentPassword" placeholder="Enter current password">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>New Password</label>
                            <div style="position:relative;">
                                <input type="password" id="newPassword" placeholder="Enter new password">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Confirm New Password</label>
                            <div style="position:relative;">
                                <input type="password" id="confirmPassword" placeholder="Confirm new password">
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-warning" onclick="changePassword()">
                        <i class="fas fa-key"></i> Update Password
                    </button>
                    <p style="margin-top:12px; font-size:12px; opacity:0.7;">
                        <i class="fas fa-info-circle"></i> Password must be at least 6 characters long
                    </p>
                </div>

                <div class="glass-card">
                    <h3 style="margin-bottom:24px;">
                        <i class="fas fa-credit-card"></i> Payment Sources
                    </h3>
                    <div class="form-group">
                        <label>Payment Sources (comma separated)</label>
                        <input type="text" id="setPaymentSources"
                            placeholder="Self, Spouse, Parent, Bank Loan, Savings">
                    </div>
                    <button class="btn btn-primary" onclick="savePaymentSources()">
                        <i class="fas fa-save"></i> Save Sources
                    </button>
                    <div style="margin-top:16px; padding:16px; background:rgba(255,255,255,0.1); border-radius:12px;"
                        id="currentSources">
                        <strong>Current Sources:</strong> Self, Spouse, Parent, Bank Loan
                    </div>
                </div>

                <div class="glass-card">
                    <h3 style="margin-bottom:24px;">
                        <i class="fas fa-home"></i> Theme Selection
                    </h3>
                    <div
                        style="display:grid; grid-template-columns:repeat(auto-fit, minmax(120px, 1fr)); gap:12px; margin-top:16px;">
                        <button class="btn" style="background:#667eea" onclick="setTheme('purple')">Purple</button>
                        <button class="btn" style="background:#0ea5e9" onclick="setTheme('blue')">Blue</button>
                        <button class="btn" style="background:#10b981" onclick="setTheme('green')">Green</button>
                        <button class="btn" style="background:#f59e0b" onclick="setTheme('orange')">Orange</button>
                        <button class="btn" style="background:#14b8a6" onclick="setTheme('teal')">Teal</button>
                        <button class="btn" style="background:#1e293b" onclick="setTheme('midnight')">Midnight</button>
                        <button class="btn" style="background:#8b5cf6" onclick="setTheme('royal')">Royal</button>
                        <button class="btn" style="background:#f97316" onclick="setTheme('sunset')">Sunset</button>
                        <button class="btn" style="background:#0891b2" onclick="setTheme('ocean')">Ocean</button>
                        <button class="btn" style="background:#16a34a" onclick="setTheme('forest')">Forest</button>
                        <button class="btn" style="background:#e11d48" onclick="setTheme('rose')">Rose</button>
                        <button class="btn" style="background:#06b6d4" onclick="setTheme('cyber')">Cyber</button>
                        <button class="btn" style="background:#6c5ce7"
                            onclick="setTheme('modern-purple')">ModrnPurple</button>
                    </div>
                </div>

                <div class="glass-card">
                    <h3 style="margin-bottom:24px;">
                        <i class="fas fa-database"></i> Data Management
                    </h3>
                    <p style="opacity:0.8; font-size:14px; margin-bottom:20px;">Backup, restore, or reset your project
                        data.</p>
                    <div style="display:flex; flex-wrap:wrap; gap:12px;">
                        <button class="btn btn-info" onclick="exportData()">
                            <i class="fas fa-download"></i> Backup JSON
                        </button>
                        <input type="file" id="importFile" style="display:none" accept=".json"
                            onchange="importData(this)">
                        <button class="btn btn-primary" onclick="document.getElementById('importFile').click()">
                            <i class="fas fa-upload"></i> Restore JSON
                        </button>
                        <button class="btn btn-pdf" onclick="exportPDF()">
                            <i class="fas fa-file-pdf"></i> Export PDF
                        </button>
                        <button class="btn btn-success" onclick="exportExcelEnhanced()">
                            <i class="fas fa-file-excel"></i> Export Excel
                        </button>
                        <button class="btn btn-danger" onclick="resetApp()">
                            <i class="fas fa-trash-alt"></i> Factory Reset
                        </button>
                    </div>

                    <!-- Cloud Backup Section -->
                    <div class="cloud-section">
                        <h4>
                            <i class="fas fa-cloud" style="color:var(--info);"></i> Cloud Backup
                            <span class="cloud-status" id="cloudStatusBadge"
                                style="margin-left:auto; background:rgba(255,255,255,0.1);">
                                <span class="cloud-status-dot" id="settingsCloudStatusDot"></span>
                                <span id="settingsCloudStatusText">Checking...</span>
                            </span>
                        </h4>
                        <p style="opacity:0.7; font-size:13px; margin-bottom:16px;">Sync your data to the cloud for safe
                            keeping. Auto-loads the newest version on startup.</p>
                        <div style="display:flex; flex-wrap:wrap; gap:12px;">
                            <button class="btn btn-cloud" onclick="SupabaseBackup.saveToCloud()" id="btnSaveCloud">
                                <i class="fas fa-cloud-upload-alt"></i> Save to Cloud
                            </button>
                            <button class="btn btn-restore" onclick="SupabaseBackup.restoreLatest()"
                                id="btnRestoreLatest">
                                <i class="fas fa-cloud-download-alt"></i> Restore Latest
                            </button>
                            <button class="btn btn-primary" onclick="SupabaseBackup.openManager()"
                                id="btnManageBackups">
                                <i class="fas fa-list-alt"></i> Manage Backups
                            </button>
                            <button class="btn btn-warning" onclick="SupabaseBackup.testConnection()"
                                id="btnTestConnection">
                                <i class="fas fa-plug"></i> Test Connection
                            </button>
                        </div>
                    </div>
                </div>

                <div class="glass-card">
                    <h3 style="margin-bottom:24px;">
                        <i class="fas fa-chart-line"></i> Analytics Preferences
                    </h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Currency Symbol</label>
                            <select id="currencySymbol"
                                style="background:rgba(255,255,255,0.15); color:var(--text-light); padding:12px; border-radius:12px; border:2px solid rgba(255,255,255,0.2);">
                                <option value="₹">Indian Rupee (₹)</option>
                                <option value="$">US Dollar ($)</option>
                                <option value="€">Euro (€)</option>
                                <option value="£">British Pound (£)</option>
                                <option value="¥">Japanese Yen (¥)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Date Format</label>
                            <select id="dateFormat"
                                style="background:rgba(255,255,255,0.15); color:var(--text-light); padding:12px; border-radius:12px; border:2px solid rgba(255,255,255,0.2);">
                                <option value="en-IN">DD/MM/YYYY</option>
                                <option value="en-US">MM/DD/YYYY</option>
                                <option value="iso">YYYY-MM-DD</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="savePreferences()">
                        <i class="fas fa-save"></i> Save Preferences
                    </button>
                </div>
            </div>
        </div>

        <!-- Modals -->
        <div id="expenseModal" class="modal">
            <div class="modal-box">
                <h3 style="margin-bottom:24px; display:flex; align-items:center; gap:12px;">
                    <i class="fas fa-wallet" style="color:var(--success);"></i>
                    Add Expense / Payment
                </h3>
                <form onsubmit="saveExpense(event)" id="expenseForm">
                    <input type="hidden" id="expId">
                    <div class="form-grid">
                        <div><label>Date</label><input type="date" id="expDate" required></div>
                        <div><label>Amount</label><input type="number" id="expAmount" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Contractor</label>
                        <select id="expContractor" required>
                            <option value="">Select Contractor...</option>
                        </select>
                    </div>
                    <div class="form-grid">
                        <div><label>Work Type</label><input type="text" id="expWorkType"
                                placeholder="e.g. Painting, Electrical" list="commonWorkTypes"></div>
                        <div><label>Category</label>
                            <select id="expCategory">
                                <option>Material</option>
                                <option>Labor</option>
                                <option>Furniture</option>
                                <option>Electrical</option>
                                <option>Plumbing</option>
                                <option>Paint</option>
                                <option>Tiles</option>
                                <option>Carpentry</option>
                                <option>Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div><label>Paid By</label>
                            <select id="expPaidBy" required></select>
                        </div>
                        <div><label>Payment Mode</label>
                            <select id="expMode">
                                <option>UPI</option>
                                <option>Cash</option>
                                <option>Bank Transfer</option>
                                <option>Card</option>
                                <option>Cheque</option>
                                <option>Online</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="expStatus">
                            <option>Completed</option>
                            <option>Pending</option>
                            <option>In Progress</option>
                            <option>Partially Paid</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Notes (Optional)</label>
                        <textarea id="expNotes" rows="2" placeholder="Add any additional notes..."></textarea>
                    </div>
                    <div style="display:flex; gap:12px; margin-top:28px;">
                        <button type="button" class="btn btn-danger"
                            onclick="closeModal('expenseModal')">Cancel</button>
                        <button type="button" class="btn btn-info" id="duplicateFromModal" style="display:none;"
                            onclick="duplicateFromModal()">
                            <i class="fas fa-copy"></i> Duplicate
                        </button>
                        <button type="submit" class="btn btn-success" style="flex:1">Save Expense</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="contractorModal" class="modal">
            <div class="modal-box">
                <h3 style="margin-bottom:24px; display:flex; align-items:center; gap:12px;">
                    <i class="fas fa-hard-hat" style="color:var(--warning);"></i>
                    Contractor Details
                </h3>
                <form onsubmit="saveContractor(event)" id="contractorForm">
                    <input type="hidden" id="contId">
                    <div class="form-group"><label>Name *</label><input type="text" id="contName" required></div>
                    <div class="form-grid">
                        <div><label>Specialization</label><input type="text" id="contRole"
                                placeholder="e.g. Electrician, Plumber"></div>
                        <div><label>Phone</label><input type="tel" id="contPhone" placeholder="+91 9876543210"></div>
                    </div>
                    <div class="form-grid">
                        <div><label>Email</label><input type="email" id="contEmail" placeholder="contractor@email.com">
                        </div>
                        <div><label>Company</label><input type="text" id="contCompany" placeholder="Company Name"></div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Allocated Budget</label>
                            <input type="number" id="contBudget" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                            <label>Star Rating (1-5)</label>
                            <div class="star-rating-input"
                                style="display:flex; gap:5px; font-size:20px; color:var(--accent); cursor:pointer; margin-top:10px;">
                                <i class="far fa-star rating-star" data-rating="1" onclick="setContractorRating(1)"></i>
                                <i class="far fa-star rating-star" data-rating="2" onclick="setContractorRating(2)"></i>
                                <i class="far fa-star rating-star" data-rating="3" onclick="setContractorRating(3)"></i>
                                <i class="far fa-star rating-star" data-rating="4" onclick="setContractorRating(4)"></i>
                                <i class="far fa-star rating-star" data-rating="5" onclick="setContractorRating(5)"></i>
                                <input type="hidden" id="contRating" value="0">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Contract Details (Optional)</label>
                        <textarea id="contDetails" rows="3" placeholder="Contract terms, scope of work..."></textarea>
                    </div>
                    <div style="display:flex; gap:12px; margin-top:28px;">
                        <button type="button" class="btn btn-danger"
                            onclick="closeModal('contractorModal')">Cancel</button>
                        <button type="submit" class="btn btn-success" style="flex:1">Save Contractor</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="componentModal" class="modal">
            <div class="modal-box">
                <h3 style="margin-bottom:24px; display:flex; align-items:center; gap:12px;">
                    <i class="fas fa-couch" style="color:var(--accent);"></i>
                    Component / Material
                </h3>
                <form onsubmit="saveComponent(event)" id="componentForm">
                    <input type="hidden" id="compId">
                    <div class="form-grid">
                        <div><label>Date</label><input type="date" id="compDate" required></div>
                        <div><label>Name *</label><input type="text" id="compName" required></div>
                    </div>
                    <div class="form-grid">
                        <div><label>Category</label>
                            <select id="compCategory" onchange="toggleComponentTemplate()">
                                <option>Electrical</option>
                                <option>Plumbing</option>
                                <option>Furniture</option>
                                <option>Paint</option>
                                <option>Tiles</option>
                                <option>Carpentry</option>
                                <option>Other</option>
                            </select>
                        </div>
                        <div><label>Proposed Cost</label><input type="number" id="compProposedCost" step="0.01"
                                value="0"></div>
                    </div>
                    <div class="form-grid">
                        <div><label>Actual Cost</label><input type="number" id="compActualCost" step="0.01" value="0">
                        </div>
                        <div><label>Work Type</label>
                            <select id="compWorkType">
                                <option>Installation</option>
                                <option>Repair</option>
                                <option>Maintenance</option>
                                <option>Fitting</option>
                                <option>Material Supply</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Contractor</label>
                        <select id="compContractor" onchange="toggleNewContractorFields()">
                            <option value="">None / New</option>
                        </select>
                    </div>
                    <!-- New Contractor Details if "None" selected -->
                    <div id="newContractorDetails"
                        style="display:none; background:rgba(255,165,0,0.05); padding:15px; border-radius:12px; border:1px solid rgba(255,165,0,0.2); margin-bottom:15px;">
                        <div class="form-grid">
                            <div><label>New Contractor Name</label><input type="text" id="compNewContName"
                                    placeholder="Name"></div>
                            <div><label>New Contractor Phone</label><input type="tel" id="compNewContPhone"
                                    placeholder="Phone"></div>
                        </div>
                    </div>

                    <div class="form-group" style="margin-top:20px;">
                        <label>Progress (%)</label>
                        <input type="range" id="compProgress" min="0" max="100" value="0" style="width:100%"
                            oninput="document.getElementById('compProgDisplay').innerText = this.value + '%'">
                        <div style="text-align:center; font-size:18px; margin-top:8px;" id="compProgDisplay">0%</div>
                    </div>

                    <div class="form-group"><label>Status</label>
                        <select id="compStatus">
                            <option>Not Started</option>
                            <option>In Progress</option>
                            <option>Completed</option>
                        </select>
                    </div>
                    <div style="display:flex; gap:12px; margin-top:28px;">
                        <button type="button" class="btn btn-danger"
                            onclick="closeModal('componentModal')">Cancel</button>
                        <button type="submit" class="btn btn-success" style="flex:1">Save Component</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="faultModal" class="modal">
            <div class="modal-box">
                <h3 style="margin-bottom:24px; display:flex; align-items:center; gap:12px;">
                    <i class="fas fa-exclamation-triangle" style="color:var(--danger);"></i>
                    Report Fault
                </h3>
                <form onsubmit="saveFault(event)" id="faultForm">
                    <input type="hidden" id="faultId">
                    <div class="form-grid">
                        <div><label>Date</label><input type="date" id="faultDate" required></div>
                        <div><label>Contractor</label><select id="faultContractor" required>
                                <option value="">Select...</option>
                            </select></div>
                    </div>
                    <div class="form-group"><label>Description</label><textarea id="faultDesc" rows="3"
                            required></textarea></div>
                    <div class="form-grid">
                        <div><label>Estimated Cost</label><input type="number" id="faultCost" step="0.01"></div>
                        <div><label>Status</label><select id="faultStatus">
                                <option>Open</option>
                                <option>In Review</option>
                                <option>Resolved</option>
                            </select></div>
                    </div>
                    <div style="display:flex; gap:12px; margin-top:28px;">
                        <button type="button" class="btn btn-danger" onclick="closeModal('faultModal')">Cancel</button>
                        <button type="submit" class="btn btn-success" style="flex:1">Save Fault Report</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="noteModal" class="modal">
            <div class="modal-box">
                <h3 style="margin-bottom:24px; display:flex; align-items:center; gap:12px;">
                    <i class="fas fa-sticky-note" style="color:var(--warning);"></i>
                    Note / Reminder
                </h3>
                <textarea id="noteText" rows="6" placeholder="Enter note..." style="width:100%"></textarea>
                <input type="hidden" id="noteEditId">
                <div style="display:flex; gap:12px; margin-top:20px;">
                    <button class="btn btn-danger" onclick="closeModal('noteModal')">Cancel</button>
                    <button class="btn btn-success" style="flex:1" onclick="saveNote()">Save Note</button>
                </div>
            </div>
        </div>

        <!-- Cloud Backup Manager Modal -->
        <div id="backupManagerModal" class="modal">
            <div class="modal-box">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3 style="display:flex; align-items:center; gap:12px; margin:0;">
                        <i class="fas fa-cloud" style="color:var(--info);"></i>
                        Cloud Backup Manager
                    </h3>
                    <button class="btn btn-danger btn-icon" onclick="SupabaseBackup.closeManager()" title="Close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="backupManagerContent">
                    <p style="text-align:center; opacity:0.6; padding:40px;">Loading backups...</p>
                </div>
            </div>
        </div>
        <!-- User Management Modal -->
        <div id="userModal" class="modal">
            <div class="modal-box">
                <h3 style="margin-bottom:24px; display:flex; align-items:center; gap:12px;">
                    <i class="fas fa-user-shield" style="color:var(--primary);"></i>
                    User Details
                </h3>
                <form onsubmit="UserManager.saveUser(event)">
                    <input type="hidden" id="userId">
                    <div class="form-grid">
                        <div class="form-group"><label>Username</label><input type="text" id="userUsername" required>
                        </div>
                        <div class="form-group"><label>Email</label><input type="email" id="userEmail" required></div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Password</label>
                            <div style="position:relative;">
                                <input type="password" id="userPassword" placeholder="Leave blank to keep current"
                                    style="padding-right:40px;">
                                <button type="button" id="toggleUserPassword" class="admin-only"
                                    style="position:absolute; right:10px; top:50%; transform:translateY(-50%); background:none; border:none; color:var(--text-light); cursor:pointer; display:none;"
                                    onclick="togglePasswordVisibility('userPassword', 'toggleUserPassword')"
                                    title="Show/Hide Password">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-group"><label>Role</label>
                            <select id="userRole">
                                <option value="user">User</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group"><label>Project Name</label><input type="text" id="userProject"
                                placeholder="Assigned Project"></div>
                        <div class="form-group"><label>Shared Key (Optional)</label><input type="text"
                                id="userSharedKey" placeholder="For sharing projects"></div>
                    </div>
                    <div style="display:flex; gap:12px; margin-top:28px;">
                        <button type="button" class="btn btn-danger" onclick="closeModal('userModal')">Cancel</button>
                        <button type="submit" class="btn btn-success" style="flex:1">Save User</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Data Lists -->
        <datalist id="commonWorkTypes">
            <option>Material Purchase</option>
            <option>Labor Payment</option>
            <option>Advance Payment</option>
            <option>Final Settlement</option>
            <option>Installation</option>
            <option>Repair Work</option>
            <option>Design Consultation</option>
            <option>Site Supervision</option>
            <option>Transportation</option>
            <option>Miscellaneous</option>
        </datalist>

        <script>
            // ========== GLOBAL STATE & CONFIGURATION ==========
            const { jsPDF } = window.jspdf;

            let app = {
                budget: 0,
                projectName: 'Casa Eden',
                userName: 'Project Manager',
                projectAddress: '',
                projectTimeline: '6 months',
                paymentSources: ['Self', 'Spouse', 'Parent', 'Bank Loan'],
                expenses: [],
                contractors: [],
                components: [],
                faults: [],
                notes: [],
                theme: 'purple',
                currency: '₹',
                dateFormat: 'en-IN'
            };

            let currentDate = new Date();
            let selectedDate = new Date().toISOString().split('T')[0];
            let currentCharts = {};
            let timelineFilter = 'all';

            // ========== USER & PROJECT MANAGEMENT ==========
            const UserManager = {
                currentUser: null,

                // Helper methods for role-based access control
                isAdmin() {
                    return this.currentUser?.role === 'admin';
                },

                canEdit(resourceOwnerId = null) {
                    if (this.isAdmin()) return true;
                    if (!this.currentUser?.permissions?.canEdit) return false;
                    // Normal users can only edit their own resources
                    if (resourceOwnerId) return this.currentUser.id === resourceOwnerId;
                    return true;
                },

                canDelete(resourceOwnerId = null) {
                    if (this.isAdmin()) return true;
                    if (!this.currentUser?.permissions?.canDelete) return false;
                    // Normal users can only delete their own resources
                    if (resourceOwnerId) return this.currentUser.id === resourceOwnerId;
                    return true;
                },

                async hashPassword(password) {
                    // Simple hash for demo - in production use proper bcrypt or similar
                    const encoder = new TextEncoder();
                    const data = encoder.encode(password);
                    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                    const hashArray = Array.from(new Uint8Array(hashBuffer));
                    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                },

                async login(username, password) {
                    if (!SupabaseBackup.client) {
                        showNotification('Database not connected', 'error');
                        return false;
                    }

                    const passwordHash = await this.hashPassword(password);

                    // Query users table with project data
                    const { data, error } = await SupabaseBackup.client
                        .from('users')
                        .select(`
                            id, 
                            username, 
                            email, 
                            role, 
                            permissions,
                            project:projects(project_name, shared_unique_key)
                        `)
                        .eq('username', username)
                        .eq('password_hash', passwordHash)
                        .single();

                    if (error || !data) {
                        // Fallback for demo: allow admin/admin123 and user/user123
                        if (username === 'admin' && password === 'admin123') {
                            const adminUser = {
                                id: 'demo-admin-id',
                                username: 'admin',
                                email: 'admin@demo.com',
                                role: 'admin',
                                permissions: { canEdit: true, canDelete: true },
                                project: { project_name: 'Demo Project', shared_unique_key: 'DEMO-KEY' }
                            };
                            this.currentUser = adminUser;
                            console.log('Admin demo login - User data:', adminUser);
                            this.initSession(adminUser);
                            return true;
                        } else if (username === 'user' && password === 'user123') {
                            const normalUser = {
                                id: 'demo-user-id',
                                username: 'user',
                                email: 'user@demo.com',
                                role: 'user',
                                permissions: { canEdit: true, canDelete: true },
                                project: { project_name: 'User Project', shared_unique_key: 'USER-KEY' }
                            };
                            this.currentUser = normalUser;
                            console.log('User demo login - User data:', normalUser);
                            this.initSession(normalUser);
                            return true;
                        }
                        console.error('Login failed:', error);
                        return false;
                    }

                    this.currentUser = data;
                    console.log('Database login successful - User data:', data);
                    this.initSession(data);
                    return true;
                },

                // Initialize Session after Login
                initSession(user) {
                    // Use passed user or fallback to currentUser
                    const sessionUser = user || this.currentUser;
                    if (!sessionUser) return;

                    // Store as currentUser if not already set
                    if (!this.currentUser) this.currentUser = sessionUser;

                    // Update Global State
                    app.userName = sessionUser.username;
                    // Use shared key if available for project ID, otherwise use username-project combo
                    SupabaseBackup.PROJECT_ID = sessionUser.project?.shared_unique_key || sessionUser.project?.project_name || sessionUser.username + '_project';
                    app.projectName = sessionUser.project?.project_name || 'My Interior Project';

                    // UI Updates
                    const userNameEl = document.getElementById('userNameDisplay');
                    const projectNameEl = document.getElementById('projectNameDisplay');
                    const displayNameEl = document.getElementById('displayActualName');
                    const displayProjectEl = document.getElementById('displayProjectName');

                    console.log('initSession - Updating UI elements:');
                    console.log('  - sessionUser.username:', sessionUser.username);
                    console.log('  - app.projectName:', app.projectName);
                    console.log('  - displayNameEl exists:', !!displayNameEl);
                    console.log('  - displayProjectEl exists:', !!displayProjectEl);

                    if (userNameEl) userNameEl.innerText = sessionUser.username;
                    if (projectNameEl) projectNameEl.innerText = app.projectName;
                    if (displayNameEl) {
                        displayNameEl.innerText = sessionUser.username;
                        console.log('  - Set displayActualName to:', sessionUser.username);
                    }
                    if (displayProjectEl) {
                        displayProjectEl.innerText = app.projectName;
                        console.log('  - Set displayProjectName to:', app.projectName);
                    }

                    // Update password change section username
                    const passwordChangeUsernameEl = document.getElementById('passwordChangeUsername');
                    if (passwordChangeUsernameEl) {
                        passwordChangeUsernameEl.innerText = sessionUser.username;
                        console.log('  - Set passwordChangeUsername to:', sessionUser.username);
                    }

                    document.getElementById('loginOverlay').style.display = 'none';
                    document.getElementById('appContent').style.display = 'block';

                    // Apply UI visibility based on role
                    const userMgmtSection = document.getElementById('userManagementSection');
                    if (userMgmtSection) {
                        if (this.isAdmin()) {
                            userMgmtSection.style.display = 'block';
                            this.loadUsers(); // Load users for admin
                        } else {
                            userMgmtSection.style.display = 'none';
                        }
                    }

                    // Update role indicator in header
                    const roleDisplay = document.getElementById('displayUserRole');
                    if (roleDisplay) {
                        const roleText = this.isAdmin() ? 'ADMIN' : 'USER';
                        const roleColor = this.isAdmin() ? 'var(--success)' : 'var(--info)';
                        const roleIcon = this.isAdmin() ? 'fa-user-shield' : 'fa-user';
                        roleDisplay.innerHTML = `<i class="fas ${roleIcon}" style="color:${roleColor};"></i> <span style="color:white; font-weight:700;">${roleText}</span>`;
                    }

                    // Update current user type badge in profile settings
                    const userTypeBadge = document.getElementById('currentUserTypeBadge');
                    if (userTypeBadge) {
                        const roleText = this.isAdmin() ? 'ADMIN' : 'USER';
                        const badgeClass = this.isAdmin() ? 'badge-primary' : 'badge-secondary';
                        const roleIcon = this.isAdmin() ? 'fa-user-shield' : 'fa-user';
                        userTypeBadge.className = `badge ${badgeClass}`;
                        userTypeBadge.innerHTML = `<i class="fas ${roleIcon}"></i> <span style="color:white;">${roleText}</span>`;
                    }

                    // Show password toggle for admin in user modal
                    if (this.isAdmin()) {
                        const toggleBtn = document.getElementById('toggleUserPassword');
                        if (toggleBtn) toggleBtn.style.display = 'block';
                    }

                    // Apply profile field restrictions for normal users
                    this.applyProfileRestrictions();

                    // SAVE user context for reload persistence
                    localStorage.setItem("ibp_last_user", JSON.stringify(sessionUser));
                    localStorage.setItem('ibp_logged_in', 'true');

                    // Load Data
                    if (typeof SupabaseBackup !== 'undefined' && SupabaseBackup.autoLoadFromCloud) {
                        SupabaseBackup.autoLoadFromCloud();
                    }
                },

                // Apply profile field restrictions based on user role
                applyProfileRestrictions() {
                    if (!this.currentUser) return;

                    const isAdmin = this.isAdmin();
                    const profileFields = ['setProjectName', 'setUserName', 'setProjectAddress', 'setProjectTimeline'];

                    profileFields.forEach(fieldId => {
                        const field = document.getElementById(fieldId);
                        if (field) {
                            if (!isAdmin) {
                                // Normal users can edit their profile but with some restrictions
                                field.classList.add('user-editable');
                            } else {
                                field.classList.remove('user-editable');
                            }
                        }
                    });
                },

                async loadUsers() {
                    if (this.currentUser?.role !== 'admin') return;

                    const { data: users, error } = await SupabaseBackup.client
                        .from('users')
                        .select(`
                            *,
                            projects (project_name, shared_unique_key)
                        `)
                        .order('created_at');

                    if (error) {
                        showNotification('Failed to load users: ' + error.message, 'error');
                        return;
                    }

                    this.renderUserTable(users || []);
                },

                renderUserTable(users) {
                    const tbody = document.getElementById('usersTableBody');
                    if (!tbody) return;

                    const isAdmin = this.isAdmin();

                    tbody.innerHTML = users.map((user, index) => `
                        <tr>
                            <td>
                                <div style="display:flex; align-items:center; gap:8px;">
                                    <i class="fas fa-user-circle" style="font-size:20px; color:var(--primary);"></i>
                                    <div>
                                        <div style="font-weight:600;">${user.username || 'N/A'}</div>
                                        <div style="font-size:11px; opacity:0.7;">${user.email || ''}</div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="badge ${user.role === 'admin' ? 'badge-primary' : 'badge-secondary'}" style="text-transform:uppercase;">
                                    <i class="fas ${user.role === 'admin' ? 'fa-user-shield' : 'fa-user'}"></i>
                                    ${user.role || 'user'}
                                </span>
                            </td>
                            <td>${user.projects?.project_name || (user.projects && user.projects[0] ? user.projects[0].project_name : 'No Project')}</td>
                            <td>
                                <code style="background:rgba(255,255,255,0.1); padding:4px 8px; border-radius:4px; font-size:11px;">
                                    ${user.projects?.shared_unique_key || (user.projects && user.projects[0] ? user.projects[0].shared_unique_key : 'N/A')}
                                </code>
                            </td>
                            <td>
                                ${isAdmin ? `
                                    <div style="display:flex; align-items:center; gap:8px;">
                                        <input type="password" id="userPwd_${index}" value="********" readonly 
                                            style="width:120px; padding:4px 8px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); border-radius:4px; color:var(--text-light); font-size:11px;">
                                        <button class="btn-icon btn-info" onclick="toggleUserPasswordInTable('userPwd_${index}')" title="Show/Hide Password" style="padding:4px 8px;">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                ` : '<span style="opacity:0.5; font-size:11px;">Hidden</span>'}
                            </td>
                            <td>
                                ${isAdmin ? `
                                    <button class="btn-icon btn-primary" onclick="UserManager.editUser('${user.id}')" title="Edit User">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    ${user.role !== 'admin' ? `
                                        <button class="btn-icon btn-danger" onclick="UserManager.deleteUser('${user.id}')" title="Delete User">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    ` : '<span style="opacity:0.5; font-size:11px;">Protected</span>'}
                                ` : '<span style="opacity:0.5;">No Access</span>'}
                            </td>
                        </tr>
                    `).join('');
                },

                openUserModal() {
                    document.getElementById('userId').value = '';
                    document.getElementById('userUsername').value = '';
                    document.getElementById('userEmail').value = '';
                    document.getElementById('userPassword').value = '';
                    document.getElementById('userProject').value = '';
                    document.getElementById('userSharedKey').value = '';
                    openModal('userModal');
                },

                async editUser(id) {
                    const { data: user, error } = await SupabaseBackup.client
                        .from('users')
                        .select('*, projects(*)')
                        .eq('id', id)
                        .single();

                    if (user) {
                        document.getElementById('userId').value = user.id;
                        document.getElementById('userUsername').value = user.username;
                        document.getElementById('userEmail').value = user.email;
                        document.getElementById('userRole').value = user.role;
                        document.getElementById('userProject').value = user.projects?.[0]?.project_name || '';
                        document.getElementById('userSharedKey').value = user.projects?.[0]?.shared_unique_key || '';
                        openModal('userModal');
                    }
                },

                async saveUser(e) {
                    e.preventDefault();
                    const id = document.getElementById('userId').value;
                    const username = document.getElementById('userUsername').value;
                    const email = document.getElementById('userEmail').value;
                    const password = document.getElementById('userPassword').value;
                    const role = document.getElementById('userRole').value;
                    const projectName = document.getElementById('userProject').value;
                    const sharedKey = document.getElementById('userSharedKey').value;

                    try {
                        let userId = id;

                        // 1. Create/Update User
                        const userPayload = { username, email, role };
                        if (password) {
                            userPayload.password_hash = await this.hashPassword(password);
                        }

                        if (id) {
                            await SupabaseBackup.client.from('users').update(userPayload).eq('id', id);
                        } else {
                            if (!password) throw new Error('Password required for new users');
                            const { data, error } = await SupabaseBackup.client.from('users').insert([userPayload]).select().single();
                            if (error) throw error;
                            userId = data.id;
                        }

                        // 2. Update Project
                        if (projectName) {
                            const projectPayload = {
                                user_id: userId,
                                project_name: projectName,
                                shared_unique_key: sharedKey || null
                            };

                            // Upsert project (assuming 1 project per user for now)
                            // First check if project exists for user
                            const { data: existing } = await SupabaseBackup.client.from('projects').select('project_id').eq('user_id', userId).single();

                            if (existing) {
                                await SupabaseBackup.client.from('projects').update(projectPayload).eq('project_id', existing.project_id);
                            } else {
                                await SupabaseBackup.client.from('projects').insert([projectPayload]);
                            }
                        }

                        closeModal('userModal');
                        showNotification('User saved successfully', 'success');
                        this.loadUsers();

                    } catch (err) {
                        console.error('Save error:', err);
                        showNotification('Error: ' + err.message, 'error');
                    }
                },

                async deleteUser(id) {
                    if (!confirm('Delete this user and their project link?')) return;
                    await SupabaseBackup.client.from('users').delete().eq('id', id);
                    this.loadUsers();
                }
            };

            // Global Login Handler
            async function handleLogin(e) {
                e.preventDefault();
                const btn = e.target.querySelector('button');
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';

                const u = document.getElementById('loginUsername').value;
                const p = document.getElementById('loginPassword').value;

                if (await UserManager.login(u, p)) {
                    // Success handled in initSession
                } else {
                    document.getElementById('loginError').style.display = 'block';
                    btn.innerHTML = originalHtml;
                }
            }


            // ========== SUPABASE CLOUD BACKUP SYSTEM ==========
            const SupabaseBackup = {
                // ⚠️ REPLACE THESE WITH YOUR SUPABASE CREDENTIALS
                SUPABASE_URL: 'https://dujxruuoebpmextqtnpw.supabase.co',
                SUPABASE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR1anhydXVvZWJwbWV4dHF0bnB3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4NzgyMjksImV4cCI6MjA4NjQ1NDIyOX0.bt6fbwZtutTvrnOQH9RgpVHqvT4ddpn4eL-EvfbL7zI',
                TABLE_NAME: 'backups',
                PROJECT_ID: null, // This will be dynamically set
                client: null,
                isConnected: false,

                // Initialize the Supabase client
                init() {
                    try {
                        if (this.SUPABASE_URL.includes('YOUR_SUPABASE') || this.SUPABASE_KEY.includes('YOUR_SUPABASE')) {
                            console.warn('☁️ Supabase credentials not configured. Cloud backup disabled.');
                            this.updateStatus(false, 'Not Configured');
                            return;
                        }
                        if (typeof supabase !== 'undefined' && supabase.createClient) {
                            this.client = supabase.createClient(this.SUPABASE_URL, this.SUPABASE_KEY);
                            console.log('☁️ Supabase client initialized');
                            // Loaded manually viaUserManager
                            this.updateStatus(true, 'Ready');
                        } else {
                            console.warn('☁️ Supabase library not loaded');
                            this.updateStatus(false, 'Library Error');
                        }
                    } catch (err) {
                        console.error('☁️ Supabase init error:', err);
                        this.updateStatus(false, 'Init Error');
                    }
                },

                // Update the connection status indicator
                updateStatus(connected, text) {
                    this.isConnected = connected;
                    const statusText = text || (connected ? 'Connected' : 'Disconnected');

                    // Update Header Indicators
                    const hDot = document.getElementById('headerCloudStatusDot');
                    const hLabel = document.getElementById('headerCloudStatusText');
                    if (hDot) hDot.classList.toggle('connected', connected);
                    if (hLabel) hLabel.textContent = statusText;

                    // Update Settings Indicators
                    const sDot = document.getElementById('settingsCloudStatusDot');
                    const sLabel = document.getElementById('settingsCloudStatusText');
                    if (sDot) sDot.classList.toggle('connected', connected);
                    if (sLabel) sLabel.textContent = statusText;
                },

                // Test the Supabase connection
                async testConnection(silent = false) {
                    if (!this.client) {
                        if (!silent) showNotification('Supabase not configured. Please add your credentials.', 'error');
                        this.updateStatus(false, 'Not Configured');
                        return false;
                    }
                    try {
                        const { data, error } = await this.client
                            .from(this.TABLE_NAME)
                            .select('id')
                            .limit(1);
                        if (error) throw error;
                        this.updateStatus(true, 'Connected');
                        if (!silent) showNotification('☁️ Cloud connection successful!', 'success');
                        console.log('☁️ Connection test passed');
                        return true;
                    } catch (err) {
                        console.error('☁️ Connection test failed:', err);
                        this.updateStatus(false, 'Disconnected');
                        if (!silent) showNotification('☁️ Cloud connection failed: ' + err.message, 'error');
                        return false;
                    }
                },

                // Save current app data to cloud
                async saveToCloud() {
                    if (!this.client) {
                        showNotification('Cloud not configured. Add Supabase credentials first.', 'error');
                        return;
                    }
                    const btn = document.getElementById('btnSaveCloud');
                    const original = btn ? btn.innerHTML : '';
                    try {
                        if (btn) {
                            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                            btn.disabled = true;
                        }
                        saveData(); // Ensure latest local data is saved first

                        // Get current user info
                        const currentUser = UserManager.currentUser;
                        const userId = currentUser?.id || null;
                        const userName = currentUser?.username || 'Unknown';

                        const backupPayload = {
                            project_name: this.PROJECT_ID,
                            backup_data: { ...app, cloudBackupDate: new Date().toISOString() },
                            backup_size: JSON.stringify(app).length,
                            version: '2.0',
                            created_by_user_id: userId,
                            created_by_name: userName,
                            project_id: currentUser?.project?.project_id || null
                        };
                        const { data, error } = await this.client
                            .from(this.TABLE_NAME)
                            .insert([backupPayload])
                            .select();
                        if (error) throw error;
                        showNotification('☁️ Data saved to cloud successfully!', 'success');
                        console.log('☁️ Cloud backup saved:', data);
                    } catch (err) {
                        console.error('☁️ Cloud save error:', err);
                        showNotification('☁️ Cloud save failed: ' + err.message, 'error');
                    } finally {
                        if (btn) {
                            btn.innerHTML = original;
                            btn.disabled = false;
                        }
                    }
                },

                // Get all backups from cloud (filtered by user role)
                async getBackups() {
                    if (!this.client) return [];
                    try {
                        const currentUser = UserManager.currentUser;
                        const isAdmin = UserManager.isAdmin();

                        let query = this.client
                            .from(this.TABLE_NAME)
                            .select('id, created_at, project_name, backup_size, version, created_by_name, created_by_user_id');

                        // Admin sees all backups, normal users see only their own
                        if (!isAdmin && currentUser?.id) {
                            query = query.eq('created_by_user_id', currentUser.id);
                        }

                        const { data, error } = await query.order('created_at', { ascending: false });

                        if (error) throw error;
                        return data || [];
                    } catch (err) {
                        console.error('☁️ Failed to fetch backups:', err);
                        return [];
                    }
                },

                // Restore the most recent backup
                async restoreLatest() {
                    if (!this.client) {
                        showNotification('Cloud not configured.', 'error');
                        return;
                    }
                    if (!confirm('Restore latest cloud backup? This will overwrite your current data.')) return;
                    const btn = document.getElementById('btnRestoreLatest');
                    const original = btn ? btn.innerHTML : '';
                    try {
                        if (btn) {
                            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Restoring...';
                            btn.disabled = true;
                        }
                        const { data, error } = await this.client
                            .from(this.TABLE_NAME)
                            .select('*')
                            .eq('project_name', this.PROJECT_ID)
                            .order('created_at', { ascending: false })
                            .limit(1)
                            .single();
                        if (error) throw error;
                        if (!data || !data.backup_data) {
                            showNotification('No cloud backups found.', 'error');
                            return;
                        }
                        this._applyBackup(data.backup_data);
                        showNotification('☁️ Latest cloud backup restored!', 'success');
                    } catch (err) {
                        console.error('☁️ Restore error:', err);
                        showNotification('☁️ Restore failed: ' + err.message, 'error');
                    } finally {
                        if (btn) {
                            btn.innerHTML = original;
                            btn.disabled = false;
                        }
                    }
                },

                // Restore a specific backup by ID
                async restoreBackup(id) {
                    if (!confirm('Restore this backup? Current data will be overwritten.')) return;
                    try {
                        const { data, error } = await this.client
                            .from(this.TABLE_NAME)
                            .select('backup_data')
                            .eq('id', id)
                            .single();
                        if (error) throw error;
                        if (!data || !data.backup_data) {
                            showNotification('Backup data not found.', 'error');
                            return;
                        }
                        this._applyBackup(data.backup_data);
                        this.closeManager();
                        showNotification('☁️ Backup restored successfully!', 'success');
                    } catch (err) {
                        console.error('☁️ Restore error:', err);
                        showNotification('☁️ Restore failed: ' + err.message, 'error');
                    }
                },

                // Delete a specific backup
                async deleteBackup(id) {
                    if (!confirm('Delete this cloud backup? This cannot be undone.')) return;
                    try {
                        const { error } = await this.client
                            .from(this.TABLE_NAME)
                            .delete()
                            .eq('id', id);
                        if (error) throw error;
                        showNotification('☁️ Backup deleted.', 'info');
                        this.openManager(); // Refresh the list
                    } catch (err) {
                        console.error('☁️ Delete error:', err);
                        showNotification('☁️ Delete failed: ' + err.message, 'error');
                    }
                },

                // Apply backup data to the app
                _applyBackup(backupData) {
                    app = {
                        budget: backupData.budget || 0,
                        projectName: backupData.projectName || 'Interior Budget Pro',
                        userName: backupData.userName || 'Project Manager',
                        projectAddress: backupData.projectAddress || '',
                        projectTimeline: backupData.projectTimeline || '6 months',
                        paymentSources: backupData.paymentSources || ['Self'],
                        expenses: backupData.expenses || [],
                        contractors: backupData.contractors || [],
                        components: backupData.components || [],
                        planning: backupData.planning || {
                            electricity: [],
                            furniture: [],
                            pop: [],
                            painter: [],
                            custom: []
                        },
                        faults: backupData.faults || [],
                        notes: backupData.notes || [],
                        theme: backupData.theme || 'purple',
                        currency: backupData.currency || '₹',
                        dateFormat: backupData.dateFormat || 'en-IN'
                    };
                    saveData();
                    setTheme(app.theme);
                    updateDisplays();
                    populateSelects();
                    renderAll();
                },

                // Open backup manager modal
                async openManager() {
                    const modal = document.getElementById('backupManagerModal');
                    const content = document.getElementById('backupManagerContent');
                    if (!modal || !content) return;
                    modal.classList.add('active');
                    content.innerHTML = '<p style="text-align:center; opacity:0.6; padding:40px;"><i class="fas fa-spinner fa-spin" style="font-size:24px;"></i><br>Loading backups...</p>';
                    const backups = await this.getBackups();
                    if (backups.length === 0) {
                        content.innerHTML = '<p style="text-align:center; opacity:0.6; padding:40px;"><i class="fas fa-cloud-upload-alt" style="font-size:48px; opacity:0.3;"></i><br><br>No cloud backups found.<br><small>Create your first backup from the Settings tab.</small></p>';
                        return;
                    }

                    const isAdmin = UserManager.isAdmin();

                    let html = `
                        <div class="table-wrap">
                            <table style="width:100%;">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Project</th>
                                        ${isAdmin ? '<th>Username</th>' : ''}
                                        <th>Size</th>
                                        <th>Version</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    backups.forEach(b => {
                        const date = new Date(b.created_at).toLocaleString();
                        const size = ((b.backup_size || 0) / 1024).toFixed(2) + ' KB';
                        const username = b.created_by_name || 'Unknown';
                        html += `
                            <tr>
                                <td>${date}</td>
                                <td>${b.project_name || '-'}</td>
                                ${isAdmin ? `<td><span class="badge badge-inprogress">${username}</span></td>` : ''}
                                <td>${size}</td>
                                <td>${b.version || '1.0'}</td>
                                <td>
                                    <button class="btn-icon btn-restore" onclick="SupabaseBackup.restoreBackup('${b.id}')" title="Restore">
                                        <i class="fas fa-cloud-download-alt"></i>
                                    </button>
                                    <button class="btn-icon btn-primary" onclick="SupabaseBackup.exportBackup('${b.id}')" title="Export">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    <button class="btn-icon btn-delete" onclick="SupabaseBackup.deleteBackup('${b.id}')" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    content.innerHTML = html;
                },

                // Export a specific backup as JSON file
                async exportBackup(id) {
                    try {
                        const { data, error } = await this.client
                            .from(this.TABLE_NAME)
                            .select('*')
                            .eq('id', id)
                            .single();

                        if (error) throw error;
                        if (!data) {
                            showNotification('Backup not found.', 'error');
                            return;
                        }

                        // Create JSON file
                        const exportData = {
                            id: data.id,
                            created_at: data.created_at,
                            project_name: data.project_name,
                            backup_data: data.backup_data,
                            backup_size: data.backup_size,
                            version: data.version,
                            created_by_name: data.created_by_name,
                            created_by_user_id: data.created_by_user_id
                        };

                        const jsonString = JSON.stringify(exportData, null, 2);
                        const blob = new Blob([jsonString], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);

                        // Create download link
                        const a = document.createElement('a');
                        a.href = url;
                        const filename = `backup_${data.project_name || 'project'}_${new Date(data.created_at).toISOString().split('T')[0]}.json`;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);

                        showNotification('☁️ Backup exported successfully!', 'success');
                    } catch (err) {
                        console.error('☁️ Export error:', err);
                        showNotification('☁️ Export failed: ' + err.message, 'error');
                    }
                },

                // Close backup manager modal
                closeManager() {
                    const modal = document.getElementById('backupManagerModal');
                    if (modal) modal.classList.remove('active');
                },

                // Auto-load from cloud or local (sync logic)
                async autoLoadFromCloud() {
                    if (!this.PROJECT_ID) return;

                    const key = `ibp_${this.PROJECT_ID}`;
                    const localDataStr = localStorage.getItem(key);
                    const localDateStr = localStorage.getItem(key + '_lastSaved');
                    const localDate = localDateStr ? new Date(localDateStr).getTime() : 0;

                    let cloudDate = 0;
                    let cloudMeta = null;

                    showNotification('⏳ Syncing data...', 'info');

                    try {
                        if (this.client && this.isConnected) {
                            // 1. Check cloud timestamp
                            const { data: meta, error: metaError } = await this.client
                                .from(this.TABLE_NAME)
                                .select('id, created_at')
                                .eq('project_name', this.PROJECT_ID)
                                .order('created_at', { ascending: false })
                                .limit(1)
                                .single();

                            if (!metaError && meta) {
                                cloudMeta = meta;
                                cloudDate = new Date(meta.created_at).getTime();
                            }
                        }

                        // 2. Compare and Load
                        if (cloudDate > localDate) {
                            console.log('☁️ Cloud backup is newer — fetching full data...');
                            const { data, error } = await this.client
                                .from(this.TABLE_NAME)
                                .select('backup_data')
                                .eq('id', cloudMeta.id)
                                .single();

                            if (error || !data || !data.backup_data) throw new Error('Failed to fetch full backup content');

                            this._applyBackup(data.backup_data);
                            showNotification('☁️ Loaded latest data from cloud', 'success');

                        } else if (localDataStr) {
                            console.log('📂 Local data is newer or current — loading local');
                            const localData = JSON.parse(localDataStr);
                            this._applyBackup(localData);
                            // showNotification('📂 Loaded local data', 'success'); // Optional, maybe too noisy
                        } else {
                            console.log('⚠️ No data found. Starting fresh.');
                            showNotification('✨ New Project Started', 'info');
                            renderAll(); // Ensure empty state is rendered
                        }

                    } catch (err) {
                        console.error('☁️ Auto-load error:', err);
                        // Fallback to local
                        if (localDataStr) {
                            console.log('📂 Fallback to local data');
                            const localData = JSON.parse(localDataStr);
                            this._applyBackup(localData);
                            showNotification('📂 Loaded local data (Offline)', 'warning');
                        } else {
                            renderAll();
                        }
                    }
                }
            };


            // ========== INITIALIZATION UTILITIES ==========
            function initInteractiveElements() {
                // Initialize Header Clock
                updateHeaderClock();
                setInterval(updateHeaderClock, 1000);

                // Initialize progress slider
                const compProgress = document.getElementById('compProgress');
                if (compProgress) {
                    compProgress.addEventListener('input', function () {
                        const display = document.getElementById('compProgDisplay');
                        if (display) {
                            display.innerText = this.value + '%';
                            addPremiumClickEffect(display);
                        }
                    });
                }

                // Progress slider listener is already handled by oninput in HTML
                // (Optional: remove this if you want to rely purely on HTML oninput)
            }

            function initEventListeners() {
                // Button click animations
                document.addEventListener('click', function (e) {
                    const btn = e.target.closest('.btn');
                    if (btn) {
                        addPremiumClickEffect(btn);
                        // Icon animation
                        const icon = btn.querySelector('i');
                        if (icon) {
                            icon.classList.add('icon-pulse');
                            setTimeout(() => icon.classList.remove('icon-pulse'), 500);
                        }
                    }

                    // Nav tab animations
                    const navTab = e.target.closest('.nav-tab');
                    if (navTab && !navTab.classList.contains('active')) {
                        addPremiumClickEffect(navTab);
                    }
                });

                // Currency selector
                const currencySelect = document.getElementById('currencySymbol');
                if (currencySelect) {
                    currencySelect.value = app.currency;
                    currencySelect.addEventListener('change', function () {
                        app.currency = this.value;
                        saveData();
                        renderAll();
                        showNotification(`Currency set to ${this.value}`, 'info');
                    });
                }

                // Date format selector
                const dateFormatSelect = document.getElementById('dateFormat');
                if (dateFormatSelect) {
                    dateFormatSelect.value = app.dateFormat;
                    dateFormatSelect.addEventListener('change', function () {
                        app.dateFormat = this.value;
                        saveData();
                        renderAll();
                        showNotification('Date format updated', 'info');
                    });
                }
            }

            // ========== DATA MANAGEMENT ==========
            function saveData() {
                // Save all settings to the app object before storing
                if (document.getElementById('setProjectName')) {
                    app.projectName = document.getElementById('setProjectName').value.trim() || app.projectName;
                    app.userName = document.getElementById('setUserName').value.trim() || app.userName;
                    app.projectAddress = document.getElementById('setProjectAddress').value.trim() || app.projectAddress;
                    app.projectTimeline = document.getElementById('setProjectTimeline').value.trim() || app.projectTimeline;
                }

                if (document.getElementById('setPaymentSources')) {
                    const val = document.getElementById('setPaymentSources').value;
                    if (val.trim()) {
                        app.paymentSources = val.split(',').map(s => s.trim()).filter(s => s);
                    }
                }

                if (document.getElementById('currencySymbol')) {
                    app.currency = document.getElementById('currencySymbol').value;
                }

                if (document.getElementById('dateFormat')) {
                    app.dateFormat = document.getElementById('dateFormat').value;
                }

                // Save theme
                const bodyClass = document.body.className;
                const themeMatch = bodyClass.match(/theme-(\w+)/);
                if (themeMatch) {
                    app.theme = themeMatch[1];
                }

                // use dynamic key
                const key = SupabaseBackup.PROJECT_ID ? `ibp_${SupabaseBackup.PROJECT_ID}` : 'ibpultimate';
                localStorage.setItem(key, JSON.stringify(app));
                localStorage.setItem(key + '_lastSaved', new Date().toISOString());
            }

            function updateDisplays() {
                document.getElementById('projectNameDisplay').textContent = app.projectName;
                // NEW: Detailed Header Display
                const projName = document.getElementById('displayProjectName');
                const userRole = document.getElementById('displayUserRole');
                const actualName = document.getElementById('displayActualName');

                if (projName) projName.textContent = app.projectName || 'New Project';
                if (userRole) userRole.textContent = (localStorage.getItem('userRole') || 'Project Manager').toUpperCase();
                if (actualName) actualName.textContent = app.userName || 'User';

                // Settings form fields
                if (document.getElementById('setProjectName')) {
                    document.getElementById('setProjectName').value = app.projectName;
                    document.getElementById('setUserName').value = app.userName;
                    document.getElementById('setProjectAddress').value = app.projectAddress || '';
                    document.getElementById('setProjectTimeline').value = app.projectTimeline || '6 months';
                    document.getElementById('setPaymentSources').value = app.paymentSources.join(', ');
                    document.getElementById('currentSources').innerHTML = `<strong>Current Sources:</strong> ${app.paymentSources.join(', ')}`;
                }

                // Currency and date format selectors
                if (document.getElementById('currencySymbol')) {
                    document.getElementById('currencySymbol').value = app.currency || '₹';
                }

                if (document.getElementById('dateFormat')) {
                    document.getElementById('dateFormat').value = app.dateFormat || 'en-IN';
                }
            }
            function saveProfile() {
                app.projectName = document.getElementById('setProjectName').value.trim() || 'Interior Budget Pro';
                app.userName = document.getElementById('setUserName').value.trim() || 'Project Manager';
                app.projectAddress = document.getElementById('setProjectAddress').value.trim() || '';
                app.projectTimeline = document.getElementById('setProjectTimeline').value.trim() || '6 months';
                saveData();
                updateDisplays();
                showNotification('Profile saved successfully!', 'success');
            }

            function savePaymentSources() {
                const val = document.getElementById('setPaymentSources').value;
                app.paymentSources = val.split(',').map(s => s.trim()).filter(s => s);
                if (app.paymentSources.length === 0) app.paymentSources = ['Self'];
                saveData();
                updateDisplays();
                populateSelects();
                showNotification('Payment sources updated!', 'success');
            }

            function savePreferences() {
                app.currency = document.getElementById('currencySymbol').value;
                app.dateFormat = document.getElementById('dateFormat').value;
                saveData();
                showNotification('Preferences saved!', 'success');
            }

            // ========== NAVIGATION & VIEWS ==========
            function switchTab(id, el) {
                // Animation for tab switching
                document.querySelectorAll('.view-section').forEach(section => {
                    section.style.opacity = '0';
                    section.style.transform = 'translateY(20px)';
                    setTimeout(() => {
                        section.style.display = 'none';
                        section.style.opacity = '';
                        section.style.transform = '';
                    }, 300);
                });

                document.querySelectorAll('.nav-tab').forEach(x => x.classList.remove('active'));
                if (el) el.classList.add('active');

                setTimeout(() => {
                    const targetSection = document.getElementById(id);
                    targetSection.style.display = 'block';
                    targetSection.style.opacity = '0';
                    targetSection.style.transform = 'translateY(20px)';

                    setTimeout(() => {
                        targetSection.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                        targetSection.style.opacity = '1';
                        targetSection.style.transform = 'translateY(0)';
                    }, 10);
                }, 300);

                // Load specific tab content
                if (id === 'dashboard') {
                    renderDashboard();
                    renderRecentActivity();
                }
                if (id === 'reports') renderReports();
                if (id === 'payments') renderPayments();
                if (id === 'planning') renderPlanning();
            }

            // ========== RENDERING FUNCTIONS ==========
            function renderAll() {
                renderDashboard();
                renderRecentActivity();
                renderExpenses();
                renderContractors();
                renderPayments();
                renderComponents();
                renderFaults();
                renderPlanning();
                renderCalendar();
                renderTimeline();
                populateSelects();
                initTableSorting();
            }

            function renderDashboard() {
                // 1. CALCULATIONS
                const spent = app.expenses.reduce((a, b) => a + parseFloat(b.amount || 0), 0);
                const compProposed = app.components.reduce((a, b) => a + parseFloat(b.proposedCost || b.cost || 0), 0);
                const compActual = app.components.reduce((a, b) => a + parseFloat(b.actualCost || 0), 0);

                // Logic: Components do NOT affect Remaining Balance (per your request)
                const remain = app.budget - spent;
                const paymentPercent = app.budget > 0 ? ((spent / app.budget) * 100).toFixed(1) : 0;

                // Combined Total Spending (Labor + Materials)
                const totalSpending = spent + compActual;

                // 2. UPDATE STANDARD STATS
                document.getElementById('d-budget').innerText = `${app.currency}${parseFloat(app.budget).toLocaleString(app.dateFormat)}`;
                document.getElementById('d-spent').innerText = `${app.currency}${spent.toLocaleString(app.dateFormat)}`;
                document.getElementById('d-remain').innerText = `${app.currency}${remain.toLocaleString(app.dateFormat)}`;

                // 3. UPDATE TOTAL SPENDING CARD
                const totalSpendingEl = document.getElementById('d-combined-total');
                if (totalSpendingEl) {
                    totalSpendingEl.innerText = `${app.currency}${totalSpending.toLocaleString(app.dateFormat)}`;

                    const breakdownEl = document.getElementById('d-combined-breakdown');
                    if (breakdownEl) {
                        breakdownEl.innerHTML = `
                <span style="color: var(--primary); font-weight:600;">LABOR: ${app.currency}${spent.toLocaleString()}</span>
                <span style="color: var(--accent); font-weight:600;">COMPONENTS: ${app.currency}${compActual.toLocaleString()}</span>
            `;
                    }
                }

                // 4. COMPONENT CARD (Proposed vs Actual)
                const compTotalEl = document.getElementById('d-comp-total');
                if (compTotalEl) {
                    compTotalEl.innerText = `${app.currency}${compActual.toLocaleString(app.dateFormat)}`;
                    const compLabelEl = compTotalEl.nextElementSibling;
                    if (compLabelEl) {
                        const diff = compActual - compProposed;
                        const diffColor = diff > 0 ? '#ff0808' : '#10b981';
                        compLabelEl.innerHTML = `
                <div style="font-size: 11px; opacity: 0.8;">
                    Proposed: ${app.currency}${compProposed.toLocaleString()} 
                    <span style="color:${diffColor}; margin-left:5px;">(${diff > 0 ? '+' : ''}${diff.toLocaleString()})</span>
                </div>`;
                    }
                }

                // 5. PROGRESS BAR (Payment Only)
                const bar = document.getElementById('d-bar');
                if (bar) {
                    bar.style.width = Math.min(paymentPercent, 100) + '%';
                    bar.style.background = paymentPercent > 100
                        ? 'linear-gradient(90deg, var(--danger), color-mix(in srgb, var(--danger) 80%, black))'
                        : '';  // empty string falls back to the CSS class gradient
                }
                const dPercentLabel = document.getElementById('d-percent');
                if (dPercentLabel) {
                    dPercentLabel.innerHTML = `<span style="font-weight:700; color:var(--accent);">${paymentPercent}%</span> of Budget Used`;
                }

                // 6. QUICK STATS (Verified Fixed)
                const stats = {
                    'qs-contractors': app.contractors.length,
                    'qs-payments': app.expenses.length,
                    'qs-components': app.components.length,
                    'qs-faults': app.faults.filter(f => f.status !== 'Resolved').length
                };
                Object.keys(stats).forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.innerText = stats[id];
                });
            }

            function renderRecentActivity() {
                const container = document.getElementById('recentActivity');
                if (!container) return;

                const activities = [];

                // Get recent expenses (last 5)
                const recentExpenses = [...app.expenses]
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .slice(0, 5);

                recentExpenses.forEach(exp => {
                    activities.push({
                        type: 'expense',
                        date: exp.date,
                        title: `Payment to ${exp.contractor || 'Unknown'}`,
                        amount: exp.amount,
                        icon: '💰'
                    });
                });

                // Get recent faults
                const recentFaults = [...app.faults]
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .slice(0, 3);

                recentFaults.forEach(fault => {
                    activities.push({
                        type: 'fault',
                        date: fault.date,
                        title: `Fault reported with ${fault.contractor}`,
                        description: fault.desc,
                        icon: '⚠️'
                    });
                });

                // Sort by date
                activities.sort((a, b) => new Date(b.date) - new Date(a.date));

                if (activities.length === 0) {
                    container.innerHTML = '<p style="opacity:0.6; text-align:center; padding:40px;">No recent activity. Add your first expense!</p>';
                    return;
                }

                container.innerHTML = activities.map(activity => `
                <div style="display:flex; align-items:center; gap:16px; padding:16px; background:rgba(255,255,255,0.08); border-radius:12px; margin-bottom:12px; transition:var(--transition); cursor:pointer;" 
                     onclick="showActivityDetail('${activity.type}', '${activity.date}')"
                     onmouseover="this.style.transform='translateX(5px)'; this.style.background='rgba(255,255,255,0.12)'"
                     onmouseout="this.style.transform='translateX(0)'; this.style.background='rgba(255,255,255,0.08)'">
                    <div style="font-size:24px; width:50px; text-align:center;">${activity.icon}</div>
                    <div style="flex:1;">
                        <div style="font-weight:600; margin-bottom:4px;">${activity.title}</div>
                        <div style="font-size:13px; opacity:0.8;">${formatDate(activity.date)}</div>
                        ${activity.amount ? `<div style="font-weight:700; color:var(--success); margin-top:4px;">${app.currency}${parseFloat(activity.amount).toLocaleString(app.dateFormat)}</div>` : ''}
                    </div>
                </div>
            `).join('');
            }

            function formatDate(dateStr) {
                const date = new Date(dateStr);
                if (app.dateFormat === 'en-IN') {
                    return date.toLocaleDateString('en-IN');
                } else if (app.dateFormat === 'en-US') {
                    return date.toLocaleDateString('en-US');
                } else {
                    return dateStr;
                }
            }

            function populateSelects() {
                // Contractors for forms
                const contSelects = ['expContractor', 'faultContractor', 'compContractor'];
                const contractorOptions = app.contractors.map(c => `<option value="${c.name}">${c.name}</option>`).join('');

                contSelects.forEach(id => {
                    const sel = document.getElementById(id);
                    const extra = id === 'compContractor' ? '<option value="">None</option>' : '<option value="">Select...</option>';
                    sel.innerHTML = extra + contractorOptions;
                });

                // Payment Filter
                const payFilter = document.getElementById('paymentFilter');
                if (payFilter) {
                    const currentVal = payFilter.value;
                    payFilter.innerHTML = '<option value="all">Show All Transactions</option>' + contractorOptions;
                    payFilter.value = currentVal;
                }

                // Paid By
                const paidSel = document.getElementById('expPaidBy');
                paidSel.innerHTML = app.paymentSources.map(p => `<option>${p}</option>`).join('');
            }

            // ========== CRUD OPERATIONS FOR EXPENSES ==========
            function saveExpense(e) {
                e.preventDefault();
                const id = document.getElementById('expId').value || Date.now();
                const data = {
                    id: parseInt(id),
                    date: document.getElementById('expDate').value,
                    amount: parseFloat(document.getElementById('expAmount').value),
                    contractor: document.getElementById('expContractor').value || '',
                    workType: document.getElementById('expWorkType').value || 'General',
                    category: document.getElementById('expCategory').value,
                    paidBy: document.getElementById('expPaidBy').value,
                    mode: document.getElementById('expMode').value,
                    status: document.getElementById('expStatus').value,
                    notes: document.getElementById('expNotes').value || ''
                };
                const idx = app.expenses.findIndex(x => x.id === data.id);
                if (idx > -1) app.expenses[idx] = data;
                else app.expenses.push(data);
                saveData();
                renderAll();
                closeModal('expenseModal');
                showNotification('Expense saved successfully!', 'success');
            }

            function editExpense(id) {
                const e = app.expenses.find(x => x.id === id);
                if (!e) return;
                document.getElementById('expId').value = e.id;
                document.getElementById('expDate').value = e.date;
                document.getElementById('expAmount').value = e.amount;
                document.getElementById('expContractor').value = e.contractor;
                document.getElementById('expWorkType').value = e.workType;
                document.getElementById('expCategory').value = e.category;
                document.getElementById('expPaidBy').value = e.paidBy;
                document.getElementById('expMode').value = e.mode;
                document.getElementById('expStatus').value = e.status;
                document.getElementById('expNotes').value = e.notes || '';
                openModal('expenseModal');
            }

            function deleteExpense(id) {
                if (confirm('Delete this expense?')) {
                    app.expenses = app.expenses.filter(x => x.id !== id);
                    saveData();
                    renderAll();
                    showNotification('Expense deleted!', 'success');
                }
            }
            function duplicateExpense(id) {
                const originalExpense = app.expenses.find(x => x.id === id);
                if (!originalExpense) return;

                // Create a copy with new ID and current date
                const duplicate = {
                    ...originalExpense,
                    id: Date.now() + Math.floor(Math.random() * 1000), // New unique ID
                    date: new Date().toISOString().split('T')[0], // Today's date
                    status: 'Pending', // Reset status to pending
                    notes: originalExpense.notes ? `${originalExpense.notes} (Copy)` : 'Duplicate transaction'
                };

                app.expenses.push(duplicate);
                saveData();
                renderExpenses();
                renderDashboard();
                renderPayments();
                showNotification('Expense duplicated successfully!', 'success');

                // Scroll to the top of the table to see the new duplicate
                const table = document.getElementById('expensesTable');
                if (table) {
                    table.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
            function duplicateFromModal() {
                const id = document.getElementById('expId').value;
                if (!id) return;

                duplicateExpense(parseInt(id));
                closeModal('expenseModal');
            }

            function addExpense() {
                document.getElementById('expenseForm').reset();
                document.getElementById('expId').value = '';
                document.getElementById('expDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('duplicateFromModal').style.display = 'none';
                openModal('expenseModal');
            }

            // Update editExpense function to show duplicate button
            function editExpense(id) {
                const e = app.expenses.find(x => x.id === id);
                if (!e) return;
                document.getElementById('expId').value = e.id;
                document.getElementById('expDate').value = e.date;
                document.getElementById('expAmount').value = e.amount;
                document.getElementById('expContractor').value = e.contractor;
                document.getElementById('expWorkType').value = e.workType;
                document.getElementById('expCategory').value = e.category;
                document.getElementById('expPaidBy').value = e.paidBy;
                document.getElementById('expMode').value = e.mode;
                document.getElementById('expStatus').value = e.status;
                document.getElementById('expNotes').value = e.notes || '';

                // Show duplicate button in modal
                document.getElementById('duplicateFromModal').style.display = 'inline-flex';

                openModal('expenseModal');
            }

            // Update the modal opening for new expenses to hide duplicate button
            // ========== MODAL FUNCTIONS ==========
            function openModal(id, isEdit = false) {
                document.getElementById(id).classList.add('active');
                if (!isEdit) {
                    if (id === 'expenseModal') {
                        document.getElementById('expDate').value = new Date().toISOString().split('T')[0];
                        document.getElementById('expId').value = '';
                        document.getElementById('duplicateFromModal').style.display = 'none';
                    }
                    if (id === 'contractorModal') {
                        document.getElementById('contractorForm').reset();
                        document.getElementById('contId').value = '';
                        document.getElementById('contBudget').value = 0;
                        document.getElementById('contRating').value = 0;
                        setContractorRating(0);
                    }
                    if (id === 'componentModal') {
                        document.getElementById('componentForm').reset();
                        document.getElementById('compDate').value = new Date().toISOString().split('T')[0];
                        document.getElementById('compProgress').value = 0;
                        document.getElementById('compProgDisplay').innerText = '0%';
                        document.getElementById('newContractorDetails').style.display = 'block';
                    }
                    if (id === 'faultModal') {
                        document.getElementById('faultDate').value = new Date().toISOString().split('T')[0];
                    }
                }
            }

            function closeModal(id) {
                document.getElementById(id).classList.remove('active');
            }
            // ========== CRUD OPERATIONS FOR CONTRACTORS ==========
            function saveContractor(e) {
                e.preventDefault();
                const id = document.getElementById('contId').value || Date.now();
                const newName = document.getElementById('contName').value.trim();
                const data = {
                    id: parseInt(id),
                    name: newName,
                    role: document.getElementById('contRole').value.trim(),
                    phone: document.getElementById('contPhone').value.trim(),
                    email: document.getElementById('contEmail').value.trim() || '',
                    company: document.getElementById('contCompany').value.trim() || '',
                    budget: parseFloat(document.getElementById('contBudget').value || 0),
                    rating: parseInt(document.getElementById('contRating').value || 0),
                    details: document.getElementById('contDetails').value.trim() || ''
                };

                const idx = app.contractors.findIndex(x => x.id === data.id);
                if (idx > -1) {
                    const oldName = app.contractors[idx].name;
                    // Propagate name change if name has changed
                    if (oldName !== newName) {
                        app.expenses.forEach(exp => { if (exp.contractor === oldName) exp.contractor = newName; });
                        app.components.forEach(comp => { if (comp.contractor === oldName) comp.contractor = newName; });
                        app.faults.forEach(fault => { if (fault.contractor === oldName) fault.contractor = newName; });
                    }
                    app.contractors[idx] = data;
                } else {
                    app.contractors.push(data);
                }

                saveData();
                renderAll();
                closeModal('contractorModal');
                showNotification('Contractor saved successfully!', 'success');
            }

            function addContractor() {
                openModal('contractorModal', false);
            }

            function editContractor(id) {
                const c = app.contractors.find(x => x.id === id);
                if (!c) return;
                document.getElementById('contId').value = c.id;
                document.getElementById('contName').value = c.name;
                document.getElementById('contRole').value = c.role || '';
                document.getElementById('contPhone').value = c.phone || '';
                document.getElementById('contEmail').value = c.email || '';
                document.getElementById('contCompany').value = c.company || '';
                document.getElementById('contBudget').value = c.budget || 0;
                document.getElementById('contRating').value = c.rating || 0;
                setContractorRating(c.rating || 0);
                document.getElementById('contDetails').value = c.details || '';
                openModal('contractorModal', true);
            }

            function deleteContractor(id) {
                if (confirm('Delete contractor? (Expenses will remain)')) {
                    app.contractors = app.contractors.filter(x => x.id !== id);
                    saveData();
                    renderAll();
                    showNotification('Contractor deleted!', 'success');
                }
            }

            function renderContractors() {
                const grid = document.getElementById('contractorGrid');
                grid.innerHTML = app.contractors.map(c => {
                    const paid = app.expenses.filter(e => e.contractor === c.name).reduce((a, b) => a + parseFloat(b.amount || 0), 0);
                    const percent = c.budget > 0 ? ((paid / c.budget) * 100).toFixed(1) : 0;

                    let stars = '';
                    const rating = c.rating || 0;
                    for (let i = 1; i <= 5; i++) {
                        stars += `<i class="${i <= rating ? 'fas' : 'far'} fa-star" style="color:#f2d348; font-size:10px; text-shadow:0 0 5px rgba(242,211,72,0.3);"></i>`;
                    }

                    return `
<div class="glass-card contractor-card" 
     style="text-align:left; padding:24px; border-radius:22px; position:relative; overflow:hidden; border:1px solid rgba(255,255,255,0.15); box-shadow:0 15px 35px rgba(0,0,0,0.3); transition:all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1); cursor:default;"
     onmouseover="this.style.transform='translateY(-8px)'; this.style.borderColor='rgba(255,255,255,0.3)'; this.style.boxShadow='0 20px 45px rgba(0,0,0,0.4)';"
     onmouseout="this.style.transform='translateY(0)'; this.style.borderColor='rgba(255,255,255,0.15)'; this.style.boxShadow='0 15px 35px rgba(0,0,0,0.3)';"
>
    <div style="position:absolute; top:0; left:0; width:6px; height:100%; background:linear-gradient(to bottom, var(--primary), var(--secondary));"></div>
    
    <!-- Header Section: Responsive Name and Actions -->
    <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px; margin-bottom:18px;">
        <div style="flex:1; min-width:0;">
            <div style="display:flex; flex-direction:column; gap:4px;">
                <h3 style="margin:0; font-size:20px; font-weight:900; letter-spacing:-0.5px; line-height:1.2; word-break:break-word; color:white;">${c.name}</h3>
                <div style="display:flex; gap:3px; margin-top:2px;">${stars}</div>
            </div>
            
            <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:10px;">
                <span style="font-size:10px; font-weight:800; text-transform:uppercase; letter-spacing:1px; background:rgba(255,255,255,0.15); color:white; padding:3px 10px; border-radius:12px; backdrop-filter:blur(5px); border:1px solid rgba(255,255,255,0.1);">
                    ${c.role || 'Contractor'}
                </span>
                <span style="font-size:10px; font-weight:800; text-transform:uppercase; letter-spacing:1px; background:rgba(34,197,94,0.15); color:#4ade80; padding:3px 10px; border-radius:12px; border:1px solid rgba(34,197,94,0.2);">
                    ${app.currency}${paid.toLocaleString()} Paid
                </span>
            </div>
        </div>
        
        <div style="display:flex; gap:8px;">
            <button class="btn-icon btn-edit" onclick="editContractor(${c.id})" title="Edit" style="background:rgba(255,255,255,0.08); width:36px; height:36px; border-radius:10px; border:1px solid rgba(255,255,255,0.1);">
                <i class="fas fa-pen" style="font-size:13px;"></i>
            </button>
            <button class="btn-icon btn-delete" onclick="deleteContractor(${c.id})" title="Delete" style="background:rgba(239,68,68,0.08); color:#f87171; width:36px; height:36px; border-radius:10px; border:1px solid rgba(239,68,68,0.15);">
                <i class="fas fa-trash-alt" style="font-size:13px;"></i>
            </button>
        </div>
    </div>

    <!-- Contact Info Section -->
    <div style="display:grid; grid-template-columns:1fr; gap:8px; font-size:13px; opacity:0.8; margin-bottom:20px; background:rgba(0,0,0,0.1); padding:12px; border-radius:14px; border:1px solid rgba(255,255,255,0.05);">
        <div style="display:flex; align-items:center; gap:10px;">
            <i class="fas fa-phone-alt" style="width:16px; color:var(--info); font-size:12px;"></i>
            <a href="tel:${c.phone}" style="color:inherit; text-decoration:none; font-weight:600;">${c.phone || '-'}</a>
        </div>
        ${c.email ? `
        <div style="display:flex; align-items:center; gap:10px;">
            <i class="fas fa-envelope" style="width:16px; color:var(--info); font-size:12px;"></i>
            <a href="mailto:${c.email}" style="color:inherit; text-decoration:none; font-weight:500; font-size:12px; overflow:hidden; text-overflow:ellipsis;">${c.email}</a>
        </div>
        ` : ''}
    </div>
    
    <!-- Financial Overview Section -->
    <div style="background:rgba(255,255,255,0.03); padding:16px; border-radius:18px; border:1px solid rgba(255,255,255,0.08);">
        <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:12px;">
            <div style="display:flex; gap:20px;">
                <div style="display:flex; flex-direction:column;">
                    <span style="opacity:0.5; text-transform:uppercase; font-weight:800; font-size:9px; letter-spacing:0.5px;">Budget</span>
                    <span style="font-weight:800; color:var(--info); font-size:15px; margin-top:2px;">${app.currency}${parseFloat(c.budget).toLocaleString()}</span>
                </div>
                <div style="display:flex; flex-direction:column;">
                    <span style="opacity:0.5; text-transform:uppercase; font-weight:800; font-size:9px; letter-spacing:0.5px;">Paid</span>
                    <span style="font-weight:800; color:#4ade80; font-size:15px; margin-top:2px;">${app.currency}${paid.toLocaleString()}</span>
                </div>
            </div>
            
            <div style="display:flex; align-items:center; gap:12px;">
                <div style="width:1px; height:24px; background:rgba(255,255,255,0.1);"></div>
                <div style="display:flex; flex-direction:column; text-align:right;">
                    <span style="opacity:0.5; text-transform:uppercase; font-weight:800; font-size:9px; letter-spacing:0.5px;">Balance</span>
                    <span style="font-weight:800; color:${(c.budget - paid) < 0 ? '#f87171' : 'white'}; font-size:18px; line-height:1;">${app.currency}${(c.budget - paid).toLocaleString()}</span>
                </div>
            </div>
        </div>
        
        <div class="budget-bar-container" style="height:10px; margin-bottom:10px; background:rgba(255,255,255,0.1); border-radius:5px; overflow:hidden;">
            <div class="budget-bar-fill" style="width:${Math.min(percent, 100)}%; height:100%; background:linear-gradient(90deg, var(--primary), var(--secondary)); box-shadow:0 0 10px rgba(var(--primary-rgb), 0.5);"></div>
        </div>
        
        <div style="display:flex; justify-content:space-between; align-items:center; font-size:11px;">
            <span style="opacity:0.6; font-weight:600;">Utilization</span>
            <span style="font-weight:800; letter-spacing:0.5px; color:${percent > 90 ? '#f87171' : percent > 70 ? '#fbbf24' : '#4ade80'}">
                ${percent}% Used
            </span>
        </div>
    </div>
</div>`;
                }).join('');
            }

            function setContractorRating(rating) {
                document.getElementById('contRating').value = rating;
                const stars = document.querySelectorAll('#contractorModal .rating-star');
                stars.forEach((star, index) => {
                    if (index < rating) {
                        star.classList.replace('far', 'fas');
                    } else {
                        star.classList.replace('fas', 'far');
                    }
                });
            }

            // ========== CRUD OPERATIONS FOR COMPONENTS ==========
            function saveComponent(e) {
                e.preventDefault();

                const id = document.getElementById('compId').value || Date.now();
                const selectedContractor = document.getElementById('compContractor').value;
                const newName = document.getElementById('compNewContName').value.trim();
                const newPhone = document.getElementById('compNewContPhone').value.trim();

                // ✅ If "None" is selected and new contractor details are provided, use them
                let finalContractor = selectedContractor;
                if (selectedContractor === 'None' && newName) {
                    finalContractor = newName; // Use the new contractor name instead of "None"
                }

                const data = {
                    id: parseInt(id),
                    date: document.getElementById('compDate').value,
                    name: document.getElementById('compName').value.trim(),
                    category: document.getElementById('compCategory').value,
                    contractor: finalContractor, // ✅ This will be the new name if "None" was selected
                    newContName: newName, // ✅ Keep this for reference/editing
                    newContPhone: newPhone, // ✅ Keep this for reference
                    proposedCost: parseFloat(document.getElementById('compProposedCost').value) || 0,
                    actualCost: parseFloat(document.getElementById('compActualCost').value) || 0,
                    workType: document.getElementById('compWorkType').value,
                    progress: parseInt(document.getElementById('compProgress').value),
                    status: document.getElementById('compStatus').value
                };

                const idx = app.components.findIndex(x => x.id === data.id);
                if (idx > -1) {
                    app.components[idx] = data;
                } else {
                    app.components.push(data);
                }

                saveData();
                renderAll();
                closeModal('componentModal');
                showNotification('Component saved successfully!', 'success');
            }


            // ========== INITIAL PLANNING LOGIC ==========
            function renderPlanning() {
                const sections = ['electricity', 'furniture', 'pop', 'painter', 'custom'];
                sections.forEach(sec => {
                    const tbody = document.getElementById(`body-${sec}`);
                    if (!tbody) return;

                    const data = app.planning[sec] || [];
                    tbody.innerHTML = data.map((row, idx) => `
                        <tr id="row-${sec}-${idx}">
                            <td><input type="text" value="${row.name || ''}" onchange="updatePlanningField('${sec}', ${idx}, 'name', this.value)" placeholder="e.g. 10W LED"></td>
                            <td><input type="text" value="${row.part || ''}" onchange="updatePlanningField('${sec}', ${idx}, 'part', this.value)" placeholder="e.g. Hall Right"></td>
                            <td><input type="text" value="${row.units || ''}" onchange="updatePlanningField('${sec}', ${idx}, 'units', this.value)" placeholder="e.g. 5 Nos"></td>
                            <td><input type="text" value="${row.type || ''}" onchange="updatePlanningField('${sec}', ${idx}, 'type', this.value)" placeholder="e.g. Warm White"></td>
                            <td><input type="number" value="${row.proposed || 0}" onchange="updatePlanningField('${sec}', ${idx}, 'proposed', this.value)" style="width:100px;"></td>
                            <td><input type="number" value="${row.actual || 0}" onchange="updatePlanningField('${sec}', ${idx}, 'actual', this.value)" style="width:100px;"></td>
                            <td>
                                <button class="btn btn-icon-small btn-danger" onclick="deletePlanningRow('${sec}', ${idx})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');

                    if (data.length === 0) {
                        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; opacity:0.5; padding:20px;">No entries yet. Click "Add Row" to start.</td></tr>`;
                    }
                });
            }

            function addPlanningRow(section) {
                if (!app.planning[section]) app.planning[section] = [];
                app.planning[section].push({
                    name: '',
                    part: '',
                    units: '',
                    type: '',
                    proposed: 0,
                    actual: 0
                });
                renderPlanning();
                saveData();
            }

            function updatePlanningField(section, index, field, value) {
                if (!app.planning[section][index]) return;
                if (field === 'proposed' || field === 'actual') {
                    app.planning[section][index][field] = parseFloat(value) || 0;
                } else {
                    app.planning[section][index][field] = value;
                }
                saveData();
            }

            function deletePlanningRow(section, index) {
                if (confirm('Delete this row?')) {
                    app.planning[section].splice(index, 1);
                    renderPlanning();
                    saveData();
                }
            }

            function exportPlanningToPDF() {
                window.print();
            }

            function addComponent() {
                document.getElementById('componentForm').reset();
                document.getElementById('compId').value = '';
                document.getElementById('compDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('compProgDisplay').innerText = '0%';
                openModal('componentModal');
            }

            function editComponent(id) {
                const c = app.components.find(x => x.id === id);
                if (!c) return;
                document.getElementById('compId').value = c.id;
                document.getElementById('compDate').value = c.date;
                document.getElementById('compName').value = c.name;
                document.getElementById('compCategory').value = c.category;
                document.getElementById('compProposedCost').value = c.proposedCost || 0;
                document.getElementById('compActualCost').value = c.actualCost || 0;
                document.getElementById('compWorkType').value = c.workType || 'Installation';
                document.getElementById('compContractor').value = c.contractor || '';
                document.getElementById('compNewContName').value = c.newContName || '';
                document.getElementById('compNewContPhone').value = c.newContPhone || '';
                document.getElementById('compProgress').value = c.progress || 0;
                document.getElementById('compProgDisplay').innerText = (c.progress || 0) + '%';
                document.getElementById('compStatus').value = c.status || 'Not Started';

                toggleNewContractorFields();
                openModal('componentModal', true);
            }

            function toggleNewContractorFields() {
                const val = document.getElementById('compContractor').value;
                document.getElementById('newContractorDetails').style.display = (val === '' || val === 'None') ? 'block' : 'none';
            }

            function deleteComponent(id) {
                if (confirm('Delete component?')) {
                    app.components = app.components.filter(x => x.id !== id);
                    saveData();
                    renderAll();
                    showNotification('Component deleted!', 'success');
                }
            }

            function renderComponents() {
                const tbody = document.getElementById('componentTableBody');
                tbody.innerHTML = app.components.sort((a, b) => new Date(b.date) - new Date(a.date)).map(c => {
                    const statusClass = c.status === 'Completed' ? 'badge-completed' :
                        c.status === 'In Progress' ? 'badge-inprogress' : 'badge-pending';

                    const proposed = parseFloat(c.proposedCost || c.cost || 0);
                    const actual = parseFloat(c.actualCost || c.cost || 0);
                    const variance = actual - proposed;
                    const varianceColor = variance > 0 ? '#f87171' : (variance < 0 ? '#4ade80' : 'inherit');

                    return `
                <tr>
                    <td data-sort="${c.date}">${formatDate(c.date)}</td>
                    <td>
                        <div style="font-weight:800;">${c.name}</div>
                        <div style="font-size:10px; opacity:0.6;">${c.category} | ${c.workType || 'Job'}</div>
                    </td>
  <td>
  <div style="font-size:11px">${c.contractor || c.newContName}</div>
  ${c.newContPhone ? `<div style="font-size:9px;opacity:0.7">📞 ${c.newContPhone}</div>` : ''}
</td>



                    <td>${app.currency}${proposed.toLocaleString()}</td>
                    <td>
                        <div style="font-weight:700;">${app.currency}${actual.toLocaleString()}</div>
                        ${variance !== 0 ? `<div style="font-size:9px; color:${varianceColor};">${variance > 0 ? '+' : ''}${variance.toLocaleString()}</div>` : ''}
                    </td>
                    <td>
                        <div class="budget-bar-container" style="height:18px; position:relative;">
                            <div class="budget-bar-fill" style="width:${c.progress}%"></div>
                            <div style="position:absolute; width:100%; text-align:center; font-size:9px; font-weight:800; top:50%; transform:translateY(-50%);">${c.progress}%</div>
                        </div>
                    </td>
                    <td><span class="badge ${statusClass}">${c.status}</span></td>
                    <td style="white-space:nowrap;">
                        <button class="btn-icon btn-edit" onclick="editComponent(${c.id})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon btn-delete" onclick="deleteComponent(${c.id})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `}).join('');
            }

            // ========== CRUD OPERATIONS FOR FAULTS ==========
            function saveFault(e) {
                e.preventDefault();
                const id = document.getElementById('faultId').value || Date.now();
                const data = {
                    id: parseInt(id),
                    date: document.getElementById('faultDate').value,
                    contractor: document.getElementById('faultContractor').value,
                    desc: document.getElementById('faultDesc').value.trim(),
                    cost: parseFloat(document.getElementById('faultCost').value || 0),
                    status: document.getElementById('faultStatus').value
                };
                const idx = app.faults.findIndex(x => x.id === data.id);
                if (idx > -1) app.faults[idx] = data;
                else app.faults.push(data);
                saveData();
                renderAll();
                closeModal('faultModal');
                showNotification('Fault report saved!', 'success');
            }

            function addFault() {
                document.getElementById('faultForm').reset();
                document.getElementById('faultId').value = '';
                document.getElementById('faultDate').value = new Date().toISOString().split('T')[0];
                openModal('faultModal');
            }

            function editFault(id) {
                const f = app.faults.find(x => x.id === id);
                if (!f) return;
                document.getElementById('faultId').value = f.id;
                document.getElementById('faultDate').value = f.date;
                document.getElementById('faultContractor').value = f.contractor;
                document.getElementById('faultDesc').value = f.desc;
                document.getElementById('faultCost').value = f.cost || '';
                document.getElementById('faultStatus').value = f.status;
                openModal('faultModal');
            }

            function deleteFault(id) {
                if (confirm('Delete fault report?')) {
                    app.faults = app.faults.filter(x => x.id !== id);
                    saveData();
                    renderAll();
                    showNotification('Fault report deleted!', 'success');
                }
            }

            function renderFaults() {
                const tbody = document.getElementById('faultTableBody');
                tbody.innerHTML = app.faults.sort((a, b) => new Date(b.date) - new Date(a.date)).map(f => {
                    const statusClass = f.status === 'Resolved' ? 'badge-completed' :
                        (f.status === 'In Review' || f.status === 'In Progress' ? 'badge-inprogress' : 'badge-faulty');
                    return `
                <tr>
                    <td data-sort="${f.date}">${formatDate(f.date)}</td>
                    <td>${f.contractor}</td>
                    <td>${f.desc}</td>
                    <td>${app.currency}${parseFloat(f.cost || 0).toLocaleString(app.dateFormat)}</td>
                    <td><span class="badge ${statusClass}">${f.status}</span></td>
                    <td style="white-space:nowrap;">
                        <button class="btn-icon btn-edit" onclick="editFault(${f.id})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon btn-delete" onclick="deleteFault(${f.id})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `}).join('');
            }

            // ========== PAYMENTS VIEW ==========
            function renderPayments() {
                const filterName = document.getElementById('paymentFilter').value;
                const container = document.getElementById('paymentBarsContainer');
                const relevant = filterName === 'all' ? app.contractors : app.contractors.filter(c => c.name === filterName);

                const exportBtn = document.getElementById('btnExportContractorPDF');
                const whatsappBtn = document.getElementById('btnShareWhatsApp');
                if (exportBtn) exportBtn.style.display = filterName === 'all' ? 'none' : 'inline-flex';
                if (whatsappBtn) whatsappBtn.style.display = filterName === 'all' ? 'none' : 'inline-flex';

                container.innerHTML = relevant.map(c => {
                    const contractorTxs = app.expenses.filter(e => e.contractor === c.name);
                    const paid = contractorTxs.reduce((a, b) => a + parseFloat(b.amount || 0), 0);
                    const percent = c.budget > 0 ? ((paid / c.budget) * 100).toFixed(1) : 0;
                    const balance = c.budget - paid;

                    return `
                <div class="payment-summary-card" style="padding:20px; border-radius:18px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); margin-bottom:20px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h4 style="margin:0; font-size:18px; font-weight:800;">${c.name}</h4>
                        <span style="font-size:12px; font-weight:700; background:rgba(255,255,255,0.1); padding:4px 12px; border-radius:20px;">
                            ${percent}% Utilized
                        </span>
                    </div>

                    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(120px, 1fr)); gap:12px; margin-bottom:20px;">
                        <div style="background:rgba(255,255,255,0.05); padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                            <div style="font-size:10px; text-transform:uppercase; letter-spacing:1px; opacity:0.6; margin-bottom:4px; font-weight:700;">Allocated</div>
                            <div style="font-size:15px; font-weight:800; color:var(--info);">${app.currency}${parseFloat(c.budget).toLocaleString()}</div>
                        </div>
                        <div style="background:rgba(255,255,255,0.05); padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                            <div style="font-size:10px; text-transform:uppercase; letter-spacing:1px; opacity:0.6; margin-bottom:4px; font-weight:700;">Paid</div>
                            <div style="font-size:15px; font-weight:800; color:var(--success);">${app.currency}${paid.toLocaleString()}</div>
                        </div>
                        <div style="background:rgba(255,255,255,0.05); padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                            <div style="font-size:10px; text-transform:uppercase; letter-spacing:1px; opacity:0.6; margin-bottom:4px; font-weight:700;">Balance</div>
                            <div style="font-size:15px; font-weight:800; color:${balance < 0 ? 'var(--danger)' : '#f59e0b'};">${app.currency}${balance.toLocaleString()}</div>
                        </div>
                        <div style="background:rgba(255,255,255,0.05); padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                            <div style="font-size:10px; text-transform:uppercase; letter-spacing:1px; opacity:0.6; margin-bottom:4px; font-weight:700;">Total Transactions</div>
                            <div style="font-size:15px; font-weight:800; color:var(--warning);">${contractorTxs.length}</div>
                        </div>
                    </div>

                    <div class="budget-bar-container" style="height:10px; background:rgba(255,255,255,0.1); border-radius:5px; overflow:hidden;">
                        <div class="budget-bar-fill" style="width:${Math.min(percent, 100)}%; height:100%; background:linear-gradient(90deg, var(--primary), var(--secondary)); box-shadow:0 0 10px var(--primary);"></div>
                    </div>
                </div>`;
                }).join('');

                const tbody = document.getElementById('paymentTableBody');
                let txs = app.expenses;
                if (filterName !== 'all') txs = txs.filter(e => e.contractor === filterName);
                tbody.innerHTML = txs.sort((a, b) => new Date(b.date) - new Date(a.date)).map(e => `
                <tr>
                    <td data-sort="${e.date}">${formatDate(e.date)}</td>
                    <td>${e.contractor || '-'}</td>
                    <td>${e.workType}</td>
                    <td><b>${app.currency}${parseFloat(e.amount).toLocaleString(app.dateFormat)}</b></td>
                    <td>${e.paidBy}</td>
                    <td>${e.mode}</td>
                </tr>
            `).join('');
            }

            async function shareOnWhatsApp() {
                const contractorName = document.getElementById('paymentFilter').value;
                if (!contractorName || contractorName === 'all') {
                    showNotification('Please select a specific contractor first', 'info');
                    return;
                }

                const contractor = app.contractors.find(c => c.name === contractorName);
                const payments = app.expenses.filter(e => e.contractor === contractorName)
                    .sort((a, b) => new Date(a.date) - new Date(b.date));

                if (payments.length === 0) {
                    showNotification('No payments to share', 'info');
                    return;
                }

                showNotification('Preparing statement for sharing...', 'info');

                try {
                    // 1. Generate the PDF blob using jsPDF logic
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('p', 'mm', 'a4');

                    const formatForPDF = (text) => {
                        if (!text) return '';
                        return text.toString().replace(/₹/g, 'Rs.').replace(/[^\x00-\x7F]/g, '');
                    };

                    const primaryColor = [102, 126, 234];
                    doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                    doc.rect(0, 0, 210, 40, 'F');
                    doc.setFontSize(22);
                    doc.setTextColor(255, 255, 255);
                    doc.text('Payment Statement', 20, 20);
                    doc.setFontSize(14);
                    doc.text(formatForPDF(contractorName), 20, 30);

                    // Financial Summary Box
                    const totalPaid = payments.reduce((a, b) => a + parseFloat(b.amount || 0), 0);
                    const budget = contractor?.budget || 0;
                    const balance = budget - totalPaid;

                    doc.setFillColor(245, 247, 251);
                    doc.rect(20, 50, 170, 25, 'F');
                    doc.setTextColor(40, 40, 40);
                    doc.setFontSize(10);
                    doc.text(`Total Paid: Rs.${totalPaid.toLocaleString()}`, 25, 65);
                    doc.text(`Budget: Rs.${budget.toLocaleString()}`, 80, 65);
                    doc.text(`Balance: Rs.${balance.toLocaleString()}`, 135, 65);

                    // Table
                    let yPos = 85;
                    doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                    doc.rect(20, yPos, 170, 10, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.text('Date', 25, yPos + 7);
                    doc.text('Work Type', 55, yPos + 7);
                    doc.text('Amount', 150, yPos + 7);

                    yPos += 15;
                    doc.setTextColor(60, 60, 60);
                    payments.forEach((p, i) => {
                        if (i % 2 === 0) {
                            doc.setFillColor(248, 249, 252);
                            doc.rect(20, yPos - 5, 170, 10, 'F');
                        }
                        doc.text(formatForPDF(new Date(p.date).toLocaleDateString()), 25, yPos);
                        doc.text(formatForPDF(p.workType || 'General'), 55, yPos);
                        doc.text(`Rs.${parseFloat(p.amount).toLocaleString()}`, 150, yPos);
                        yPos += 10;
                    });

                    const pdfBlob = doc.output('blob');
                    const fileName = `Statement_${contractorName.replace(/\s+/g, '_')}.pdf`;
                    const file = new File([pdfBlob], fileName, { type: 'application/pdf' });

                    // 2. Try Web Share API (Mobile Support)
                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            files: [file],
                            title: 'Payment Statement',
                            text: `Payment Statement for ${contractorName} - Interior Budget Pro`
                        });
                        showNotification('Statement shared!', 'success');
                    } else {
                        // 3. Fallback to WhatsApp Text + Download
                        const paid = payments.reduce((a, b) => a + parseFloat(b.amount || 0), 0);
                        const balance = contractor.budget - paid;

                        let message = `*Interior Project: ${app.projectName}*\n`;
                        message += `*Contractor Payment Receipt*\n\n`;
                        message += `*Name:* ${contractor.name}\n`;
                        message += `*Summary:* Total Paid: ${app.currency}${paid.toLocaleString()}, Balance: ${app.currency}${balance.toLocaleString()}\n\n`;
                        message += `_Statement PDF generating for download..._`;

                        const phone = contractor.phone ? contractor.phone.replace(/\D/g, '') : '';
                        window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, '_blank');

                        // Also trigger PDF download since direct cloud file sharing failed
                        doc.save(fileName);
                        showNotification('Opening WhatsApp & Downloading PDF...', 'success');
                    }
                } catch (err) {
                    console.error('Sharing failed:', err);
                    showNotification('Sharing failed. Try downloading PDF instead.', 'error');
                }
            }

            function exportContractorPaymentsPDF() {
                const filterName = document.getElementById('paymentFilter').value;
                if (filterName === 'all') return;
                exportContractorPDF(filterName);
            }

            // ========== CALENDAR FUNCTIONS ==========
            function changeMonth(delta) {
                currentDate.setMonth(currentDate.getMonth() + delta);
                renderCalendar();
            }

            function renderCalendar() {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                document.getElementById('calMonthYear').innerText = new Date(year, month).toLocaleString('default', { month: 'long', year: 'numeric' });

                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const grid = document.getElementById('calGrid');
                grid.innerHTML = '';

                for (let i = 0; i < firstDay; i++) grid.innerHTML += '<div></div>';

                for (let d = 1; d <= daysInMonth; d++) {
                    const dayStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    const hasPay = app.expenses.some(e => e.date === dayStr);
                    const hasNote = app.notes.some(n => n.date === dayStr);
                    const hasComp = app.components.some(c => c.date === dayStr);

                    let dots = '';
                    if (hasPay) dots += '<div class="dot dot-pay"></div>';
                    if (hasNote) dots += '<div class="dot dot-note"></div>';
                    if (hasComp) dots += '<div class="dot dot-comp"></div>';

                    const classes = ['cal-day'];
                    if (dayStr === new Date().toISOString().split('T')[0]) classes.push('today');
                    if (dayStr === selectedDate) classes.push('selected');

                    grid.innerHTML += `<div class="${classes.join(' ')}" onclick="selectDate('${dayStr}')">
                    <span style="font-weight:bold">${d}</span>
                    <div class="cal-dots">${dots}</div>
                </div>`;
                }
                renderDateDetails();
            }

            function selectDate(str) {
                selectedDate = str;
                renderCalendar();
            }

            function renderDateDetails() {
                document.getElementById('selectedDateDisplay').innerText = new Date(selectedDate).toDateString();
                const content = document.getElementById('dateContent');
                content.innerHTML = '';

                const notes = app.notes.filter(n => n.date === selectedDate);
                const pays = app.expenses.filter(e => e.date === selectedDate);
                const comps = app.components.filter(c => c.date === selectedDate);

                if (notes.length) {
                    content.innerHTML += '<h4 style="margin:15px 0 8px">📝 Notes</h4>';
                    notes.forEach(n => content.innerHTML += `<div style="background:rgba(255,255,255,0.1); padding:10px; border-radius:8px; margin-bottom:8px; display:flex; justify-content:space-between">
                    <span>${n.text}</span>
                    <div><i class="fas fa-edit" style="cursor:pointer; color:var(--warning); margin-right:10px" onclick="editNote(${n.id})"></i>
                    <i class="fas fa-trash" style="cursor:pointer; color:var(--danger)" onclick="deleteNote(${n.id})"></i></div>
                </div>`);
                }

                if (pays.length) {
                    content.innerHTML += '<h4 style="margin:15px 0 8px">💳 Payments</h4>';
                    pays.forEach(p => content.innerHTML += `<div style="background:rgba(16,185,129,0.15); padding:10px; border-radius:8px; margin-bottom:8px">
                    ${app.currency}${parseFloat(p.amount).toLocaleString(app.dateFormat)} → ${p.contractor} (${p.workType}) by ${p.paidBy}
                </div>`);
                }

                if (comps.length) {
                    content.innerHTML += '<h4 style="margin:15px 0 8px">🛠️ Components</h4>';
                    comps.forEach(c => content.innerHTML += `<div style="background:rgba(6,182,212,0.15); padding:10px; border-radius:8px; margin-bottom:8px">
                    ${c.name} - ${app.currency}${parseFloat(c.cost).toLocaleString(app.dateFormat)} (${c.progress}%)
                </div>`);
                }

                if (!notes.length && !pays.length && !comps.length) content.innerHTML = '<p style="opacity:0.6; text-align:center; padding:20px">No activity on this date.</p>';
            }

            // ========== NOTES FUNCTIONS ==========
            function addNote() {
                document.getElementById('noteEditId').value = '';
                document.getElementById('noteText').value = '';
                openModal('noteModal');
            }

            function editNote(id) {
                const n = app.notes.find(x => x.id === id);
                if (!n) return;
                document.getElementById('noteEditId').value = n.id;
                document.getElementById('noteText').value = n.text;
                openModal('noteModal');
            }

            function saveNote() {
                const id = document.getElementById('noteEditId').value || Date.now();
                const text = document.getElementById('noteText').value.trim();
                if (!text) return;
                const idx = app.notes.findIndex(x => x.id == id);
                if (idx > -1) app.notes[idx].text = text;
                else app.notes.push({ id: parseInt(id), date: selectedDate, text });
                saveData();
                renderCalendar();
                closeModal('noteModal');
                showNotification('Note saved!', 'success');
            }

            function deleteNote(id) {
                if (confirm('Delete note?')) {
                    app.notes = app.notes.filter(x => x.id !== id);
                    saveData();
                    renderCalendar();
                    showNotification('Note deleted!', 'success');
                }
            }

            // ========== TIMELINE FUNCTIONS ==========
            function renderTimeline() {
                let events = [];

                // Add expenses as payment events
                app.expenses.forEach(e => {
                    if (timelineFilter === 'all' || timelineFilter === 'payment') {
                        events.push({
                            date: e.date,
                            type: 'Payment',
                            icon: '💳',
                            color: 'var(--success)',
                            timelineColor: 'var(--success)',
                            desc: `${app.currency}${parseFloat(e.amount).toLocaleString(app.dateFormat)} to ${e.contractor}`,
                            details: `Work: ${e.workType} | Paid by: ${e.paidBy} | Status: ${e.status}`,
                            category: 'payment'
                        });
                    }
                });

                // Add faults
                app.faults.forEach(f => {
                    if (timelineFilter === 'all' || timelineFilter === 'fault') {
                        events.push({
                            date: f.date,
                            type: 'Fault',
                            icon: '⚠️',
                            color: 'var(--danger)',
                            timelineColor: 'var(--danger)',
                            desc: f.desc,
                            details: `Contractor: ${f.contractor} | Cost: ${app.currency}${parseFloat(f.cost || 0).toLocaleString()} | Status: ${f.status}`,
                            category: 'fault'
                        });
                    }
                });

                // Add components
                app.components.forEach(c => {
                    if (timelineFilter === 'all' || timelineFilter === 'component') {
                        events.push({
                            date: c.date,
                            type: 'Component',
                            icon: '🛠️',
                            color: 'var(--info)',
                            timelineColor: 'var(--info)',
                            desc: `${c.name} added`,
                            details: `Cost: ${app.currency}${parseFloat(c.cost).toLocaleString()} | Progress: ${c.progress}% | Status: ${c.status}`,
                            category: 'component'
                        });
                    }
                });

                // Add notes
                app.notes.forEach(n => {
                    if (timelineFilter === 'all' || timelineFilter === 'note') {
                        events.push({
                            date: n.date,
                            type: 'Note',
                            icon: '📝',
                            color: 'var(--warning)',
                            timelineColor: 'var(--warning)',
                            desc: n.text,
                            details: 'Personal note',
                            category: 'note'
                        });
                    }
                });

                // Sort by date (newest first)
                events.sort((a, b) => new Date(b.date) - new Date(a.date));

                const list = document.getElementById('timelineList');
                if (events.length === 0) {
                    list.innerHTML = '<div style="text-align:center; padding:40px; opacity:0.6;">No timeline events yet. Add expenses, components, or faults to see them here.</div>';
                    return;
                }

                list.innerHTML = events.map(ev => `
                <div class="timeline-event" style="--timeline-color: ${ev.timelineColor}">
                    <div class="timeline-icon" style="background:${ev.color}20; color:${ev.color};">
                        ${ev.icon}
                    </div>
                    <div style="flex:1;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                            <div style="font-weight:700; font-size:16px;">${ev.type}</div>
                            <div style="font-size:13px; opacity:0.8; background:rgba(255,255,255,0.1); padding:4px 12px; border-radius:12px;">
                                ${formatDate(ev.date)}
                            </div>
                        </div>
                        <div style="font-size:15px; margin-bottom:4px;">${ev.desc}</div>
                        <div style="font-size:13px; opacity:0.7;">${ev.details}</div>
                    </div>
                </div>
            `).join('');
            }

            function filterTimeline(filter) {
                timelineFilter = filter;
                renderTimeline();

                // Update active filter button
                document.querySelectorAll('#timeline .btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
            }

            // ========== ANALYTICS & REPORTS ==========
            function renderReports() {
                // Destroy existing charts
                Object.values(currentCharts).forEach(chart => {
                    if (chart) chart.destroy();
                });

                // 1. Spending by Category (Pie Chart)
                const catData = {};
                app.expenses.forEach(e => {
                    const cat = e.category || 'Other';
                    catData[cat] = (catData[cat] || 0) + parseFloat(e.amount || 0);
                });

                currentCharts.catChart = new Chart(document.getElementById('catChart'), {
                    type: 'pie',
                    data: {
                        labels: Object.keys(catData),
                        datasets: [{
                            data: Object.values(catData),
                            backgroundColor: [
                                '#667eea', '#764ba2', '#f093fb', '#10b981', '#f59e0b',
                                '#ff0808', '#06b6d4', '#8b5cf6', '#f97316', '#84cc16'
                            ],
                            borderWidth: 2,
                            borderColor: 'rgba(255,255,255,0.1)'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                labels: {
                                    color: 'white',
                                    font: { size: 12 }
                                },
                                position: 'right'
                            },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const value = context.raw;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${context.label}: ${app.currency}${value.toLocaleString()} (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        animation: {
                            animateScale: true,
                            animateRotate: true
                        }
                    }
                });

                // 2. Spending by Contractor (Doughnut)
                const contData = {};
                app.contractors.forEach(c => {
                    const spent = app.expenses.filter(e => e.contractor === c.name).reduce((a, b) => a + parseFloat(b.amount || 0), 0);
                    if (spent > 0) contData[c.name] = spent;
                });

                currentCharts.contChart = new Chart(document.getElementById('contChart'), {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(contData),
                        datasets: [{
                            data: Object.values(contData),
                            backgroundColor: [
                                '#0ea5e9', '#10b981', '#f59e0b', '#ff0808', '#06b6d4',
                                '#f093fb', '#8b5cf6', '#f97316', '#84cc16', '#e11d48'
                            ],
                            borderWidth: 2,
                            borderColor: 'rgba(255,255,255,0.1)'
                        }]
                    },
                    options: {
                        responsive: true,
                        cutout: '60%',
                        plugins: {
                            legend: {
                                labels: {
                                    color: 'white',
                                    font: { size: 11 }
                                }
                            }
                        },
                        animation: {
                            animateScale: true,
                            animateRotate: true
                        }
                    }
                });

                // 3. Monthly Spending Trend (Line Chart)
                const monthlyData = {};
                app.expenses.forEach(e => {
                    const date = new Date(e.date);
                    const monthYear = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    monthlyData[monthYear] = (monthlyData[monthYear] || 0) + parseFloat(e.amount || 0);
                });

                const sortedMonths = Object.keys(monthlyData).sort();
                const monthlyValues = sortedMonths.map(m => monthlyData[m]);

                currentCharts.monthlyChart = new Chart(document.getElementById('monthlyChart'), {
                    type: 'line',
                    data: {
                        labels: sortedMonths.map(m => {
                            const [year, month] = m.split('-');
                            return new Date(year, month - 1).toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                        }),
                        datasets: [{
                            label: 'Monthly Spending',
                            data: monthlyValues,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#667eea',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 5,
                            pointHoverRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: 'rgba(255,255,255,0.1)' },
                                ticks: {
                                    color: 'white',
                                    callback: value => app.currency + value.toLocaleString()
                                }
                            },
                            x: {
                                grid: { color: 'rgba(255,255,255,0.1)' },
                                ticks: { color: 'white' }
                            }
                        },
                        plugins: {
                            legend: { labels: { color: 'white' } },
                            tooltip: {
                                callbacks: {
                                    label: (context) => `${app.currency}${context.parsed.y.toLocaleString()}`
                                }
                            }
                        }
                    }
                });

                // 4. Component Progress (Horizontal Bar)
                const compStatus = { 'Not Started': 0, 'In Progress': 0, 'Completed': 0 };
                app.components.forEach(c => compStatus[c.status]++);

                currentCharts.compChart = new Chart(document.getElementById('compChart'), {
                    type: 'bar',
                    data: {
                        labels: Object.keys(compStatus),
                        datasets: [{
                            label: 'Components',
                            data: Object.values(compStatus),
                            backgroundColor: ['#ff0808', '#f59e0b', '#10b981'],
                            borderWidth: 2,
                            borderColor: 'rgba(255,255,255,0.2)',
                            borderRadius: 8,
                            borderSkipped: false
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        scales: {
                            x: {
                                beginAtZero: true,
                                grid: { color: 'rgba(255,255,255,0.1)' },
                                ticks: { color: 'white' }
                            },
                            y: {
                                grid: { color: 'rgba(255,255,255,0.1)' },
                                ticks: { color: 'white' }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (context) => `${context.parsed.x} components`
                                }
                            }
                        },
                        animation: {
                            duration: 2000,
                            easing: 'easeOutQuart'
                        }
                    }
                });

                // 5. Payment Method Distribution
                const paymentMethods = {};
                app.expenses.forEach(e => {
                    const method = e.mode || 'Unknown';
                    paymentMethods[method] = (paymentMethods[method] || 0) + parseFloat(e.amount || 0);
                });

                currentCharts.paymentMethodChart = new Chart(document.getElementById('paymentMethodChart'), {
                    type: 'polarArea',
                    data: {
                        labels: Object.keys(paymentMethods),
                        datasets: [{
                            data: Object.values(paymentMethods),
                            backgroundColor: [
                                'rgba(102, 126, 234, 0.8)',
                                'rgba(16, 185, 129, 0.8)',
                                'rgba(245, 158, 11, 0.8)',
                                'rgba(239, 68, 68, 0.8)',
                                'rgba(6, 182, 212, 0.8)'
                            ],
                            borderWidth: 2,
                            borderColor: 'rgba(255,255,255,0.3)'
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            r: {
                                grid: { color: 'rgba(255,255,255,0.1)' },
                                ticks: {
                                    color: 'white',
                                    display: false
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: {
                                    color: 'white',
                                    font: { size: 11 }
                                }
                            }
                        },
                        animation: {
                            animateRotate: true,
                            animateScale: true
                        }
                    }
                });

                // 6. Budget vs Actual (Bar Chart)
                const spent = app.expenses.reduce((a, b) => a + parseFloat(b.amount || 0), 0);
                const compCost = app.components.reduce((a, b) => a + parseFloat(b.cost || 0), 0);
                const totalSpent = spent + compCost;

                currentCharts.budgetVsActualChart = new Chart(document.getElementById('budgetVsActualChart'), {
                    type: 'bar',
                    data: {
                        labels: ['Budget vs Actual'],
                        datasets: [
                            {
                                label: 'Budget',
                                data: [app.budget],
                                backgroundColor: 'rgba(102, 126, 234, 0.7)',
                                borderColor: '#667eea',
                                borderWidth: 2
                            },
                            {
                                label: 'Actual Spend',
                                data: [totalSpent],
                                backgroundColor: totalSpent > app.budget ? 'rgba(239, 68, 68, 0.7)' : 'rgba(16, 185, 129, 0.7)',
                                borderColor: totalSpent > app.budget ? '#ff0808' : '#10b981',
                                borderWidth: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: 'rgba(255,255,255,0.1)' },
                                ticks: {
                                    color: 'white',
                                    callback: value => app.currency + value.toLocaleString()
                                }
                            },
                            x: {
                                grid: { color: 'rgba(255,255,255,0.1)' },
                                ticks: { color: 'white' }
                            }
                        },
                        plugins: {
                            legend: { labels: { color: 'white' } },
                            tooltip: {
                                callbacks: {
                                    label: (context) => `${app.currency}${context.parsed.y.toLocaleString()}`
                                }
                            }
                        }
                    }
                });

                // Detailed Reports
                renderTopExpenses();
                renderContractorPerformance();
                renderBudgetHealth();
            }

            function renderTopExpenses() {
                const container = document.getElementById('topExpensesList');
                if (!container) return;

                const topExpenses = [...app.expenses]
                    .sort((a, b) => parseFloat(b.amount) - parseFloat(a.amount))
                    .slice(0, 5);

                container.innerHTML = topExpenses.length === 0 ?
                    '<p style="opacity:0.6; text-align:center; padding:20px;">No expenses yet</p>' :
                    topExpenses.map(exp => `
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:12px; background:rgba(255,255,255,0.05); border-radius:8px; margin-bottom:8px;">
                        <div>
                            <div style="font-weight:600; font-size:14px;">${exp.contractor || 'Unknown'}</div>
                            <div style="font-size:12px; opacity:0.7;">${exp.workType}</div>
                        </div>
                        <div style="font-weight:700; color:var(--warning);">
                            ${app.currency}${parseFloat(exp.amount).toLocaleString()}
                        </div>
                    </div>
                `).join('');
            }

            function renderContractorPerformance() {
                const container = document.getElementById('contractorPerformance');
                if (!container) return;

                const contractorStats = app.contractors.map(c => {
                    const spent = app.expenses.filter(e => e.contractor === c.name).reduce((a, b) => a + parseFloat(b.amount || 0), 0);
                    const budgetUsed = c.budget > 0 ? (spent / c.budget * 100) : 0;
                    const projects = app.expenses.filter(e => e.contractor === c.name).length;

                    return {
                        name: c.name,
                        spent,
                        budgetUsed,
                        projects,
                        efficiency: projects > 0 ? (spent / projects) : 0
                    };
                }).sort((a, b) => b.spent - a.spent);

                container.innerHTML = contractorStats.length === 0 ?
                    '<p style="opacity:0.6; text-align:center; padding:20px;">No contractors yet</p>' :
                    contractorStats.map(stat => `
                    <div style="margin-bottom:12px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                            <span style="font-weight:600; font-size:14px;">${stat.name}</span>
                            <span style="font-weight:700;">${app.currency}${stat.spent.toLocaleString()}</span>
                        </div>
                        <div style="height:6px; background:rgba(255,255,255,0.1); border-radius:3px; overflow:hidden;">
                            <div style="height:100%; width:${Math.min(stat.budgetUsed, 100)}%; 
                                      background:${stat.budgetUsed > 90 ? 'var(--danger)' : stat.budgetUsed > 70 ? 'var(--warning)' : 'var(--success)'};">
                            </div>
                        </div>
                        <div style="display:flex; justify-content:space-between; font-size:11px; opacity:0.7; margin-top:4px;">
                            <span>${stat.projects} projects</span>
                            <span>${stat.budgetUsed.toFixed(1)}% used</span>
                        </div>
                    </div>
                `).join('');
            }

            function renderBudgetHealth() {
                const container = document.getElementById('budgetHealth');
                if (!container) return;

                const spent = app.expenses.reduce((a, b) => a + parseFloat(b.amount || 0), 0);
                const compCost = app.components.reduce((a, b) => a + parseFloat(b.cost || 0), 0);
                const totalSpent = spent + compCost;
                const remaining = app.budget - totalSpent;
                const usagePercent = app.budget > 0 ? (totalSpent / app.budget * 100) : 0;

                let healthStatus, healthColor, healthIcon;

                if (app.budget === 0) {
                    healthStatus = 'No Budget Set';
                    healthColor = 'var(--warning)';
                    healthIcon = '⚠️';
                } else if (usagePercent > 100) {
                    healthStatus = 'Over Budget';
                    healthColor = 'var(--danger)';
                    healthIcon = '❌';
                } else if (usagePercent > 80) {
                    healthStatus = 'At Risk';
                    healthColor = 'var(--warning)';
                    healthIcon = '⚠️';
                } else if (usagePercent > 50) {
                    healthStatus = 'Good';
                    healthColor = 'var(--success)';
                    healthIcon = '✅';
                } else {
                    healthStatus = 'Excellent';
                    healthColor = 'var(--info)';
                    healthIcon = '⭐';
                }

                container.innerHTML = `
                <div style="text-align:center; padding:20px;">
                    <div style="font-size:48px; margin-bottom:16px;">${healthIcon}</div>
                    <div style="font-size:20px; font-weight:700; color:${healthColor}; margin-bottom:8px;">
                        ${healthStatus}
                    </div>
                    <div style="font-size:32px; font-weight:900; margin:16px 0;">
                        ${app.currency}${remaining.toLocaleString()}
                    </div>
                    <div style="font-size:14px; opacity:0.8;">Remaining Balance</div>
                    <div style="height:10px; background:rgba(255,255,255,0.1); border-radius:5px; margin:20px 0; overflow:hidden;">
                        <div style="height:100%; width:${Math.min(usagePercent, 100)}%; 
                                  background:${healthColor}; transition:width 1s ease;">
                        </div>
                    </div>
                    <div style="display:flex; justify-content:space-between; font-size:13px;">
                        <span>Spent: ${app.currency}${totalSpent.toLocaleString()}</span>
                        <span>${usagePercent.toFixed(1)}% used</span>
                        <span>Budget: ${app.currency}${app.budget.toLocaleString()}</span>
                    </div>
                </div>
            `;
            }

            // ========== DATA PERSISTENCE ==========
            // ========== EXPENSE TABLE RENDERING ==========
            function renderExpenses() {
                const tbody = document.getElementById('expenseTableBody');
                if (!tbody) return;

                tbody.innerHTML = app.expenses.sort((a, b) => new Date(b.date) - new Date(a.date)).map(e => {
                    const statusClass = e.status === 'Completed' ? 'badge-completed' :
                        e.status === 'Pending' ? 'badge-pending' :
                            e.status === 'In Progress' ? 'badge-inprogress' :
                                'badge-pending';
                    return `
        <tr>
            <td data-sort="${e.date}">${formatDate(e.date)}</td>
            <td>${e.category}</td>
            <td>${e.contractor || '-'}</td>
            <td>${e.workType}</td>
            <td><b>${app.currency}${parseFloat(e.amount).toLocaleString(app.dateFormat)}</b></td>
            <td>${e.paidBy}</td>
            <td><span class="badge ${statusClass}">${e.status}</span></td>
            <td style="white-space:nowrap;">
                <button class="btn-icon btn-edit" onclick="editExpense(${e.id})" title="Edit">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn-icon btn-info btn-duplicate" onclick="duplicateExpense(${e.id})" title="Duplicate">
                    <i class="fas fa-copy"></i>
                </button>
                <button class="btn-icon btn-delete" onclick="deleteExpense(${e.id})" title="Delete">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `}).join('');
            }

            // ========== TABLE SORTING FUNCTIONALITY ==========
            function initTableSorting() {
                document.querySelectorAll('th[data-sortable="true"]').forEach(th => {
                    th.addEventListener('click', () => {
                        const table = th.closest('table');
                        const tbody = table.querySelector('tbody');
                        const rows = Array.from(tbody.querySelectorAll('tr'));
                        const colIndex = Array.from(th.parentNode.children).indexOf(th);

                        const isAsc = th.classList.contains('asc');
                        const isDesc = th.classList.contains('desc');

                        // Reset other headers
                        table.querySelectorAll('th').forEach(h => {
                            h.classList.remove('asc', 'desc');
                        });

                        // Sort rows
                        rows.sort((a, b) => {
                            let aCell = a.children[colIndex];
                            let bCell = b.children[colIndex];

                            let aVal = aCell.getAttribute('data-sort') || aCell.textContent.trim();
                            let bVal = bCell.getAttribute('data-sort') || bCell.textContent.trim();

                            // Try to convert to numbers for currency and numeric values
                            const aNum = parseFloat(aVal.replace(/[^\d.-]/g, ''));
                            const bNum = parseFloat(bVal.replace(/[^\d.-]/g, ''));

                            if (!isNaN(aNum) && !isNaN(bNum)) {
                                aVal = aNum;
                                bVal = bNum;
                            } else {
                                // Try date parsing
                                const aDate = new Date(aVal);
                                const bDate = new Date(bVal);
                                if (!isNaN(aDate) && !isNaN(bDate)) {
                                    aVal = aDate;
                                    bVal = bDate;
                                }
                            }

                            if (isAsc) {
                                return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                            } else {
                                return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                            }
                        });

                        // Toggle direction
                        if (isAsc) {
                            th.classList.add('desc');
                        } else {
                            th.classList.add('asc');
                        }

                        // Reappend rows
                        rows.forEach(row => tbody.appendChild(row));
                        addPremiumClickEffect(th);
                    });
                });
            }

            // ========== THEME MANAGEMENT ==========
            function setTheme(name) {
                document.body.className = `theme-${name}`;
                app.theme = name;
                saveData();
                showNotification(`Theme changed to ${name}`, 'info');

                // Animate theme change
                document.body.style.transition = 'background 0.8s ease';
                setTimeout(() => {
                    document.body.style.transition = '';
                }, 800);
            }

            // ========== NOTIFICATION SYSTEM ==========
            function showNotification(message, type = 'info') {
                const container = document.querySelector('.container');
                let notif = document.createElement('div');
                notif.className = `notification notification-${type}`;
                notif.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
                <button class="notification-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
                container.appendChild(notif);

                setTimeout(() => notif.classList.add('show'), 10);
                setTimeout(() => {
                    notif.classList.remove('show');
                    setTimeout(() => notif.remove(), 500);
                }, 3000);
            }

            // ========== CLICK ANIMATIONS ==========
            function addPremiumClickEffect(element) {
                element.classList.add('premium-click');
                setTimeout(() => element.classList.remove('premium-click'), 400);
            }

            // ========== ACTIVITY DETAIL VIEW ==========
            function showActivityDetail(type, date) {
                switchTab('timeline');
                filterTimeline(type === 'expense' ? 'payment' : type);
                showNotification(`Showing ${type} activities from ${date}`, 'info');
            }

            // ========== BUDGET EDITING ==========
            function editTotalBudget() {
                const newBudget = prompt('Enter new total budget:', app.budget || 0);
                if (newBudget !== null && !isNaN(parseFloat(newBudget))) {
                    app.budget = parseFloat(newBudget);
                    saveData();
                    renderDashboard();
                    showNotification('Budget updated successfully!', 'success');
                }
            }

            // ========== DATA EXPORT/IMPORT ==========
            function exportData() {
                // First save all current settings to app object
                saveData();

                // Create comprehensive backup object
                const backupData = {
                    ...app, // All existing app data
                    backupVersion: '2.0',
                    backupDate: new Date().toISOString(),
                    metadata: {
                        totalExpenses: app.expenses.length,
                        totalContractors: app.contractors.length,
                        totalComponents: app.components.length,
                        totalFaults: app.faults.length,
                        totalNotes: app.notes.length
                    }
                };

                const dataStr = JSON.stringify(backupData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                const exportFileDefaultName = `Interior_Budget_Pro_Backup_${new Date().toISOString().split('T')[0]}_${Date.now()}.json`;

                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                showNotification('Complete backup exported successfully! All settings included.', 'success');
            }
            function importData(input) {
                const file = input.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function (event) {
                    try {
                        const imported = JSON.parse(event.target.result);

                        // Validate
                        if (!imported.expenses || !imported.contractors || !imported.components) {
                            showNotification("Invalid backup file: Missing required data", "error");
                            return;
                        }

                        // Show confirmation
                        if (confirm(`Import backup from ${imported.backupDate || 'unknown date'}?\n\nThis will replace:\n• ${imported.expenses.length} expenses\n• ${imported.contractors.length} contractors\n• ${imported.components.length} components\n\nAll settings and preferences data will be lost.`)) {

                            // Import all data
                            app = {
                                budget: imported.budget || 0,
                                projectName: imported.projectName || "Interior Budget Pro",
                                userName: imported.userName || "Project Manager",
                                projectAddress: imported.projectAddress || "",
                                projectTimeline: imported.projectTimeline || "6 months",
                                paymentSources: imported.paymentSources || ["Self", "Spouse", "Parent", "Bank Loan"],
                                expenses: imported.expenses || [],
                                contractors: imported.contractors || [],
                                components: imported.components || [],
                                faults: imported.faults || [],
                                notes: imported.notes || [],
                                theme: imported.theme || "purple",
                                currency: imported.currency || "₹",
                                dateFormat: imported.dateFormat || "en-IN"
                            };

                            saveData();
                            renderAll();
                            setTheme(app.theme);

                            // ADD THIS: Force update displays AFTER switching to settings tab
                            setTimeout(() => {
                                switchTab('settings');
                                setTimeout(() => {
                                    updateDisplays();
                                    showNotification("Complete backup imported successfully! All settings restored.", "success");
                                }, 100);
                            }, 100);
                        }

                        // Reset file input
                        input.value = '';

                    } catch (error) {
                        console.error("Import error:", error);
                        showNotification("Invalid backup file format. Please select a valid JSON backup.", "error");
                        input.value = '';
                    }
                };

                reader.readAsText(file);
            }

            function showBackupSummary() {
                const summary = `
Backup includes:
✓ All expenses (${app.expenses.length})
✓ All contractors (${app.contractors.length})
✓ All components (${app.components.length})
✓ All faults (${app.faults.length})
✓ All notes (${app.notes.length})
✓ Profile settings (name, address, timeline)
✓ Payment sources (${app.paymentSources.length})
✓ Theme preference (${app.theme})
✓ Currency (${app.currency})
✓ Date format (${app.dateFormat})
✓ Total budget (${app.currency}${app.budget.toLocaleString()})
    `;

                if (confirm(`Create backup with current data?\n\n${summary}\n\nClick OK to download backup file.`)) {
                    exportData();
                }
            }

            // ========== EXCEL EXPORT ==========
            function exportExcelEnhanced() {
                try {
                    // Create a new workbook
                    const wb = XLSX.utils.book_new();

                    // Expenses sheet
                    const expData = app.expenses.map(e => ({
                        Date: e.date,
                        Contractor: e.contractor,
                        'Work Type': e.workType,
                        Category: e.category,
                        Amount: e.amount,
                        'Paid By': e.paidBy,
                        'Payment Mode': e.mode,
                        Status: e.status,
                        Notes: e.notes
                    }));
                    const expWS = XLSX.utils.json_to_sheet(expData);
                    XLSX.utils.book_append_sheet(wb, expWS, "Expenses");

                    // Contractors sheet
                    const contData = app.contractors.map(c => ({
                        Name: c.name,
                        Specialization: c.role,
                        Phone: c.phone,
                        Email: c.email,
                        Company: c.company,
                        Rating: c.rating || 0,
                        'Allocated Budget': c.budget,
                        Details: c.details
                    }));
                    const contWS = XLSX.utils.json_to_sheet(contData);
                    XLSX.utils.book_append_sheet(wb, contWS, "Contractors");

                    // Components sheet
                    const compData = app.components.map(c => ({
                        Date: c.date,
                        Name: c.name,
                        Category: c.category,
                        Contractor: c.contractor,
                        'Work Type': c.workType,
                        Cost: c.cost,
                        Progress: c.progress,
                        Status: c.status
                    }));
                    const compWS = XLSX.utils.json_to_sheet(compData);
                    XLSX.utils.book_append_sheet(wb, compWS, "Components");

                    // Faults sheet
                    const faultData = app.faults.map(f => ({
                        Date: f.date,
                        Contractor: f.contractor,
                        Description: f.desc,
                        'Estimated Cost': f.cost,
                        Status: f.status
                    }));
                    const faultWS = XLSX.utils.json_to_sheet(faultData);
                    XLSX.utils.book_append_sheet(wb, faultWS, "Faults");

                    // Write the file
                    XLSX.writeFile(wb, `Interior_Budget_Pro_${new Date().toISOString().split('T')[0]}.xlsx`);
                    showNotification('Excel export completed!', 'success');
                } catch (error) {
                    console.error('Export error:', error);
                    showNotification('Export failed!', 'error');
                }
            }

            // ========== PDF EXPORT ==========
            // ========== PDF EXPORT ==========
            function exportContractorPaymentsPDF() {
                const contractorName = document.getElementById('paymentFilter').value;
                if (!contractorName || contractorName === 'all') return;

                const contractor = app.contractors.find(c => c.name === contractorName);
                const payments = app.expenses.filter(e => e.contractor === contractorName)
                    .sort((a, b) => new Date(b.date) - new Date(a.date));

                if (payments.length === 0) {
                    showNotification('No payments found for this contractor', 'info');
                    return;
                }

                const loadingBtn = document.getElementById('btnExportContractorPDF');
                const originalHTML = loadingBtn.innerHTML;
                loadingBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
                loadingBtn.disabled = true;

                setTimeout(() => {
                    try {
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF('p', 'mm', 'a4');

                        const formatForPDF = (text) => {
                            if (!text) return '';
                            return text.toString().replace(/₹/g, 'Rs.').replace(/[^\x00-\x7F]/g, '');
                        };

                        const primaryColor = [102, 126, 234]; // #667eea
                        const accentColor = [242, 211, 72]; // #f2d348

                        // Header Background
                        doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                        doc.rect(0, 0, 210, 40, 'F');

                        // Title
                        doc.setFontSize(22);
                        doc.setTextColor(255, 255, 255);
                        doc.text('Payment Statement', 20, 20);
                        doc.setFontSize(14);
                        doc.text(formatForPDF(contractorName), 20, 30);

                        // Contractor Info Box
                        doc.setFillColor(245, 247, 251);
                        doc.rect(20, 50, 170, 35, 'F');
                        doc.setTextColor(40, 40, 40);
                        doc.setFontSize(12);
                        doc.text('Contractor Details', 25, 60);
                        doc.setFontSize(10);
                        doc.setTextColor(100, 100, 100);
                        doc.text(`Role: ${formatForPDF(contractor?.role || 'N/A')}`, 25, 68);
                        doc.text(`Phone: ${formatForPDF(contractor?.phone || 'N/A')}`, 25, 75);
                        doc.text(`Email: ${formatForPDF(contractor?.email || 'N/A')}`, 25, 82);

                        // Summary Box (Right Side)
                        const totalPaid = payments.reduce((a, b) => a + parseFloat(b.amount || 0), 0);
                        const budget = contractor?.budget || 0;
                        const balance = budget - totalPaid;

                        doc.setFillColor(245, 247, 251);
                        doc.rect(130, 50, 60, 35, 'F');
                        doc.setTextColor(40, 40, 40);
                        doc.text('Finances', 135, 60);
                        doc.setFontSize(9);
                        doc.text(`Total Paid: Rs.${totalPaid.toLocaleString()}`, 135, 68);
                        doc.text(`Budget: Rs.${budget.toLocaleString()}`, 135, 75);
                        doc.setTextColor(balance < 0 ? 220 : 40, balance < 0 ? 53 : 40, balance < 0 ? 69 : 40);
                        doc.text(`Balance: Rs.${balance.toLocaleString()}`, 135, 82);

                        // Table
                        doc.setTextColor(40, 40, 40);
                        doc.setFontSize(14);
                        doc.text('Payment History', 20, 100);

                        let yPos = 110;
                        // Table Header
                        doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                        doc.rect(20, yPos, 170, 10, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(10);
                        doc.text('Date', 25, yPos + 7);
                        doc.text('Work Type', 55, yPos + 7);
                        doc.text('Mode', 110, yPos + 7);
                        doc.text('Amount', 150, yPos + 7);

                        yPos += 15;
                        doc.setTextColor(60, 60, 60);

                        payments.forEach((p, i) => {
                            if (yPos > 270) {
                                doc.addPage();
                                yPos = 20;
                            }
                            if (i % 2 === 0) {
                                doc.setFillColor(248, 249, 252);
                                doc.rect(20, yPos - 5, 170, 10, 'F');
                            }
                            doc.text(formatForPDF(new Date(p.date).toLocaleDateString()), 25, yPos);
                            doc.text(formatForPDF(p.workType || 'General'), 55, yPos);
                            doc.text(formatForPDF(p.mode || 'N/A'), 110, yPos);
                            doc.text(`Rs.${parseFloat(p.amount).toLocaleString()}`, 150, yPos);
                            yPos += 10;
                        });

                        // Footer
                        doc.setFontSize(8);
                        doc.setTextColor(150, 150, 150);
                        doc.text(`Generated by Interior Budget Pro for "${app.projectName}" on ${new Date().toLocaleDateString()}`, 105, 285, { align: 'center' });

                        doc.save(`Payment_Statement_${contractorName}_${new Date().toISOString().split('T')[0]}.pdf`);
                        showNotification('Contractor payment statement exported!', 'success');
                    } catch (err) {
                        console.error('PDF Export Error:', err);
                        showNotification('Failed to export PDF', 'error');
                    } finally {
                        loadingBtn.innerHTML = originalHTML;
                        loadingBtn.disabled = false;
                    }
                }, 500);
            }

            function exportPDF() {
                const loadingBtn = event?.target || document.querySelector('.btn-pdf');
                const originalHTML = loadingBtn.innerHTML;
                loadingBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';
                loadingBtn.classList.add('btn-loading');

                setTimeout(() => {
                    try {
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF('p', 'mm', 'a4');

                        // Add custom font support for UTF-8 characters
                        // We'll use a simpler approach - replace unsupported characters
                        const formatForPDF = (text) => {
                            if (!text) return '';
                            // Replace rupee symbol with "Rs."
                            return text.toString()
                                .replace(/₹/g, 'Rs.')
                                .replace(/[^\x00-\x7F]/g, ''); // Remove other non-ASCII characters
                        };

                        // Calculate current date for report
                        const today = new Date();
                        const dateStr = today.toLocaleDateString('en-IN', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric'
                        });

                        // Calculate summary data
                        const spent = app.expenses.reduce((a, b) => a + parseFloat(b.amount || 0), 0);
                        const compCost = app.components.reduce((a, b) => a + parseFloat(b.cost || 0), 0);
                        const totalOut = spent + compCost;
                        const remain = app.budget - totalOut;
                        const percent = app.budget > 0 ? ((totalOut / app.budget) * 100).toFixed(1) : 0;

                        // Title
                        doc.setFontSize(24);
                        doc.setTextColor(40, 40, 40);
                        doc.text('Interior Budget Pro - Project Report', 20, 25);

                        // Report metadata
                        doc.setFontSize(10);
                        doc.setTextColor(100, 100, 100);
                        doc.text(`Report generated on: ${dateStr}`, 20, 35);

                        // Project Information
                        doc.setFontSize(14);
                        doc.setTextColor(30, 30, 30);
                        doc.text('Project Information', 20, 50);

                        doc.setFontSize(10);
                        doc.text(`Project: ${formatForPDF(app.projectName)}`, 20, 60);
                        doc.text(`Manager: ${formatForPDF(app.userName)}`, 20, 67);
                        doc.text(`Address: ${formatForPDF(app.projectAddress)}`, 20, 74);
                        doc.text(`Timeline: ${formatForPDF(app.projectTimeline)}`, 20, 81);

                        // Budget Summary Box
                        doc.setFillColor(240, 240, 240);
                        doc.rect(20, 90, 170, 40, 'F');

                        doc.setFontSize(12);
                        doc.setTextColor(30, 30, 30);
                        doc.text('Budget Summary', 25, 100);

                        doc.setFontSize(10);
                        doc.setTextColor(60, 60, 60);
                        doc.text(`Total Budget: Rs.${app.budget.toLocaleString('en-IN')}`, 25, 110);
                        doc.text(`Total Spent: Rs.${totalOut.toLocaleString('en-IN')}`, 25, 117);
                        doc.text(`Remaining: Rs.${remain.toLocaleString('en-IN')}`, 25, 124);
                        doc.text(`Usage: ${percent}%`, 130, 117);

                        // Status indicators
                        if (percent > 100) {
                            doc.setTextColor(220, 53, 69);
                            doc.text('Status: OVER BUDGET', 130, 124);
                        } else if (percent > 80) {
                            doc.setTextColor(255, 193, 7);
                            doc.text('Status: AT RISK', 130, 124);
                        } else {
                            doc.setTextColor(40, 167, 69);
                            doc.text('Status: HEALTHY', 130, 124);
                        }

                        // Add a line separator
                        doc.setDrawColor(200, 200, 200);
                        doc.line(20, 140, 190, 140);

                        let yPos = 150;

                        // Add Expenses Summary if there are expenses
                        if (app.expenses.length > 0) {
                            doc.setFontSize(14);
                            doc.setTextColor(30, 30, 30);
                            doc.text('Recent Expenses', 20, yPos);
                            yPos += 10;

                            doc.setFontSize(9);
                            doc.setTextColor(80, 80, 80);

                            // Table header
                            doc.setFillColor(245, 245, 245);
                            doc.rect(20, yPos, 170, 8, 'F');
                            doc.setTextColor(60, 60, 60);
                            doc.text('Date', 22, yPos + 6);
                            doc.text('Contractor', 50, yPos + 6);
                            doc.text('Amount', 130, yPos + 6);
                            doc.text('Status', 160, yPos + 6);

                            yPos += 10;

                            // Expense rows (show top 10)
                            const recentExpenses = [...app.expenses]
                                .sort((a, b) => new Date(b.date) - new Date(a.date))
                                .slice(0, 10);

                            recentExpenses.forEach((exp, index) => {
                                if (yPos > 270) {
                                    doc.addPage();
                                    yPos = 20;
                                }

                                // Alternate row colors
                                if (index % 2 === 0) {
                                    doc.setFillColor(250, 250, 250);
                                    doc.rect(20, yPos, 170, 8, 'F');
                                }

                                doc.setTextColor(40, 40, 40);
                                doc.text(formatForPDF(new Date(exp.date).toLocaleDateString('en-IN')), 22, yPos + 6);
                                doc.text(formatForPDF(exp.contractor || 'N/A'), 50, yPos + 6);
                                doc.text(`Rs.${parseFloat(exp.amount).toLocaleString('en-IN')}`, 130, yPos + 6);

                                // Status color coding
                                if (exp.status === 'Completed') {
                                    doc.setTextColor(40, 167, 69);
                                } else if (exp.status === 'Pending') {
                                    doc.setTextColor(255, 193, 7);
                                } else {
                                    doc.setTextColor(108, 117, 125);
                                }
                                doc.text(formatForPDF(exp.status), 160, yPos + 6);

                                yPos += 8;
                            });

                            yPos += 10;
                        }

                        // Add Contractor Summary
                        if (app.contractors.length > 0) {
                            if (yPos > 250) {
                                doc.addPage();
                                yPos = 20;
                            }

                            doc.setFontSize(14);
                            doc.setTextColor(30, 30, 30);
                            doc.text('Contractors Summary', 20, yPos);
                            yPos += 10;

                            doc.setFontSize(9);

                            app.contractors.slice(0, 5).forEach((cont, index) => {
                                if (yPos > 270) {
                                    doc.addPage();
                                    yPos = 20;
                                }

                                const paid = app.expenses
                                    .filter(e => e.contractor === cont.name)
                                    .reduce((a, b) => a + parseFloat(b.amount || 0), 0);
                                const budgetUsed = cont.budget > 0 ? ((paid / cont.budget) * 100).toFixed(1) : 0;

                                doc.setTextColor(60, 60, 60);
                                doc.text(`${index + 1}. ${formatForPDF(cont.name)}`, 25, yPos + 6);
                                doc.text(formatForPDF(cont.role || 'Contractor'), 70, yPos + 6);
                                doc.text(`Rs.${paid.toLocaleString('en-IN')}`, 120, yPos + 6);
                                doc.text(`${budgetUsed}% used`, 160, yPos + 6);

                                yPos += 8;
                            });

                            yPos += 10;
                        }

                        // Add Components Summary
                        if (app.components.length > 0) {
                            if (yPos > 250) {
                                doc.addPage();
                                yPos = 20;
                            }

                            doc.setFontSize(14);
                            doc.setTextColor(30, 30, 30);
                            doc.text('Components Overview', 20, yPos);
                            yPos += 10;

                            doc.setFontSize(9);

                            app.components.slice(0, 5).forEach((comp, index) => {
                                if (yPos > 270) {
                                    doc.addPage();
                                    yPos = 20;
                                }

                                doc.setTextColor(60, 60, 60);
                                doc.text(`${index + 1}. ${formatForPDF(comp.name)}`, 25, yPos + 6);
                                doc.text(formatForPDF(comp.category), 80, yPos + 6);
                                doc.text(`Rs.${parseFloat(comp.cost).toLocaleString('en-IN')}`, 120, yPos + 6);
                                doc.text(`${comp.progress}%`, 160, yPos + 6);

                                // Progress bar visualization
                                const barWidth = 40;
                                const progressWidth = (comp.progress / 100) * barWidth;
                                doc.setFillColor(220, 220, 220);
                                doc.rect(170, yPos + 1, barWidth, 4, 'F');
                                if (comp.progress >= 100) {
                                    doc.setFillColor(40, 167, 69);
                                } else if (comp.progress >= 50) {
                                    doc.setFillColor(255, 193, 7);
                                } else {
                                    doc.setFillColor(220, 53, 69);
                                }
                                doc.rect(170, yPos + 1, progressWidth, 4, 'F');

                                yPos += 8;
                            });
                        }

                        // Add page numbers
                        const pageCount = doc.internal.getNumberOfPages();
                        for (let i = 1; i <= pageCount; i++) {
                            doc.setPage(i);
                            doc.setFontSize(8);
                            doc.setTextColor(150, 150, 150);
                            doc.text(`Page ${i} of ${pageCount}`, 180, 287, null, null, 'right');
                            doc.text(`Report generated by Interior Budget Pro`, 20, 287);
                        }

                        // Save PDF
                        doc.save(`Interior_Budget_Pro_Report_${dateStr.replace(/\//g, '-')}.pdf`);

                        loadingBtn.innerHTML = originalHTML;
                        loadingBtn.classList.remove('btn-loading');
                        showNotification('PDF report generated successfully!', 'success');
                    } catch (error) {
                        console.error('PDF generation error:', error);
                        loadingBtn.innerHTML = originalHTML;
                        loadingBtn.classList.remove('btn-loading');
                        showNotification('PDF generation failed! Please try again.', 'error');
                    }
                }, 1000);
            }

            // ========== APP RESET ==========
            function resetApp() {
                if (confirm('Are you sure you want to reset all data? This action cannot be undone.')) {
                    localStorage.removeItem('ibpultimate');
                    app = {
                        budget: 0,
                        projectName: 'Interior Budget Pro',
                        userName: 'Project Manager',
                        projectAddress: '',
                        projectTimeline: '6 months',
                        paymentSources: ['Self', 'Spouse', 'Parent', 'Bank Loan'],
                        expenses: [],
                        contractors: [],
                        components: [],
                        planning: {
                            electricity: [],
                            furniture: [],
                            pop: [],
                            painter: [],
                            custom: []
                        },
                        faults: [],
                        notes: [],
                        theme: 'purple',
                        currency: '₹',
                        dateFormat: 'en-IN'
                    };
                    renderAll();
                    switchTab('dashboard');
                    showNotification('App reset to factory settings.', 'info');
                }
            }

            // ========== DEMO DATA (Optional) ==========
            function loadDemoData() {
                if (!confirm('Load demo data? This will add sample expenses, contractors, and components.')) return;

                const demoContractors = [
                    { id: 1001, name: 'Rajesh Kumar', role: 'Electrician', phone: '+91 9876543210', email: 'rajesh@example.com', company: 'Kumar Electricals', budget: 150000, details: 'Specialized in modern electrical fittings' },
                    { id: 1002, name: 'Suresh Patel', role: 'Plumber', phone: '+91 8765432109', email: '', company: 'Patel Plumbing', budget: 80000, details: 'Expert in modern plumbing systems' },
                    { id: 1003, name: 'Anil Sharma', role: 'Carpenter', phone: '+91 7654321098', email: 'anil@example.com', company: 'Sharma Woodworks', budget: 200000, details: 'Custom furniture specialist' },
                    { id: 1004, name: 'Meena Desai', role: 'Painter', phone: '+91 6543210987', email: 'meena@example.com', company: 'ColorCraft Painters', budget: 120000, details: 'Interior and exterior painting' }
                ];

                const demoExpenses = [
                    { id: 2001, date: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], amount: 25000, contractor: 'Rajesh Kumar', workType: 'Electrical Wiring', category: 'Electrical', paidBy: 'Self', mode: 'UPI', status: 'Completed', notes: 'Advance payment' },
                    { id: 2002, date: new Date(Date.now() - 25 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], amount: 35000, contractor: 'Suresh Patel', workType: 'Bathroom Plumbing', category: 'Plumbing', paidBy: 'Spouse', mode: 'Bank Transfer', status: 'Completed', notes: '' },
                    { id: 2003, date: new Date(Date.now() - 20 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], amount: 45000, contractor: 'Anil Sharma', workType: 'Kitchen Cabinets', category: 'Carpentry', paidBy: 'Parent', mode: 'Cash', status: 'In Progress', notes: '50% advance paid' },
                    { id: 2004, date: new Date(Date.now() - 15 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], amount: 18000, contractor: 'Meena Desai', workType: 'Living Room Paint', category: 'Paint', paidBy: 'Self', mode: 'UPI', status: 'Pending', notes: 'Material purchase' },
                    { id: 2005, date: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], amount: 75000, contractor: 'Rajesh Kumar', workType: 'Lighting Installation', category: 'Electrical', paidBy: 'Bank Loan', mode: 'Cheque', status: 'Completed', notes: 'Final payment' }
                ];

                const demoComponents = [
                    { id: 3001, date: new Date(Date.now() - 28 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], name: 'Modular Kitchen Set', category: 'Furniture', contractor: 'Anil Sharma', workType: 'Kitchen Installation', cost: 120000, progress: 75, status: 'In Progress' },
                    { id: 3002, date: new Date(Date.now() - 22 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], name: 'LED Lighting System', category: 'Electrical', contractor: 'Rajesh Kumar', workType: 'Lighting', cost: 45000, progress: 100, status: 'Completed' },
                    { id: 3003, date: new Date(Date.now() - 18 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], name: 'Italian Marble Tiles', category: 'Tiles', contractor: '', workType: 'Flooring', cost: 85000, progress: 100, status: 'Completed' },
                    { id: 3004, date: new Date(Date.now() - 12 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], name: 'Smart Home System', category: 'Electrical', contractor: 'Rajesh Kumar', workType: 'Automation', cost: 35000, progress: 40, status: 'In Progress' },
                    { id: 3005, date: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], name: 'Sofa Set', category: 'Furniture', contractor: '', workType: 'Living Room', cost: 65000, progress: 0, status: 'Not Started' }
                ];

                const demoFaults = [
                    { id: 4001, date: new Date(Date.now() - 8 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], contractor: 'Suresh Patel', desc: 'Leakage in bathroom pipe', cost: 5000, status: 'Resolved' },
                    { id: 4002, date: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], contractor: 'Rajesh Kumar', desc: 'Switch board malfunction', cost: 2000, status: 'In Review' }
                ];

                app.contractors = demoContractors;
                app.expenses = demoExpenses;
                app.components = demoComponents;
                app.faults = demoFaults;
                app.budget = 800000;

                // Add some notes
                app.notes = [
                    { id: 5001, date: new Date().toISOString().split('T')[0], text: 'Meeting with interior designer tomorrow at 11 AM' },
                    { id: 5002, date: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], text: 'Final payment for carpenter due' }
                ];

                saveData();
                renderAll();
                showNotification('Demo data loaded successfully! Explore all features.', 'success');
            }

            // ========== TABLE CONTROLS & EXCEL EXPORT ==========

            // Global variables for table pagination
            let currentExpenseRowLimit = 25;
            let currentPaymentRowLimit = 25;

            // Update expense table display based on row limit
            function updateExpenseTableDisplay() {
                const selector = document.getElementById('expenseRowsPerPage');
                const limit = selector.value;
                currentExpenseRowLimit = limit === 'all' ? Infinity : parseInt(limit);

                // Re-render the expense table with new limit
                if (typeof renderAll === 'function') {
                    renderAll();
                }

                // Update info text
                updateExpenseTableInfo();
            }

            // Update expense table info text
            function updateExpenseTableInfo() {
                const tbody = document.getElementById('expenseTableBody');
                const totalRows = app.expenses ? app.expenses.length : 0;
                const visibleRows = Math.min(currentExpenseRowLimit, totalRows);
                const infoEl = document.getElementById('expenseTableInfo');

                if (infoEl) {
                    infoEl.textContent = `Showing ${visibleRows} of ${totalRows} entries`;
                }
            }

            // Export expenses to Excel
            function exportExpensesToExcel() {
                if (!app.expenses || app.expenses.length === 0) {
                    showNotification('No expense data to export', 'warning');
                    return;
                }

                try {
                    // Prepare data for export
                    const exportData = app.expenses.map(exp => ({
                        'Date': exp.date || '',
                        'Category': exp.category || '',
                        'Contractor': exp.contractor || '',
                        'Work Type': exp.workType || '',
                        'Amount': exp.amount || 0,
                        'Paid By': exp.paidBy || '',
                        'Payment Mode': exp.mode || '',
                        'Status': exp.status || '',
                        'Notes': exp.notes || ''
                    }));

                    // Create worksheet
                    const ws = XLSX.utils.json_to_sheet(exportData);

                    // Set column widths
                    ws['!cols'] = [
                        { wch: 12 }, // Date
                        { wch: 15 }, // Category
                        { wch: 20 }, // Contractor
                        { wch: 25 }, // Work Type
                        { wch: 12 }, // Amount
                        { wch: 15 }, // Paid By
                        { wch: 15 }, // Payment Mode
                        { wch: 12 }, // Status
                        { wch: 30 }  // Notes
                    ];

                    // Create workbook
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Expenses');

                    // Generate filename with current date
                    const dateStr = new Date().toISOString().split('T')[0];
                    const filename = `Expense_Tracker_${app.projectName || 'Project'}_${dateStr}.xlsx`;

                    // Save file
                    XLSX.writeFile(wb, filename);

                    showNotification('Excel file exported successfully!', 'success');
                } catch (error) {
                    console.error('Excel export error:', error);
                    showNotification('Failed to export Excel file. Make sure SheetJS library is loaded.', 'error');
                }
            }

            // Export payments/transactions to Excel
            function exportPaymentsToExcel() {
                if (!app.expenses || app.expenses.length === 0) {
                    showNotification('No transaction data to export', 'warning');
                    return;
                }

                try {
                    // Group expenses by contractor
                    const contractorData = {};
                    app.expenses.forEach(exp => {
                        const contractor = exp.contractor || 'Unknown';
                        if (!contractorData[contractor]) {
                            contractorData[contractor] = {
                                contractor: contractor,
                                totalPaid: 0,
                                transactions: []
                            };
                        }
                        contractorData[contractor].totalPaid += parseFloat(exp.amount) || 0;
                        contractorData[contractor].transactions.push(exp);
                    });

                    // Create summary sheet
                    const summaryData = Object.values(contractorData).map(data => ({
                        'Contractor': data.contractor,
                        'Total Paid': data.totalPaid,
                        'Transaction Count': data.transactions.length
                    }));

                    // Create detailed transactions sheet
                    const detailData = app.expenses.map(exp => ({
                        'Date': exp.date || '',
                        'Contractor': exp.contractor || '',
                        'Work Type': exp.workType || '',
                        'Category': exp.category || '',
                        'Amount': exp.amount || 0,
                        'Paid By': exp.paidBy || '',
                        'Payment Mode': exp.mode || '',
                        'Status': exp.status || ''
                    }));

                    // Create workbook with multiple sheets
                    const wb = XLSX.utils.book_new();

                    const wsSummary = XLSX.utils.json_to_sheet(summaryData);
                    const wsDetail = XLSX.utils.json_to_sheet(detailData);

                    XLSX.utils.book_append_sheet(wb, wsSummary, 'Summary');
                    XLSX.utils.book_append_sheet(wb, wsDetail, 'Transactions');

                    // Generate filename
                    const dateStr = new Date().toISOString().split('T')[0];
                    const filename = `Transaction_History_${app.projectName || 'Project'}_${dateStr}.xlsx`;

                    // Save file
                    XLSX.writeFile(wb, filename);

                    showNotification('Transaction history exported successfully!', 'success');
                } catch (error) {
                    console.error('Excel export error:', error);
                    showNotification('Failed to export Excel file. Make sure SheetJS library is loaded.', 'error');
                }
            }

            // ========== PASSWORD MANAGEMENT ==========

            // Toggle password visibility (admin only)
            function togglePasswordVisibility(inputId, buttonId) {
                const input = document.getElementById(inputId);
                const button = document.getElementById(buttonId);

                if (!input || !button) return;

                if (input.type === 'password') {
                    input.type = 'text';
                    button.querySelector('i').classList.remove('fa-eye');
                    button.querySelector('i').classList.add('fa-eye-slash');
                } else {
                    input.type = 'password';
                    button.querySelector('i').classList.remove('fa-eye-slash');
                    button.querySelector('i').classList.add('fa-eye');
                }
            }

            // Toggle password visibility in user table (admin only)
            function toggleUserPasswordInTable(inputId) {
                const input = document.getElementById(inputId);
                if (!input) return;

                const button = event.target.closest('button');
                const icon = button?.querySelector('i');

                if (input.type === 'password') {
                    input.type = 'text';
                    if (icon) {
                        icon.classList.remove('fa-eye');
                        icon.classList.add('fa-eye-slash');
                    }
                } else {
                    input.type = 'password';
                    if (icon) {
                        icon.classList.remove('fa-eye-slash');
                        icon.classList.add('fa-eye');
                    }
                }
            }

            // Change password for current user
            async function changePassword() {
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                // Validation
                if (!currentPassword || !newPassword || !confirmPassword) {
                    showNotification('Please fill in all password fields', 'warning');
                    return;
                }

                if (newPassword.length < 6) {
                    showNotification('New password must be at least 6 characters long', 'warning');
                    return;
                }

                if (newPassword !== confirmPassword) {
                    showNotification('New passwords do not match', 'error');
                    return;
                }

                if (!UserManager.currentUser) {
                    showNotification('No user logged in', 'error');
                    return;
                }

                try {
                    // Verify current password
                    const currentHash = await UserManager.hashPassword(currentPassword);
                    const { data: user, error: verifyError } = await SupabaseBackup.client
                        .from('users')
                        .select('password_hash')
                        .eq('id', UserManager.currentUser.id)
                        .single();

                    if (verifyError || !user || user.password_hash !== currentHash) {
                        showNotification('Current password is incorrect', 'error');
                        return;
                    }

                    // Update password
                    const newHash = await UserManager.hashPassword(newPassword);
                    const { error: updateError } = await SupabaseBackup.client
                        .from('users')
                        .update({ password_hash: newHash })
                        .eq('id', UserManager.currentUser.id);

                    if (updateError) {
                        showNotification('Failed to update password: ' + updateError.message, 'error');
                        return;
                    }

                    // Clear fields
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';

                    showNotification('Password updated successfully!', 'success');
                } catch (error) {
                    console.error('Password change error:', error);
                    showNotification('Failed to change password', 'error');
                }
            }

            // ========== THEME TOGGLE ==========

            // Update header clock with proper day/night icon
            function updateHeaderClock() {
                const now = new Date();
                const hours = now.getHours();
                const minutes = now.getMinutes();
                const seconds = now.getSeconds();

                // Format time as HH:MM:SS AM/PM
                const ampm = hours >= 12 ? 'PM' : 'AM';
                const displayHours = hours % 12 || 12;
                const timeString = `${String(displayHours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')} ${ampm}`;

                // Update clock display
                const clockEl = document.getElementById('headerClock');
                if (clockEl) clockEl.textContent = timeString;

                // Update icon based on time of day (6 AM - 6 PM = sun, otherwise moon)
                const iconEl = document.getElementById('headerClockIcon');
                if (iconEl) {
                    const isDayTime = hours >= 6 && hours < 18;
                    if (isDayTime) {
                        iconEl.innerHTML = '<i class="fas fa-sun" style="color:#f59e0b;"></i>';
                    } else {
                        iconEl.innerHTML = '<i class="fas fa-moon" style="color:#a78bfa;"></i>';
                    }
                }
            }

            // Start clock updates
            setInterval(updateHeaderClock, 1000);
            updateHeaderClock(); // Initial call

            // Toggle between dark and light mode
            function toggleTheme() {
                const body = document.body;
                const themeIcon = document.getElementById('themeIcon');
                const themeText = document.getElementById('themeText');
                const themeToggle = document.getElementById('themeToggle');

                // Toggle light mode class
                body.classList.toggle('light-mode');

                // Get current theme
                const isLightMode = body.classList.contains('light-mode');

                // Update button appearance
                if (isLightMode) {
                    // Light mode active - show sun icon
                    themeIcon.className = 'fas fa-sun';
                    themeText.textContent = 'Light';
                    themeToggle.className = 'btn btn-warning';
                } else {
                    // Dark mode active - show moon icon
                    themeIcon.className = 'fas fa-moon';
                    themeText.textContent = 'Dark';
                    themeToggle.className = 'btn btn-info';
                }

                // Save preference to localStorage
                localStorage.setItem('theme', isLightMode ? 'light' : 'dark');

                showNotification(`${isLightMode ? 'Light' : 'Dark'} mode activated`, 'info');
            }

            // Initialize theme based on saved preference or time of day
            function initializeTheme() {
                const savedTheme = localStorage.getItem('theme');
                const themeIcon = document.getElementById('themeIcon');
                const themeText = document.getElementById('themeText');
                const themeToggle = document.getElementById('themeToggle');

                // Get current hour to determine day/night
                const currentHour = new Date().getHours();
                const isDayTime = currentHour >= 6 && currentHour < 18; // 6 AM to 6 PM

                // Determine theme: use saved preference, or auto-detect based on time
                let useLightMode = savedTheme ? savedTheme === 'light' : isDayTime;

                if (useLightMode) {
                    document.body.classList.add('light-mode');
                    themeIcon.className = 'fas fa-sun';
                    themeText.textContent = 'Light';
                    themeToggle.className = 'btn btn-warning';
                } else {
                    themeIcon.className = 'fas fa-moon';
                    themeText.textContent = 'Dark';
                    themeToggle.className = 'btn btn-info';
                }
            }

            // Initialize the app
            setTimeout(() => {
                renderAll();
                // Auto-switch to dashboard after load
                switchTab('dashboard');

                // Check if this is first run (no data)
                if (app.expenses.length === 0 && app.contractors.length === 0) {
                    // Optional: Uncomment to auto-load demo data on first run
                    // setTimeout(loadDemoData, 1000);
                }

                // Initialize theme
                initializeTheme();
            }, 100);
        </script>
    </div> <!-- Close the appContent div -->




    <!-- User Modal -->
    <div id="userModal" class="modal">
        <div class="modal-box" style="max-width: 500px;">
            <h3 style="margin-bottom:24px; display:flex; align-items:center; gap:12px;">
                <i class="fas fa-user-edit" style="color:var(--primary);"></i>
                User Details
            </h3>
            <form onsubmit="UserManager.saveUser(event)">
                <input type="hidden" id="userId">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="userUsername" required>
                </div>
                <div class="form-group">
                    <label>Email (Optional)</label>
                    <input type="email" id="userEmail">
                </div>
                <div class="form-group">
                    <label>Password (Leave blank to keep current)</label>
                    <input type="password" id="userPassword" placeholder="New Password">
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select id="userRole" required>
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <hr style="border-color:rgba(255,255,255,0.1); margin:20px 0;">
                <div class="form-group">
                    <label>Project Name</label>
                    <input type="text" id="userProject" placeholder="User's Project Name">
                </div>
                <div class="form-group">
                    <label>Shared Unique Key (Optional)</label>
                    <input type="text" id="userSharedKey" placeholder="Link to existing project key">
                </div>
                <div style="display:flex; justify-content:flex-end; gap:12px; margin-top:24px;">
                    <button type="button" class="btn"
                        style="background:transparent; border:1px solid rgba(255,255,255,0.2);"
                        onclick="closeModal('userModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save User</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', function () {
            // Hide loading overlay
            setTimeout(() => {
                const loader = document.getElementById('loadingOverlay');
                if (loader) loader.style.display = 'none';
            }, 500);

            // Initialize minimal UI


            if (typeof initTableSorting === 'function') initTableSorting();

            // Initialize Supabase
            if (typeof SupabaseBackup !== 'undefined' && SupabaseBackup.init) SupabaseBackup.init();

            // Show Login Overlay logic
            // Improved Login Persistence Logic
            const appContent = document.getElementById('appContent');
            const loginOverlay = document.getElementById('loginOverlay');

            const isLoggedIn = localStorage.getItem('ibp_logged_in') === 'true';

            if (isLoggedIn) {
                if (appContent) appContent.style.display = 'block';
                if (loginOverlay) loginOverlay.style.display = 'none';

                // CRITICAL: Re-initialize user session
                if (typeof UserManager !== 'undefined' && UserManager.currentUser) {
                    UserManager.initSession();
                } else {
                    // Fallback: restore last user context from localStorage
                    const lastUser = localStorage.getItem("ibp_last_user");
                    if (lastUser) {
                        try {
                            const userData = JSON.parse(lastUser);
                            if (UserManager) {
                                UserManager.currentUser = userData;
                                UserManager.initSession();

                                // Explicitly update header displays
                                const displayNameEl = document.getElementById('displayActualName');
                                const displayProjectEl = document.getElementById('displayProjectName');
                                const passwordChangeUsernameEl = document.getElementById('passwordChangeUsername');

                                if (displayNameEl) displayNameEl.innerText = userData.username || '--';
                                if (displayProjectEl) displayProjectEl.innerText = userData.project?.project_name || 'My Interior Project';
                                if (passwordChangeUsernameEl) passwordChangeUsernameEl.innerText = userData.username || '--';
                            }
                        } catch (e) {
                            console.error("Failed to restore user context", e);
                        }
                    }
                }

                // Load project data via cloud sync (handles local fallback automatically)
                if (typeof SupabaseBackup !== 'undefined') {
                    SupabaseBackup.autoLoadFromCloud();
                }
            }
            else {
                // Not logged in
                if (appContent) appContent.style.display = 'none';
                if (loginOverlay) {
                    loginOverlay.style.display = 'flex';
                    loginOverlay.style.opacity = '1';
                }
            }

            // Add shake animation style
            if (!document.getElementById('shakeStyle')) {
                const style = document.createElement('style');
                style.id = 'shakeStyle';
                style.innerHTML = `
                @keyframes shake {
                    0%, 100% { transform: translateX(0); }
                    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
                    20%, 40%, 60%, 80% { transform: translateX(5px); }
                }
            `;
                document.head.appendChild(style);
            }

            // Initialize Clock
            // Check if interval already exists to avoid duplicates if re-run
            if (!window.clockInterval) {
                window.clockInterval = setInterval(updateHeaderClock, 1000);
            }
            updateHeaderClock();
        });

        // Logout Function (Global)
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('ibp_logged_in');

                // Reset App State (simplified for safety)
                if (typeof SupabaseBackup !== 'undefined') SupabaseBackup.PROJECT_ID = null;

                // Clear inputs
                const inputs = ['loginUsername', 'loginPassword'];
                inputs.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = '';
                });

                // UI Switch
                if (document.getElementById('appContent')) document.getElementById('appContent').style.display = 'none';
                if (document.getElementById('loginOverlay')) {
                    const ol = document.getElementById('loginOverlay');
                    ol.style.display = 'flex';
                    ol.style.opacity = '1';
                }

                if (typeof showNotification === 'function') showNotification('Logged out successfully', 'info');
            }
        }
        // ========== LOGIN HANDLER ==========
        document.getElementById('loginForm')?.addEventListener('submit', async function (e) {
            e.preventDefault();

            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const btn = this.querySelector('button[type="submit"]');
            const originalHtml = btn.innerHTML;

            if (!username || !password) {
                showNotification('Please enter username and password', 'error');
                return;
            }

            try {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
                btn.disabled = true;

                // Use UserManager login
                const success = await UserManager.login(username, password);

                if (success) {
                    localStorage.setItem('ibp_logged_in', 'true');

                    // Save user data to localStorage for session restoration
                    if (UserManager.currentUser) {
                        localStorage.setItem('ibp_last_user', JSON.stringify(UserManager.currentUser));
                    }

                    showNotification(`Welcome, ${username}!`, 'success');
                    this.reset();

                    // Re-initialize app
                    if (typeof renderAll === 'function') renderAll();
                    if (typeof switchTab === 'function') switchTab('dashboard');
                } else {
                    showNotification('Invalid username or password', 'error');

                    // Shake animation for login box
                    const loginBox = document.querySelector('#loginOverlay .glass-card'); // Changed to target the glass-card
                    if (loginBox) {
                        loginBox.style.animation = 'shake 0.5s';
                        setTimeout(() => loginBox.style.animation = '', 500);
                    }
                }
            } catch (err) {
                console.error('Login error:', err);
                showNotification('Login failed: ' + err.message, 'error');
            } finally {
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        });
        // Header Clock
        function updateHeaderClock() {
            const now = new Date();
            const iconEl = document.getElementById('headerClockIcon');
            const clockEl = document.getElementById('headerClock');

            if (iconEl && clockEl) {
                let hours = now.getHours();
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                const ampm = hours >= 12 ? 'PM' : 'AM';
                const isDay = hours >= 6 && hours < 18;

                iconEl.innerHTML = isDay ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
                iconEl.style.color = isDay ? '#f2d348' : '#cbd5e1';

                hours = hours % 12;
                hours = hours ? hours : 12;
                clockEl.textContent = `${String(hours).padStart(2, '0')}:${minutes}:${seconds} ${ampm}`;
            }
        }

        // Table Sorting
        function initTableSorting() {
            document.querySelectorAll('th[data-sortable="true"]').forEach(th => {
                th.addEventListener('click', () => {
                    const table = th.closest('table');
                    const tbody = table.querySelector('tbody');
                    const rows = Array.from(tbody.querySelectorAll('tr'));
                    const thIndex = Array.from(th.parentNode.children).indexOf(th);
                    const isAsc = th.classList.contains('asc');

                    table.querySelectorAll('th').forEach(h => h.classList.remove('asc', 'desc'));
                    th.classList.toggle('asc', !isAsc);
                    th.classList.toggle('desc', isAsc);

                    const multiplier = !isAsc ? 1 : -1;
                    rows.sort((a, b) => {
                        const aCell = a.children[thIndex];
                        const bCell = b.children[thIndex];
                        const aVal = aCell.getAttribute('data-sort') || aCell.innerText.trim();
                        const bVal = bCell.getAttribute('data-sort') || bCell.innerText.trim();

                        if (!isNaN(Date.parse(aVal)) && !isNaN(Date.parse(bVal)) && isNaN(aVal)) {
                            return (new Date(aVal) - new Date(bVal)) * multiplier;
                        }
                        const aNum = parseFloat(aVal.replace(/[^0-9.-]+/g, ''));
                        const bNum = parseFloat(bVal.replace(/[^0-9.-]+/g, ''));
                        if (!isNaN(aNum) && !isNaN(bNum)) return (aNum - bNum) * multiplier;
                        return aVal.localeCompare(bVal) * multiplier;
                    });
                    tbody.append(...rows);
                });
            });
        }
    </script>
</body>

</html>